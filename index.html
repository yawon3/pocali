<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>pocalist</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
        <!-- ìƒë‹¨ ê²€ìƒ‰ì°½ & ì¹´ìš´í„° -->
        <header id="search-header">
          <input type="text" id="search-input" placeholder="í¬í† ì¹´ë“œ ê²€ìƒ‰..." />
          <button id="search-detail-btn">+</button>
          <div id="count-display" style="text-align:center; font-weight:bold; margin-top: 5px;">
            0 / 0
          </div>
          <button id="view-toggle">ğŸ‘¥ ì¹œêµ¬ë³´ê¸°</button>  <!-- â† ìƒˆ ë²„íŠ¼ -->
        </header>
  <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->        
	<div id="photo-grid">  
    </div>
    <!-- ì¹´ë“œ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="photo-modal" class="modal" style="display: none;">
     <div class="modal-content">
      <span id="modal-close" class="close">&times;</span>
      <img id="modal-image" src="" alt="í™•ëŒ€ëœ í¬í† ì¹´ë“œ" draggable="false" />
      <div id="modal-info">
        <!-- íŒŒì¼ëª… íŒŒì‹± ë“±ìœ¼ë¡œ ì¶”í›„ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•  ì˜ˆì • -->
        </div>
      </div>
    </div>
    <!-- ìœ ì € ë°ì´í„° ëª¨ë‹¬ -->
   <div id="user-data-modal" class="modal" style="display: none;">
   <div class="modal-content">
    <span id="user-data-modal-close" class="close">&times;</span>
    <h3>UUID ë°ì´í„° ê´€ë¦¬</h3>

    <!-- ë‚´ UUID ì˜ì—­ -->
    <label for="my-uuid">ë‚´ UUID:</label>
    <input type="text" id="my-uuid" readonly style="width: 100%;" />

    <!-- ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ì…ë ¥ ì˜ì—­ -->
    <label for="other-uuid">ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ë¶ˆëŸ¬ì˜¤ê¸°:</label>
    <input type="text" id="other-uuid" placeholder="ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤ì˜ UUID ì…ë ¥" style="width: 100%;" />
    <button id="load-other-data">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>

    <!-- ë©”ì‹œì§€ ë˜ëŠ” ì—ëŸ¬ í‘œì‹œ -->
    <div id="uuid-msg" style="margin-top: 10px; color: red;"></div>
    </div>
   </div>

         <!-- ìƒì„¸ ê²€ìƒ‰ ëª¨ë‹¬ -->
        <div id="detail-search-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="detail-search-modal-close" class="close">&times;</span>
            <h3>ìƒì„¸ ê²€ìƒ‰ ì˜µì…˜</h3>
            <form id="detail-search-form">
                <fieldset>
                <legend>ê·¸ë£¹</legend>
                <label>
                    <input type="checkbox" name="group" value="IVE" />
                    ì•„ì´ë¸Œ
                </label>
                <label>
                    <input type="checkbox" name="group" value="IZONE" />
                    ì•„ì´ì¦ˆì›
                </label>
                </fieldset>
                <fieldset>
                <legend>ë©¤ë²„</legend>
                <label>
                    <input type="checkbox" name="member" value="ìœ ì§„" />
                    ìœ ì§„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ê°€ì„" />
                    ê°€ì„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë ˆì´" />
                    ë ˆì´
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì›ì˜" />
                    ì›ì˜
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë¦¬ì¦ˆ" />
                    ë¦¬ì¦ˆ
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì´ì„œ" />
                    ì´ì„œ
                </label>
                </fieldset>
                <fieldset>
                <legend>í…ìŠ¤íŠ¸ ê²€ìƒ‰</legend>
                <input type="text" id="filter-text" name="filter-text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
                </fieldset>
                <button type="submit">ê²€ìƒ‰</button>
            </form>
            </div>
        </div>
        <!-- ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥ ëª¨ë‹¬ -->
        <div id="export-modal" class="modal" style="display: none;">
          <div class="modal-content">
              <span id="export-modal-close" class="close">&times;</span>
              <h3>í¬í† ì¹´ë“œ ì‹œíŠ¸ ì¶œë ¥</h3>
              <form id="export-form">
                  <fieldset>
                      <legend>ê·¸ë£¹ ì„ íƒ</legend>
                      <label><input type="radio" name="group" value="IVE" checked> ì•„ì´ë¸Œ</label>
                      <label><input type="radio" name="group" value="IZONE"> ì•„ì´ì¦ˆì›</label>
                  </fieldset>
                  <fieldset>
                      <legend>ë©¤ë²„ ì„ íƒ</legend>
                      <label><input type="checkbox" name="member" value="ìœ ì§„"> ìœ ì§„</label>
                      <label><input type="checkbox" name="member" value="ê°€ì„"> ê°€ì„</label>
                      <label><input type="checkbox" name="member" value="ë ˆì´"> ë ˆì´</label>
                      <label><input type="checkbox" name="member" value="ì›ì˜"> ì›ì˜</label>
                      <label><input type="checkbox" name="member" value="ë¦¬ì¦ˆ"> ë¦¬ì¦ˆ</label>
                      <label><input type="checkbox" name="member" value="ì´ì„œ"> ì´ì„œ</label>
                  </fieldset>
                  <button type="submit">ì‹œíŠ¸ ìƒì„±</button>
              </form>
          </div>
        </div>
          <!-- ì¹œêµ¬ UUID ì…ë ¥ ëª¨ë‹¬ -->
         <div id="friend-modal" class="modal"><div class="modal-content">
          <span id="friend-modal-close" class="close">&times;</span>
          <h3>ì¹œêµ¬ UUID ì…ë ¥</h3>
          <input id="friend-uuid" placeholder="ì¹œêµ¬ UUID" style="width:100%">
          <button id="friend-add-confirm">ì¶”ê°€</button></div></div>

	<!-- í•˜ë‹¨ ìš°ì¸¡ FAB ë²„íŠ¼ -->
        <button
        id="categoryToggleBtn"
        class="floating-btn left"
        title="ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°"
      >ğŸ·ï¸</button>
        <button id="fab">+</button>
        <!-- FAB ëª¨ë‹¬: ìœ ì € ë°ì´í„°/ê´€ë¦¬ì ë©”ë‰´ -->
        <div id="user-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="user-modal-close" class="close">&times;</span>
            <h3>ìœ ì € ë°ì´í„° ë° ê´€ë¦¬ì ë©”ë‰´</h3>
            <ul>
                <li><button id="load-user-data">ìœ ì € ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button></li>
                <li><button id="reset-checks">ì²´í¬ ìƒíƒœ ì´ˆê¸°í™”</button></li>
                <li><button id="export-sheet">ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥</button></li>
                <li><button id="add-friend">ì¹œêµ¬ ì¶”ê°€</button></li>
            </ul>
            </div>
        </div>
       <!-- âœ… html2canvas ë“± ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
      <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

      <script>
       /* ==========================================================
   ğŸ“Œ p1ocalist ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ - ì™„ì „ ìˆ˜ì • ë²„ì „
   ========================================================== */

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   0. ì „ì—­ ìƒíƒœ ë° ë„ìš°ë¯¸
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// â”€â”€â”€ í˜ì´ì§•ìš© ì „ì—­ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BATCH_SIZE   = 100;      // í•œ ë²ˆì— ë¡œë“œí•  ì¹´ë“œ ê°œìˆ˜
let backupAllImages = [];       // allImages ì›ë³¸ ë°±ì—…ìš©
let allImages      = [];       // ì „ì²´ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì €ì¥
let currentBatch   = 0;        // ë Œë”ëœ ë°°ì¹˜ ì¸ë±ìŠ¤
let isRendering    = false;    // ì¤‘ë³µ ë Œë”ë§ ë°©ì§€ í”Œë˜ê·¸
let totalCount     = 0;        // â† ì „ì²´ ê°œìˆ˜ í—¤ë”ì—ì„œ ì½ì–´ ì €ì¥
let currentView       = 'id';      // 'id'  | 'category'
let viewOwner         = 'self';    // 'self'| 'friend'
let currentFriendUUID = localStorage.getItem('lastFriendUUID') || null;
let userData          = {};        // í˜„ì¬ ë³´ì—¬ì§€ëŠ” ë°ì´í„° (ë‚´ ê²ƒ ë˜ëŠ” ì¹œêµ¬ ê²ƒ)

const advancedFilters = { groups: [], members: [] };

/* ì§§ì€ ì…€ë ‰í„° ë„ìš°ë¯¸ */
function $(sel,  scope=document) { return scope.querySelector(sel); }
function $$(sel, scope=document) { return Array.from(scope.querySelectorAll(sel)); }

/* â”€â”€ ê³µí†µ: ì´ë¯¸ì§€ ìƒì„¸ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showModal(img) {
  const $modal      = $('#photo-modal');
  const $modalImg   = $('#modal-image');
  const $modalInfo  = $('#modal-info');

  $modalImg.src = img.src;

  $modalInfo.innerHTML = `
    <p>${img.dataset.group   || ''}</p>
    <p>${img.dataset.member  || ''}</p>
    <p>${img.dataset.category || ''} ${img.dataset.title || ''}</p>
    <p>${img.dataset.version || ''}</p>
    <p>#${img.dataset.unique}</p>
  `;

  $modal.style.display = 'block';
}

// ëª¨ë‹¬ ì „ì²´ì—ì„œ ìš°í´ë¦­ ë©”ë‰´ ì°¨ë‹¨
$('#photo-modal').addEventListener('contextmenu', e => e.preventDefault());
// ëª¨ë‹¬ ì•ˆ ì´ë¯¸ì§€ì—ì„œë„ ìš°í´ë¦­ ë©”ë‰´ ì°¨ë‹¨
$('#modal-image').addEventListener('contextmenu', e => e.preventDefault());

/* X ë²„íŠ¼ -or- ë°”ê¹¥ í´ë¦­ â†’ ëª¨ë‹¬ ë‹«ê¸° */
$('#modal-close').addEventListener('click', () => $('#photo-modal').style.display = 'none');
$('#photo-modal').addEventListener('click', e => {
  if (e.target === $('#photo-modal')) $('#photo-modal').style.display = 'none';
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1. ì´ˆê¸°í™” ë° ë©”ì¸ ê¸°ëŠ¥ë“¤
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {
  // â”€â”€ export-modal ë‹«ê¸° í•¸ë“¤ëŸ¬
  const $exportModal      = document.getElementById('export-modal');
  const $exportModalClose = document.getElementById('export-modal-close');
  
  $exportModalClose.addEventListener('click', () => {
    $exportModal.style.display = 'none';
  });
  $exportModal.addEventListener('click', e => {
   if (e.target === $exportModal) {
     $exportModal.style.display = 'none';
   }
 });
  
  const LONG_PRESS     = 500;
  const TAP_THRESHOLD  = 200;
  const MOVE_THRESHOLD = 10;

  const $grid          = $('#photo-grid');
  const $viewToggleBtn = $('#view-toggle');
  const $catToggleBtn  = $('#categoryToggleBtn');
  const $searchInput   = $('#search-input');

  // ë Œë”ë§ í›„ì— ê°’ì„ ì±„ìš¸ ë³€ìˆ˜ë“¤
  let originalCards = [];
  let photoCards    = [];

  // âœ… toggleCheck í•¨ìˆ˜: ì²´í¬ ìƒíƒœ ë³€ê²½
  function toggleCheck(img) {
    if (viewOwner !== 'self') return; // ì¹œêµ¬ ë±ì—ì„œëŠ” ìˆ˜ì • ë¶ˆê°€
    
    img.classList.toggle('checked');
    // ë‚´ ë°ì´í„°ë§Œ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥
    const myData = JSON.parse(localStorage.getItem('userData') || '{}');
    myData[img.dataset.unique] = img.classList.contains('checked');
    localStorage.setItem('userData', JSON.stringify(myData));
    
    // í˜„ì¬ ë³´ì—¬ì§€ëŠ” ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
    userData[img.dataset.unique] = img.classList.contains('checked');
    
    syncLocalDataToServer();
    updateCount();
  }

  async function fetchAndRenderImages() {
    const resp = await fetch('https://pocali-backend.onrender.com/api/images');
    allImages     = await resp.json();
    backupAllImages = allImages.slice();
    totalCount    = allImages.length;
    currentBatch = 0;
    $grid.innerHTML = '';
    renderNextBatch();
  }

  // âœ… ë± ì „í™˜ ê¸°ëŠ¥ ìˆ˜ì •
  /** ë‚´ ë³´ìœ  ì¹´ë“œ í‘œì‹œ */
  function loadSelfDeck() {
    const myData = JSON.parse(localStorage.getItem('userData') || '{}');
    userData = myData;
    
    photoCards.forEach(img => {
      img.classList.toggle('checked', !!myData[img.dataset.unique]);
      img.style.pointerEvents = ''; // ë”ë¸”í´ë¦­ í—ˆìš©
    });

    viewOwner = 'self';
    $viewToggleBtn.textContent = 'ğŸ‘¥ ì¹œêµ¬ë³´ê¸°';
    updateCount();
  }

  /** ì¹œêµ¬ ë³´ìœ  ì¹´ë“œ í‘œì‹œ */
  async function loadFriendDeck(uuid) {
    try {
      const res = await fetch(`https://pocali-backend.onrender.com/api/friend/${uuid}/collection`);
      if (!res.ok) {
        alert('ì¹œêµ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return false;
      }

      const friendData = (await res.json()).data || {};
      userData = friendData; // í˜„ì¬ ë³´ì—¬ì§€ëŠ” ë°ì´í„°ë¥¼ ì¹œêµ¬ ë°ì´í„°ë¡œ ì„¤ì •
      
      photoCards.forEach(img => {
        img.classList.toggle('checked', !!friendData[img.dataset.unique]);
        img.style.pointerEvents = 'none'; // ìˆ˜ì • ê¸ˆì§€
      });

      viewOwner = 'friend';
      currentFriendUUID = uuid;
      localStorage.setItem('lastFriendUUID', uuid);
      $viewToggleBtn.textContent = 'ğŸ‘¤ ë‚´ ì¹´ë“œë³´ê¸°';
      updateCount();
      return true;
    } catch (error) {
      console.error('ì¹œêµ¬ ë± ë¡œë“œ ì‹¤íŒ¨:', error);
      alert('ì¹œêµ¬ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return false;
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     2. ê³µí†µ ìœ í‹¸
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /** í˜„ì¬ í™”ë©´ì˜ ì´ ì¹´ë“œìˆ˜ / ë³´ìœ ì¹´ë“œìˆ˜ í‘œì‹œ */
  function updateCount() {
    // í˜„ì¬ ë³´ì—¬ì§€ëŠ” userDataë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
    const have = Object.values(userData).filter(v => v).length;
    document.getElementById('count-display').textContent = `${have} / ${totalCount}`;
  }

  /** ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ë¦¬ë“œì— ê·¸ëŒ€ë¡œ ë Œë”ë§ */
  function render(cards) {
    $grid.innerHTML = '';
    cards.forEach(c => $grid.appendChild(c));
    updateCount();
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     3. ë·° ê·¸ë¦¬ê¸°(ì •ë ¬) í•¨ìˆ˜
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /** ê³ ìœ ë²ˆí˜¸(ID) ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ë·° */
  function showById(list = null) {
    const cards = (list ?? originalCards).slice();
    cards.sort((a, b) =>
      $('.photo-card', b).dataset.unique -
      $('.photo-card', a).dataset.unique
    );
    render(cards);
  }

  /** ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹ + ì œëª© + ë²„ì „ í—¤ë” ë·° */
  function showByCategory() {
    const query = ($searchInput.value || '').toLowerCase();
    
    const filtered = originalCards.filter(div => {
      const img = $('.photo-card', div);
      const alt = img.alt.toLowerCase();
      const group = img.dataset.group.toLowerCase();
      const member = img.dataset.member.toLowerCase();

      const textOK = !query || alt.includes(query);
      const groupOK = !advancedFilters.groups.length ||
                     advancedFilters.groups.includes(group.toUpperCase());
      const memberOK = !advancedFilters.members.length ||
                      advancedFilters.members.some(v => member.includes(v.toLowerCase()));

      return textOK && groupOK && memberOK;
    });

    const buckets = {};
    filtered.forEach(div => {
      const img = $('.photo-card', div);
      const key = [
        img.dataset.category || 'ë¯¸ë¶„ë¥˜',
        img.dataset.title || '',
        img.dataset.version || ''
      ].filter(Boolean).join(' | ');
      (buckets[key] = buckets[key] || []).push(div);
    });

    $grid.innerHTML = '';
    Object.entries(buckets)
      .sort(([,a],[,b]) =>
        +$('.photo-card', b[0]).dataset.unique -
        +$('.photo-card', a[0]).dataset.unique
      )
      .forEach(([header, cards]) => {
        const h2 = document.createElement('h2');
        h2.textContent = header;
        h2.style.margin = '16px 0 8px';
        $grid.appendChild(h2);

        cards.sort((a, b) =>
          +$('.photo-card', b).dataset.unique -
          +$('.photo-card', a).dataset.unique
        ).forEach(div => $grid.appendChild(div));
      });

    updateCount();
  }

  /** í˜„ì¬ í•„í„°/ë·° ìƒíƒœë¡œ ë‹¤ì‹œ ê·¸ë¦¬ê¸° */
  function applyFilters() {
    if (currentView === 'category') {
      showByCategory();
    } else {
      showById();
    }
  }

  // â”€â”€â”€ í˜ì´ì§•ë³„ ë Œë”ë§ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderNextBatch() {
    if (isRendering) return;
    
    const start = currentBatch * BATCH_SIZE;
    const end = start + BATCH_SIZE;
    const slice = allImages.slice(start, end);
    
    // ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
    if (slice.length === 0) {
      isRendering = false;
      return;
    }
    
    isRendering = true;

    slice.forEach(image => {
      // 1) ì¹´ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
      const container = document.createElement('div');
      container.className = 'photo-card-container';

      // 2) <img> ìš”ì†Œ ìƒì„±
      const img = document.createElement('img');
      img.className = 'photo-card';
      img.src = image.url.startsWith('http')
                ? image.url
                : `https://pocali-backend.onrender.com${image.url}`;
      img.loading = 'lazy';
      img.alt = `${image.group} ${image.member} ${image.category} ${image.title} #${image.unique_id}`;
      img.dataset.group = image.group;
      img.dataset.member = image.member;
      img.dataset.category = image.category;
      img.dataset.title = image.title;
      img.dataset.version = image.version;
      img.dataset.unique = image.unique_id;

      // â”€â”€ í˜„ì¬ userDataì— ë”°ë¥¸ ì²´í¬ ì •ë³´ ì ìš©
      if (userData[image.unique_id]) {
        img.classList.add('checked');
      }

      // í¬ì¸í„° ì´ë²¤íŠ¸ ì„¤ì •
      img.style.pointerEvents = viewOwner === 'self' ? '' : 'none';

      // 3) ì˜¤ë²„ë ˆì´: image.type ë˜ëŠ” ë°±ì—”ë“œ file_type í™œìš©
      const overlay = document.createElement('div');
      overlay.className = 'image-overlay';
      overlay.textContent = image.type || image.file_type || '';
      container.appendChild(overlay);

      // 4) í„°ì¹˜Â·ë¡±í”„ë ˆìŠ¤ & ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      let startTime, pressTimer;
      img.addEventListener('pointerdown', e => {
        if (viewOwner !== 'self') return;
        startTime = performance.now();
        pressTimer = setTimeout(() => showModal(img), LONG_PRESS);
      });
      img.addEventListener('pointerup', e => {
        clearTimeout(pressTimer);
        if (performance.now() - startTime < TAP_THRESHOLD) {
          toggleCheck(img);
        }
      });
      img.addEventListener('pointerleave', () => clearTimeout(pressTimer));
      img.addEventListener('dblclick', () => {
        if (viewOwner !== 'self') return;
        toggleCheck(img);
      });
      img.addEventListener('contextmenu', e => {
        e.preventDefault();
        showModal(img);
      });

      // 5) ê·¸ë¦¬ë“œì— ì¶”ê°€
      container.appendChild(img);
      $grid.appendChild(container);
    });
    
    // â€” ìºì‹œ ê°±ì‹ 
    originalCards = Array.from($grid.querySelectorAll('.photo-card-container'));
    photoCards = Array.from($grid.querySelectorAll('.photo-card'));

    // â€” ìƒíƒœ ê°±ì‹ 
    currentBatch++;
    updateCount();

    isRendering = false; 
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     4. ì„œë²„ ë™ê¸°í™” í•¨ìˆ˜ë“¤
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  // UUID í™•ë³´/ìƒì„±
  async function ensureMyUUID() {
    let me = localStorage.getItem('myUUID');
    if (me) return me;
    const r = await fetch('https://pocali-backend.onrender.com/api/register', {
      method: 'POST'
    });
    me = (await r.json()).user_id;
    localStorage.setItem('myUUID', me);
    return me;
  }

  // ë¡œì»¬ ë°ì´í„°ë¥¼ ì„œë²„ì— ë™ê¸°í™”
  async function syncLocalDataToServer() {
    const me = localStorage.getItem('myUUID');
    if (!me || viewOwner !== 'self') return;
    const data = JSON.parse(localStorage.getItem('userData') || '{}');
    await fetch(`https://pocali-backend.onrender.com/api/user/${me}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data })
    });
  }

  // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (10ì´ˆë§ˆë‹¤ í´ë§)
  async function pollServerData() {
    if (viewOwner !== 'self') return;
    
    const me = localStorage.getItem('myUUID');
    if (!me) return;
    
    const r = await fetch(`https://pocali-backend.onrender.com/api/user/${me}`);
    if (!r.ok) return;
    
    const serverData = JSON.parse((await r.json()).data || '{}');
    userData = serverData;
    localStorage.setItem('userData', JSON.stringify(serverData));
    
    photoCards.forEach(img =>
      img.classList.toggle('checked', !!serverData[img.dataset.unique]));
    updateCount();
  }
  setInterval(pollServerData, 10_000);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     5. UI ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  // âœ… ë·° í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ (ì¤‘ë³µ ì œê±°) - ë‹¨ í•œ ë²ˆë§Œ ë“±ë¡
  $viewToggleBtn.addEventListener('click', async () => {
    if (viewOwner === 'friend') {
      loadSelfDeck();
    } else {
      if (currentFriendUUID) {
        await loadFriendDeck(currentFriendUUID);
      } else {
        alert('ë¨¼ì € ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!');
      }
    }
  });

  // ì¹´í…Œê³ ë¦¬/ID ì „í™˜ ë²„íŠ¼
  $catToggleBtn.addEventListener('click', () => {
    currentView = currentView === 'id' ? 'category' : 'id';
    $catToggleBtn.textContent = currentView === 'id' ? 'ğŸ·ï¸' : 'ğŸ”¢';
    $catToggleBtn.title = currentView === 'id'
                        ? 'ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°'
                        : 'ê³ ìœ ë²ˆí˜¸ ìˆœ ë³´ê¸°';
    applyFilters();
  });

  // âœ… ê²€ìƒ‰ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  $searchInput.addEventListener('input', e => {
    const q = e.target.value.trim().toLowerCase();
    if (!q) {
      allImages = backupAllImages.slice();
    } else {
      allImages = backupAllImages.filter(meta =>
        (`${meta.group} ${meta.member} ${meta.category} ${meta.title}`)
          .toLowerCase().includes(q)
      );
    }
    // í˜ì´ì§• ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ë Œë”
    currentBatch = 0;
    isRendering = false;
    $grid.innerHTML = '';
    renderNextBatch();
    // ì²« ë°°ì¹˜ ë Œë”ë§ í›„ í˜„ì¬ ë·° ì ìš©
    setTimeout(() => applyFilters(), 100);
  });

  // â”€â”€â”€ ë¬´í•œ ìŠ¤í¬ë¡¤ íŠ¸ë¦¬ê±° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('scroll', () => {
    // ì´ë¯¸ ë Œë”ë§ ì¤‘ì´ê±°ë‚˜ ë” ì´ìƒ ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
    if (isRendering || currentBatch * BATCH_SIZE >= allImages.length) {
      return;
    }
    
    const nearBottom = window.innerHeight + window.scrollY
                     >= document.body.offsetHeight - 500;
    
    if (nearBottom) {
      console.log(`ë¬´í•œ ìŠ¤í¬ë¡¤ íŠ¸ë¦¬ê±°: ë°°ì¹˜ ${currentBatch}, ì „ì²´ ì´ë¯¸ì§€ ${allImages.length}`);
      renderNextBatch();
      // ë°°ì¹˜ ë Œë”ë§ í›„ í˜„ì¬ ë·° ì ìš©
      setTimeout(() => applyFilters(), 100);
    }
  });

  // FAB ë° ëª¨ë‹¬ë“¤
  const $fab = $('#fab');
  const $userModal = $('#user-modal');
  const $userModalClose = $('#user-modal-close');
  const $addFriendBtn = $('#add-friend');
  const $friendModal = $('#friend-modal');
  const $friendClose = $('#friend-modal-close');
  const $friendConfirm = $('#friend-add-confirm');
  const $resetBtn = $('#reset-checks');
  const $exportBtn = $('#export-sheet');
  const $userDataModal = $('#user-data-modal');
  const $userDataModalClose = $('#user-data-modal-close');

  $userDataModalClose.addEventListener('click', () => $userDataModal.style.display = 'none');
  $userDataModal.addEventListener('click', e => {
    if (e.target === $userDataModal) $userDataModal.style.display = 'none';
  });

  // ìƒì„¸ ê²€ìƒ‰ ëª¨ë‹¬
  const detailBtn = document.getElementById('search-detail-btn');
  const detailModal = document.getElementById('detail-search-modal');
  const detailForm = document.getElementById('detail-search-form');

  detailBtn.addEventListener('click', () => detailModal.style.display = 'block');
  detailModal.querySelector('.close').addEventListener('click', () => detailModal.style.display = 'none');
  detailModal.addEventListener('click', e => { 
    if (e.target === detailModal) detailModal.style.display = 'none'; 
  });

  detailForm.addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData(detailForm);
    const groups = fd.getAll('group');
    const members = fd.getAll('member');
    
    if (!groups.length && !members.length) {
      allImages = backupAllImages.slice();
    } else {
      allImages = backupAllImages.filter(meta =>
        (groups.length === 0 || groups.includes(meta.group)) &&
        (members.length === 0 || members.includes(meta.member))
      );
    }
    
    currentBatch = 0;
    isRendering = false;
    $grid.innerHTML = '';
    renderNextBatch();
    setTimeout(() => applyFilters(), 100);
    detailModal.style.display = 'none';
  });

  // Export form
  const $exportForm = document.getElementById('export-form');
  $exportForm.addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData($exportForm);
    const group = fd.get('group');
    const members = fd.getAll('member');

    const sel = backupAllImages.filter(meta =>
      meta.group === group &&
      (members.length === 0 || members.includes(meta.member))
    );
    
    if (!sel.length) {
      return alert('ì„ íƒí•˜ì‹  ì¡°ê±´ì— ë§ëŠ” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    const nodes = sel.map(meta => {
      const img = document.createElement('img');
      img.className = 'photo-card';
      img.crossOrigin = 'anonymous';
      img.src = meta.url;
      img.alt = `${meta.group} ${meta.member} ${meta.category} ${meta.title}`;
      img.dataset.unique = meta.unique_id;
      img.dataset.group = meta.group;
      img.dataset.member = meta.member;
      img.dataset.category = meta.category;
      img.dataset.title = meta.title;
      img.dataset.version = meta.version;
      
      // í˜„ì¬ ë³´ì—¬ì§€ëŠ” ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ì²´í¬ ìƒíƒœ ì„¤ì •
      if (userData[meta.unique_id]) img.classList.add('checked');
      return img;
    });
    
    $exportModal.style.display = 'none';
    generateImageSheet(nodes);
  });

  // ë‹¤ë¥¸ UUID ë¶ˆëŸ¬ì˜¤ê¸°
  $('#load-other-data')?.addEventListener('click', async () => {
    const other = $('#other-uuid').value.trim();
    if (!other) return alert('UUIDë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
    const r = await fetch(`https://pocali-backend.onrender.com/api/user/${other}`);
    if (!r.ok) return alert('í•´ë‹¹ UUIDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    const json = await r.json();
    localStorage.setItem('userData', json.data);
    localStorage.setItem('myUUID', other);
    location.reload();
  });

  // ìœ ì € ë°ì´í„° ëª¨ë‹¬
  const $loadUserBtn = $('#load-user-data');
  $loadUserBtn?.addEventListener('click', async () => {
    $userModal.style.display = 'none';
    const me = await ensureMyUUID();
    $('#my-uuid').value = me;
    $('#other-uuid').value = '';
    $('#uuid-msg').textContent = '';
    $('#user-data-modal').style.display = 'block';
  });

  // FAB ëª¨ë‹¬
  $fab.addEventListener('click', () => $userModal.style.display = 'block');
  $userModalClose.addEventListener('click', () => $userModal.style.display = 'none');
  $userModal.addEventListener('click', e => {
    if (e.target === $userModal) $userModal.style.display = 'none';
  });

  // ì¹œêµ¬ ì¶”ê°€
  $addFriendBtn.addEventListener('click', () => {
    $userModal.style.display = 'none';
    $friendModal.style.display = 'block';
  });
  $friendClose.addEventListener('click', () => $friendModal.style.display = 'none');
  $friendModal.addEventListener('click', e => { 
    if (e.target === $friendModal) $friendModal.style.display = 'none'; 
  });

  $friendConfirm.addEventListener('click', async () => {
    const me = localStorage.getItem('myUUID');
    const friend = $('#friend-uuid').value.trim();
    if (!me || !friend) { 
      alert('UUIDë¥¼ ì…ë ¥í•˜ì„¸ìš”!'); 
      return; 
    }

    const ok = await fetch('https://pocali-backend.onrender.com/api/friends', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ me, friend })
    }).then(r => r.ok);

    if (!ok) return alert('ë“±ë¡ ì‹¤íŒ¨');

    localStorage.setItem('lastFriendUUID', friend);
    $friendModal.style.display = 'none';
    await loadFriendDeck(friend);
    alert('ì¹œêµ¬ ë“±ë¡ ì™„ë£Œ!');
  });

  // ì²´í¬ ìƒíƒœ ì´ˆê¸°í™”
  $resetBtn.addEventListener('click', async () => {
    if (!confirm('ëª¨ë“  ì²´í¬ë¥¼ í•´ì œí• ê¹Œìš”?')) return;

    // 1) í™”ë©´-ë¡œì»¬ ì´ˆê¸°í™”
    $$('.photo-card').forEach(img => img.classList.remove('checked'));
    userData = {}; // í˜„ì¬ userDataë„ ì´ˆê¸°í™”
    localStorage.setItem('userData', JSON.stringify({}));
    updateCount();

    // 2) ì„œë²„ì—ë„ ë¹ˆ ë°ì´í„° ì—…ë¡œë“œ
    const me = localStorage.getItem('myUUID');
    if (me) {
      await fetch(`https://pocali-backend.onrender.com/api/user/${me}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: {} })
      });
    }
  });

  // ì‹œíŠ¸ ëª¨ë‹¬ ì—´ê¸°
  $exportBtn.addEventListener('click', () => {
    $('#user-modal').style.display = 'none';
    $('#export-modal').style.display = 'block';
  });

  // ì‹œíŠ¸ ìƒì„± í•¨ìˆ˜
  function generateImageSheet(nodes) {
    // â‘  ì˜¤ë²„ë ˆì´ ìƒì„±
    const overlay = document.createElement('div');
    overlay.id = 'sheet-overlay';
    overlay.style.cssText = `
      position:fixed; inset:0; background:#fff; overflow:auto;
      z-index:10000; padding:20px; overscroll-behavior:contain;
    `;
    document.body.appendChild(overlay);

    // â‘¡ ì‹œíŠ¸ ì „ìš© ê·¸ë¦¬ë“œ
    const sheetGrid = document.createElement('div');
    sheetGrid.id = 'sheet-grid';
    sheetGrid.style.cssText = `
      display: grid;
      grid-template-columns: repeat(20, 100px);
      grid-auto-rows: auto;
      gap: 12px;
      padding: 20px;
      width: fit-content;
    `;
    overlay.appendChild(sheetGrid);

    // â‘¢ ë‹«ê¸°/ì €ì¥ ë²„íŠ¼
    const btnBar = document.createElement('div');
    btnBar.style.cssText = 'position:fixed;top:10px;right:10px;display:flex;gap:8px;z-index:10001;';
    
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'ë‹«ê¸°';
    closeBtn.onclick = () => overlay.remove();
    
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'ì €ì¥';
    saveBtn.onclick = async () => {
      try {
        // ìƒíƒœ í‘œì‹œ
        const status = document.createElement('div');
        status.textContent = "ì´ë¯¸ì§€ ìƒì„± ì¤‘...";
        status.style.cssText = 'position:fixed; bottom:20px; left:20px; background:rgba(0,0,0,0.7); color:white; padding:10px; border-radius:5px; z-index:10002;';
        overlay.appendChild(status);
        
        // ëª¨ë“  ì´ë¯¸ì§€ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
        const images = Array.from(sheetGrid.querySelectorAll('img'));
        await Promise.all(images.map(img => {
          // ì´ë¯¸ ë¡œë“œëœ ì´ë¯¸ì§€ëŠ” ì¦‰ì‹œ í•´ê²°
          if (img.complete) return Promise.resolve();
          // ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ì´ë¯¸ì§€ëŠ” ë¡œë“œ ì´ë²¤íŠ¸ ê¸°ë‹¤ë¦¼
          return new Promise(resolve => {
            img.onload = resolve;
            img.onerror = resolve; // ì—ëŸ¬ê°€ ë‚˜ë„ ì§„í–‰
          });
        }));
        
        console.log('ëª¨ë“  ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ, html2canvas ì‹œì‘');
        status.textContent = "ìº”ë²„ìŠ¤ ìƒì„± ì¤‘...";
        
        const canvas = await html2canvas(sheetGrid, {
          scale: 2,
          backgroundColor: '#fff',
          useCORS: true,
          allowTaint: true,
          logging: true, // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
          onclone: (clonedDoc) => {
            // ë³µì œëœ DOMì˜ ëª¨ë“  ì´ë¯¸ì§€ì— crossOrigin ì„¤ì •
            const clonedImages = clonedDoc.querySelectorAll('img');
            clonedImages.forEach(img => {
              img.crossOrigin = 'anonymous';
              // ë¶ˆíˆ¬ëª…ë„ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
            });
          }
        });
        
        console.log('ìº”ë²„ìŠ¤ í¬ê¸°:', canvas.width, 'Ã—', canvas.height);
        status.textContent = "ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘...";
        
        // canvasë¥¼ ë°ì´í„° URLë¡œ ë³€í™˜í•˜ì—¬ ë‹¤ìš´ë¡œë“œ
        const dataURL = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = `pocalist_sheet_${Date.now()}.png`;
        a.click();
        
        overlay.removeChild(status);
      } catch (e) {
        console.error('ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
        alert('ìº¡ì²˜ ì‹¤íŒ¨: ' + e.message);
      }
    };
    
    btnBar.append(closeBtn, saveBtn);
    overlay.appendChild(btnBar);

    // â‘£ ë…¸ë“œ ë³µì œí•´ì„œ ì‹œíŠ¸ì— ì¶”ê°€ (ì´ë¯¸ì§€ ë¡œë”© ì²˜ë¦¬ ê°œì„ )
    nodes.forEach(n => {
      const container = document.createElement('div');
      container.style.cssText = 'position:relative; width:100px; height:140px; display:flex; justify-content:center; align-items:center;';
      
      const img = new Image();
      img.crossOrigin = 'anonymous'; // CORS ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ í•„ìˆ˜
      img.className = 'photo-card';
      img.style.cssText = 'max-width:100%; max-height:140px; object-fit:contain;';
      
      // ì²´í¬ ìƒíƒœì— ë”°ë¼ ë¶ˆíˆ¬ëª…ë„ ì„¤ì •
      if (n.classList.contains('checked')) {
        img.style.opacity = '1'; // ë³´ìœ  ì¹´ë“œëŠ” 100% ë¶ˆíˆ¬ëª…ë„
      } else {
        img.style.opacity = '0.4'; // ë¯¸ë³´ìœ  ì¹´ë“œëŠ” 40% ë¶ˆíˆ¬ëª…ë„
      }
      
      // ì›ë³¸ ì†ŒìŠ¤ì™€ ë°ì´í„°ì…‹ ë³µì‚¬
      img.src = n.src;
      img.alt = n.alt;
      
      // ë¡œë”© í‘œì‹œê¸°
      const loader = document.createElement('div');
      loader.textContent = 'ë¡œë”©ì¤‘...';
      loader.style.cssText = 'position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:center; align-items:center; background:rgba(255,255,255,0.8);';
      container.appendChild(loader);
      
      // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ë¡œë”© í‘œì‹œê¸° ì œê±°
      img.onload = () => {
        if (loader.parentNode === container) {
          container.removeChild(loader);
        }
      };
      
      container.appendChild(img);
      sheetGrid.appendChild(container);
    });
  }

  // ì´ˆê¸° ë¡œë“œ
  fetchAndRenderImages()
    .then(() => {
      // ì´ˆê¸°í™”ê°€ ì™„ë£Œëœ í›„ ë‚´ ë± ë¡œë“œ
      setTimeout(() => {
        loadSelfDeck();
      }, 100);
    })
    .catch(console.error);

});



      </script>
               
      </body>
      </html>