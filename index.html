<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>pocalist</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
        <!-- ìƒë‹¨ ê²€ìƒ‰ì°½ & ì¹´ìš´í„° -->
        <header id="search-header">
          <input type="text" id="search-input" placeholder="í¬í† ì¹´ë“œ ê²€ìƒ‰..." />
          <button id="search-detail-btn">+</button>
          <div id="count-display" style="text-align:center; font-weight:bold; margin-top: 5px;">
            0 / 0
          </div>
          <button id="view-toggle">ğŸ‘¥ ì¹œêµ¬ë³´ê¸°</button>  <!-- â† ìƒˆ ë²„íŠ¼ -->
        </header>
  <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->        
	<div id="photo-grid">  
    </div>
    <!-- ì¹´ë“œ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="photo-modal" class="modal" style="display: none;">
     <div class="modal-content">
      <span id="modal-close" class="close">&times;</span>
      <img id="modal-image" src="" alt="í™•ëŒ€ëœ í¬í† ì¹´ë“œ" draggable="false" />
      <div id="modal-info">
        <!-- íŒŒì¼ëª… íŒŒì‹± ë“±ìœ¼ë¡œ ì¶”í›„ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•  ì˜ˆì • -->
        </div>
      </div>
    </div>
    <!-- ìœ ì € ë°ì´í„° ëª¨ë‹¬ -->
   <div id="user-data-modal" class="modal" style="display: none;">
   <div class="modal-content">
    <span id="user-data-modal-close" class="close">&times;</span>
    <h3>UUID ë°ì´í„° ê´€ë¦¬</h3>

    <!-- ë‚´ UUID ì˜ì—­ -->
    <label for="my-uuid">ë‚´ UUID:</label>
    <input type="text" id="my-uuid" readonly style="width: 100%;" />

    <!-- ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ì…ë ¥ ì˜ì—­ -->
    <label for="other-uuid">ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ë¶ˆëŸ¬ì˜¤ê¸°:</label>
    <input type="text" id="other-uuid" placeholder="ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤ì˜ UUID ì…ë ¥" style="width: 100%;" />
    <button id="load-other-data">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>

    <!-- ë©”ì‹œì§€ ë˜ëŠ” ì—ëŸ¬ í‘œì‹œ -->
    <div id="uuid-msg" style="margin-top: 10px; color: red;"></div>
    </div>
   </div>

         <!-- ìƒì„¸ ê²€ìƒ‰ ëª¨ë‹¬ -->
        <div id="detail-search-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="detail-search-modal-close" class="close">&times;</span>
            <h3>ìƒì„¸ ê²€ìƒ‰ ì˜µì…˜</h3>
            <form id="detail-search-form">
                <fieldset>
                <legend>ê·¸ë£¹</legend>
                <label>
                    <input type="checkbox" name="group" value="IVE" />
                    ì•„ì´ë¸Œ
                </label>
                <label>
                    <input type="checkbox" name="group" value="IZONE" />
                    ì•„ì´ì¦ˆì›
                </label>
                </fieldset>
                <fieldset>
                <legend>ë©¤ë²„</legend>
                <label>
                    <input type="checkbox" name="member" value="ìœ ì§„" />
                    ìœ ì§„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ê°€ì„" />
                    ê°€ì„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë ˆì´" />
                    ë ˆì´
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì›ì˜" />
                    ì›ì˜
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë¦¬ì¦ˆ" />
                    ë¦¬ì¦ˆ
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì´ì„œ" />
                    ì´ì„œ
                </label>
                </fieldset>
                <fieldset>
                <legend>í…ìŠ¤íŠ¸ ê²€ìƒ‰</legend>
                <input type="text" id="filter-text" name="filter-text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
                </fieldset>
                <button type="submit">ê²€ìƒ‰</button>
            </form>
            </div>
        </div>
        <!-- ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥ ëª¨ë‹¬ -->
        <div id="export-modal" class="modal" style="display: none;">
          <div class="modal-content">
              <span id="export-modal-close" class="close">&times;</span>
              <h3>í¬í† ì¹´ë“œ ì‹œíŠ¸ ì¶œë ¥</h3>
              <form id="export-form">
                  <fieldset>
                      <legend>ê·¸ë£¹ ì„ íƒ</legend>
                      <label><input type="radio" name="group" value="IVE" checked> ì•„ì´ë¸Œ</label>
                      <label><input type="radio" name="group" value="IZONE"> ì•„ì´ì¦ˆì›</label>
                  </fieldset>
                  <fieldset>
                      <legend>ë©¤ë²„ ì„ íƒ</legend>
                      <label><input type="checkbox" name="member" value="ìœ ì§„"> ìœ ì§„</label>
                      <label><input type="checkbox" name="member" value="ê°€ì„"> ê°€ì„</label>
                      <label><input type="checkbox" name="member" value="ë ˆì´"> ë ˆì´</label>
                      <label><input type="checkbox" name="member" value="ì›ì˜"> ì›ì˜</label>
                      <label><input type="checkbox" name="member" value="ë¦¬ì¦ˆ"> ë¦¬ì¦ˆ</label>
                      <label><input type="checkbox" name="member" value="ì´ì„œ"> ì´ì„œ</label>
                  </fieldset>
                  <button type="submit">ì‹œíŠ¸ ìƒì„±</button>
              </form>
          </div>
        </div>
          <!-- ì¹œêµ¬ UUID ì…ë ¥ ëª¨ë‹¬ -->
         <div id="friend-modal" class="modal"><div class="modal-content">
          <span id="friend-modal-close" class="close">&times;</span>
          <h3>ì¹œêµ¬ UUID ì…ë ¥</h3>
          <input id="friend-uuid" placeholder="ì¹œêµ¬ UUID" style="width:100%">
          <button id="friend-add-confirm">ì¶”ê°€</button></div></div>

	<!-- í•˜ë‹¨ ìš°ì¸¡ FAB ë²„íŠ¼ -->
        <button
        id="categoryToggleBtn"
        class="floating-btn left"
        title="ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°"
      >ğŸ·ï¸</button>
        <button id="fab">+</button>
        <!-- FAB ëª¨ë‹¬: ìœ ì € ë°ì´í„°/ê´€ë¦¬ì ë©”ë‰´ -->
        <div id="user-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="user-modal-close" class="close">&times;</span>
            <h3>ìœ ì € ë°ì´í„° ë° ê´€ë¦¬ì ë©”ë‰´</h3>
            <ul>
                <li><button id="load-user-data">ìœ ì € ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button></li>
                <li><button id="reset-checks">ì²´í¬ ìƒíƒœ ì´ˆê¸°í™”</button></li>
                <li><button id="export-sheet">ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥</button></li>
                <li><button id="add-friend">ì¹œêµ¬ ì¶”ê°€</button></li>
            </ul>
            </div>
        </div>
       <!-- âœ… html2canvas ë“± ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
        <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

        <script>
          /* ==========================================================
             ğŸ“Œ pocalist ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸
             (2024-04-28 - ë¦¬íŒ©í„°: ê°€ë…ì„± â†‘ / ì¤‘ë³µ â†“)
             ========================================================== */
          
          /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             0. ì „ì—­ ìƒíƒœ ë° ë„ìš°ë¯¸
             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
          // â”€â”€â”€ í˜ì´ì§•ìš© ì „ì—­ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const BATCH_SIZE   = 100;      // í•œ ë²ˆì— ë¡œë“œí•  ì¹´ë“œ ê°œìˆ˜
          let backupAllImages = [];       // allImages ì›ë³¸ ë°±ì—…ìš©
          let allImages      = [];       // ì „ì²´ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì €ì¥
          let currentBatch   = 0;        // ë Œë”ëœ ë°°ì¹˜ ì¸ë±ìŠ¤
          let isRendering    = false;    // ì¤‘ë³µ ë Œë”ë§ ë°©ì§€ í”Œë˜ê·¸
          let totalCount     = 0;        // â† ì „ì²´ ê°œìˆ˜ í—¤ë”ì—ì„œ ì½ì–´ ì €ì¥
          let currentView       = 'id';      // 'id'  | 'category'
          let viewOwner         = 'self';    // 'self'| 'friend'
          let currentFriendUUID = localStorage.getItem('lastFriendUUID') || null;
          
          const advancedFilters = { groups: [], members: [] };
          
          /* ì§§ì€ ì…€ë ‰í„° ë„ìš°ë¯¸ */
          function $(sel,  scope=document) { return scope.querySelector(sel); }
          function $$(sel, scope=document) { return Array.from(scope.querySelectorAll(sel)); }

          /* â”€â”€ ê³µí†µ: ì´ë¯¸ì§€ ìƒì„¸ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
          function showModal(img) {
            const $modal      = $('#photo-modal');
            const $modalImg   = $('#modal-image');
            const $modalInfo  = $('#modal-info');

            $modalImg.src = img.src;

            $modalInfo.innerHTML = `
              <p>${img.dataset.group   || ''}</p>
              <p>${img.dataset.member  || ''}</p>
              <p>${img.dataset.category || ''} ${img.dataset.title || ''}</p>
              <p>${img.dataset.version || ''}</p>
              <p>#${img.dataset.unique}</p>
            `;

            $modal.style.display = 'block';
          }
            // ëª¨ë‹¬ ì „ì²´ì—ì„œ ìš°í´ë¦­ ë©”ë‰´ ì°¨ë‹¨
            $('#photo-modal').addEventListener('contextmenu', e => e.preventDefault());

            // ëª¨ë‹¬ ì•ˆ ì´ë¯¸ì§€ì—ì„œë„ ìš°í´ë¦­ ë©”ë‰´ ì°¨ë‹¨
            $('#modal-image').addEventListener('contextmenu', e => e.preventDefault());



          /* X ë²„íŠ¼ -or- ë°”ê¹¥ í´ë¦­ â†’ ëª¨ë‹¬ ë‹«ê¸° */
          $('#modal-close').addEventListener('click', () => $('#photo-modal').style.display = 'none');
          $('#photo-modal').addEventListener('click', e => {
            if (e.target === $('#photo-modal')) $('#photo-modal').style.display = 'none';
          });


          
          /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             1. DOMContentLoaded ì´í›„ ì´ˆê¸°í™”
             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
           document.addEventListener('DOMContentLoaded', () => {
            const LONG_PRESS     = 500;
            const TAP_THRESHOLD  = 200;
            const MOVE_THRESHOLD = 10;

             function toggleCheck(img) {
               img.classList.toggle('checked');
               const data = JSON.parse(localStorage.getItem('userData') || '{}');
               data[img.dataset.unique] = img.classList.contains('checked');
               localStorage.setItem('userData', JSON.stringify(data));
               syncLocalDataToServer();
               updateCount();
             }
            // â”€â”€ â¶ toggleCheck í•¨ìˆ˜ ì •ì˜ ...
             const $grid          = $('#photo-grid');
             const $viewToggleBtn = $('#view-toggle');
             const $catToggleBtn  = $('#categoryToggleBtn');
             const $searchInput   = $('#search-input');

             // 0. ë Œë”ë§ í›„ì— ê°’ì„ ì±„ìš¸ ë³€ìˆ˜ë“¤ì€ let ìœ¼ë¡œ
             let originalCards = [];
             let photoCards    = [];
          
           async function fetchAndRenderImages() {
               // 1) ì „ì²´ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° + ì „ì²´ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
              const resp = await fetch('https://pocali-backend.onrender.com/api/images');
              allImages     = await resp.json();
              backupAllImages = allImages.slice();   // â† ì›ë³¸ ë°±ì—…
              totalCount    = allImages.length;
              // 2) ì²« ë°°ì¹˜ ë Œë”ë§ ì „ ì´ˆê¸°í™”
              currentBatch = 0;
              $grid.innerHTML = '';
              // 3) ì²« ë²ˆì§¸ ë°°ì¹˜(100ì¥) ë Œë”ë§ í˜¸ì¶œ
              renderNextBatch();
           }
          
           $searchInput.addEventListener('input', e => {
             const q = e.target.value.trim().toLowerCase();
             // empty ì‹œ ì›ë³¸ ë³µêµ¬, ì•„ë‹ˆë©´ í•„í„°ë§
             if (!q) {
               allImages = backupAllImages.slice();
             } else {
               allImages = backupAllImages.filter(meta =>
                 (`${meta.group} ${meta.member} ${meta.category} ${meta.title}`)
                   .toLowerCase().includes(q)
               );
             }
             // í˜ì´ì§• ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ë Œë”
             currentBatch = 0;
             $grid.innerHTML = '';
             renderNextBatch();
          });

          $viewToggleBtn.addEventListener('click', () => {
            if (viewOwner === 'friend') loadSelfDeck();
            else if (currentFriendUUID) loadFriendDeck(currentFriendUUID);
            else alert('ë¨¼ì € ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!');
          });


          // ì´ì œì•¼ í•œ ë²ˆë§Œ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
          fetchAndRenderImages()
            .catch(console.error);
   

                    
            /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
               2. ê³µí†µ ìœ í‹¸
               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            /** í˜„ì¬ í™”ë©´ì˜ ì´ ì¹´ë“œìˆ˜ / ë³´ìœ ì¹´ë“œìˆ˜ í‘œì‹œ */
            function updateCount () {
              // â€œë³´ìœ ë¨â€ì€ ë¡œì»¬ userData ì— trueì¸ ê²ƒì˜ ê°œìˆ˜
              const data = JSON.parse(localStorage.getItem('userData') || '{}');
              const have = Object.values(data).filter(v => v).length;
              // â€œì „ì²´â€ëŠ” í—¤ë”ì—ì„œ ì½ì€ totalCount
              document.getElementById('count-display').textContent = `${have} / ${totalCount}`;
            }
          
            /** ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ë¦¬ë“œì— ê·¸ëŒ€ë¡œ ë Œë”ë§ */
            function render(cards) {
              $grid.innerHTML = '';
              cards.forEach(c => $grid.appendChild(c));
              updateCount();
            }
          
            /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
               3. ë·° ê·¸ë¦¬ê¸°(ì •ë ¬) í•¨ìˆ˜
               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            /** ê³ ìœ ë²ˆí˜¸(ID) ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ë·° */
            function showById(list = null) {
              const cards = (list ?? originalCards).slice();   // ë³µì‚¬ë³¸
              cards.sort((a, b) =>
                $('.photo-card', b).dataset.unique -
                $('.photo-card', a).dataset.unique
              );
              render(cards);
            }
          
            /** ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹ + ì œëª© + ë²„ì „ í—¤ë” ë·° */
            function showByCategory () {
              const query = ($searchInput.value || '').toLowerCase();
              // originalCards ê°€ ë°©ê¸ˆ ë Œë”ëœ ì»¨í…Œì´ë„ˆë“¤ì„ ê°€ë¦¬í‚¤ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
              /* (1) í•„í„°ë§ */
              const filtered = originalCards.filter(div => {
                const img    = $('.photo-card', div);
                const alt    = img.alt.toLowerCase();
                const group  = img.dataset.group.toLowerCase();
                const member = img.dataset.member.toLowerCase();
          
                const textOK   = !query || alt.includes(query);
                const groupOK  = !advancedFilters.groups.length ||
                                 advancedFilters.groups.includes(group.toUpperCase());
                const memberOK = !advancedFilters.members.length ||
                                 advancedFilters.members.some(v => member.includes(v.toLowerCase()));
          
                return textOK && groupOK && memberOK;
              });
          
              /* (2) ê·¸ë£¹í•‘ ( category | title | version )*/
              const buckets = {};
              filtered.forEach(div => {
                const img  = $('.photo-card', div);
                const key  = [
                  img.dataset.category || 'ë¯¸ë¶„ë¥˜',
                  img.dataset.title    || '',
                  img.dataset.version  || ''
                ].filter(Boolean).join(' | ');
                (buckets[key] = buckets[key] || []).push(div);
              });
          
              /* (3) í—¤ë” + ì¹´ë“œ ë Œë”ë§ */
              $grid.innerHTML = '';
              Object.entries(buckets)
                .sort(([,a],[,b]) =>
                  +$('.photo-card', b[0]).dataset.unique -
                  +$('.photo-card', a[0]).dataset.unique
                )
                .forEach(([header, cards]) => {
                  const h2 = document.createElement('h2');
                  h2.textContent   = header;
                  h2.style.margin  = '16px 0 8px';
                  $grid.appendChild(h2);
          
                  cards.sort((a, b) =>
                    +$('.photo-card', b).dataset.unique -
                    +$('.photo-card', a).dataset.unique
                  ).forEach(div => $grid.appendChild(div));
                });
          
              updateCount();
            }
          
            /** í˜„ì¬ í•„í„°/ë·° ìƒíƒœë¡œ ë‹¤ì‹œ ê·¸ë¦¬ê¸° */
            function applyFilters () {
                /* â‘¡ ê³µí†µ í•„í„°(ê²€ìƒ‰ì–´ + ìƒì„¸ì¡°ê±´) í•œ ë²ˆë§Œ ê³„ì‚° */
              const query = ($searchInput.value || '').toLowerCase();

              const filtered = originalCards.filter(div => {
                const img    = $('.photo-card', div);
                const alt    = img.alt.toLowerCase();
                const group  = img.dataset.group.toLowerCase();
                const member = img.dataset.member.toLowerCase();

                const textOK   = !query || alt.includes(query);
                const groupOK  = !advancedFilters.groups.length ||
                                advancedFilters.groups.includes(group.toUpperCase());
                const memberOK = !advancedFilters.members.length ||
                                advancedFilters.members.some(v => member.includes(v.toLowerCase()));

                return textOK && groupOK && memberOK;
              });
              if (currentView === 'category') showByCategory(filtered);
              else                            showById(filtered);
            }

            
          
            /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
               4. ë± ì „í™˜ (loadSelfDeck / loadFriendDeck)
               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            /** ë‚´ ë³´ìœ  ì¹´ë“œ í‘œì‹œ */
            function loadSelfDeck () {
              const myData = JSON.parse(localStorage.getItem('userData') || '{}');
              userData    = myData;                 // â† ì „ì—­ ë³€ìˆ˜ë„ ì—…ë°ì´íŠ¸
              photoCards.forEach(img => {
                img.classList.toggle('checked', !!myData[img.dataset.unique]);
                img.style.pointerEvents = '';        // ë”ë¸”í´ë¦­ í—ˆìš©
              });
          
              viewOwner   = 'self';
              $viewToggleBtn.textContent = 'ğŸ‘¥ ì¹œêµ¬ë³´ê¸°';
              updateCount();
            }
          
            /** ì¹œêµ¬ ë³´ìœ  ì¹´ë“œ í‘œì‹œ */
            async function loadFriendDeck (uuid) {
              const res = await fetch(`https://pocali-backend.onrender.com/api/friend/${uuid}/collection`);
              if (!res.ok) {
                alert('ì¹œêµ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }
          
              const friendData = (await res.json()).data || {};
              photoCards.forEach(img => {
                img.classList.toggle('checked', !!friendData[img.dataset.unique]);
                img.style.pointerEvents = 'none';   // ìˆ˜ì • ê¸ˆì§€
              });
          
              viewOwner         = 'friend';
              currentFriendUUID = uuid;
              localStorage.setItem('lastFriendUUID', uuid);
          
              $viewToggleBtn.textContent = 'ğŸ‘¤ ë‚´ ì¹´ë“œë³´ê¸°';
              updateCount();
            }
          
            /* ì „ì—­(ì½˜ì†”)ì—ì„œë„ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ */
            window.loadSelfDeck   = loadSelfDeck;
            window.loadFriendDeck = loadFriendDeck;
          
                       
          
            /* 5-2. â€œì¹œêµ¬ë³´ê¸° â†” ë‚´ì¹´ë“œë³´ê¸°â€ í† ê¸€ ë²„íŠ¼ */
            $viewToggleBtn.addEventListener('click', () => {
              if (viewOwner === 'friend') loadSelfDeck();
              else if (currentFriendUUID) loadFriendDeck(currentFriendUUID);
              else alert('ë¨¼ì € ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!');
            });
          
            /* 5-3. ì¢Œì¸¡ í•˜ë‹¨ ì¹´í…Œê³ ë¦¬/ID ì „í™˜ ë²„íŠ¼ */
            $catToggleBtn.addEventListener('click', () => {
              currentView = currentView === 'id' ? 'category' : 'id';
              $catToggleBtn.textContent = currentView === 'id' ? 'ğŸ·ï¸' : 'ğŸ”¢';
              $catToggleBtn.title       = currentView === 'id'
                                        ? 'ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°'
                                        : 'ê³ ìœ ë²ˆí˜¸ ìˆœ ë³´ê¸°';
              applyFilters();
            });
          
            /* 5-4. ìƒë‹¨ ê²€ìƒ‰ ì…ë ¥ */
            $searchInput.addEventListener('input', applyFilters);
          
            /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
               6. ì´ˆê¸° ëœë”ë§
               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            showById();          // ê¸°ë³¸ ì •ë ¬
            loadSelfDeck();       // âœ… ë³´ìœ í‘œì‹œë„ í•¨ê»˜!
            updateCount();       // ì¹´ìš´í„° ì´ˆê¸°í™”
            /* ğŸ”» â¹ ì„œë²„â†’í´ë¼ì´ì–¸íŠ¸ 10ì´ˆ í´ë§ ------------------------*/
            async function pollServerData () {
              if (viewOwner !== 'self') return;           // ì¹œêµ¬ ë³´ê¸° ë• ê±´ë„ˆëœ€
            
              const me = localStorage.getItem('myUUID');
              if (!me) return;
            
              const r = await fetch(`https://pocali-backend.onrender.com/api/user/${me}`);
              if (!r.ok) return;
              userData = JSON.parse((await r.json()).data || '{}');
              localStorage.setItem('userData', JSON.stringify(userData));
            
              photoCards.forEach(img =>
                img.classList.toggle('checked', !!userData[img.dataset.unique]));
              updateCount();
            }
            setInterval(pollServerData, 10_000);
            /* ------------------------------------------------------*/
            /* â”€â”€ 5-A. ìš°ì¸¡ FAB & ëª¨ë‹¬ ë³´ì¡° ê¸°ëŠ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            const $fab           = $('#fab');
            const $userModal     = $('#user-modal');
            const $userModalClose= $('#user-modal-close');
            
            const $addFriendBtn  = $('#add-friend');
            const $friendModal   = $('#friend-modal');
            const $friendClose   = $('#friend-modal-close');
            const $friendConfirm = $('#friend-add-confirm');

            const $resetBtn      = $('#reset-checks');
            const $exportBtn     = $('#export-sheet');     // (ì‹œíŠ¸ ëª¨ë‹¬ ì—´ê¸°ë§Œ)

            const $userDataModal      = $('#user-data-modal');
            const $userDataModalClose = $('#user-data-modal-close');

            $userDataModalClose.addEventListener('click', () => $userDataModal.style.display = 'none');
            $userDataModal.addEventListener('click',  e => {      // ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œì—ë„ ë‹«í˜
              if (e.target === $userDataModal) $userDataModal.style.display = 'none';
            });

            // ìƒì„¸ ê²€ìƒ‰ ì—´ê¸°/ë‹«ê¸°
            const detailBtn = document.getElementById('search-detail-btn');
            const detailModal = document.getElementById('detail-search-modal');
            const detailForm  = document.getElementById('detail-search-form');

            detailBtn.addEventListener('click', () => detailModal.style.display = 'block');
            detailModal.querySelector('.close').addEventListener('click', () => detailModal.style.display = 'none');
            detailModal.addEventListener('click', e => { if (e.target === detailModal) detailModal.style.display = 'none'; });

            // í¼ ì œì¶œ ì‹œ í•„í„° ì ìš©
             detailForm.addEventListener('submit', e => {
               e.preventDefault();
              const fd      = new FormData(detailForm);
               const groups  = fd.getAll('group');
               const members = fd.getAll('member');
            
               // â‘  allImages ì „ì²´ì—ì„œ í•„í„° ì ìš©
               if (!groups.length && !members.length) {
                 allImages = backupAllImages.slice();
               } else {
                 allImages = backupAllImages.filter(meta =>
                   (groups.length === 0 || groups.includes(meta.group)) &&
                   (members.length === 0 || members.includes(meta.member))
                 );
               }
            
               // â‘¡ í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™” + ì²« ë°°ì¹˜ ë Œë”
               currentBatch = 0;
               $grid.innerHTML = '';
               renderNextBatch();
            
               // â‘¢ ëª¨ë‹¬ ë‹«ê¸°
               detailModal.style.display = 'none';
             });

             // âœ… ì˜¬ë°”ë¥¸ ì½”ë“œ: export-form ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ allImagesì—ì„œ í•„í„°
             const $exportForm  = document.getElementById('export-form');
             const $exportModal = document.getElementById('export-modal'); 
             $exportForm.addEventListener('submit', e => {
                e.preventDefault();
                const fd      = new FormData($exportForm);
                const group   = fd.get('group');
                const members = fd.getAll('member');

                const sel = allImages.filter(meta =>
                  meta.group === group &&
                  (members.length === 0 || members.includes(meta.member))
                );
                if (!sel.length) {
                  return alert('ì„ íƒí•˜ì‹  ì¡°ê±´ì— ë§ëŠ” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                  // 3) ë©”íƒ€â†’<img> ìš”ì†Œë¡œ ë³€í™˜ (ë³´ìœ ì—¬ë¶€ ë°˜ì˜)
               const nodes = sel.map(meta => {
                const img = document.createElement('img');
                img.className       = 'photo-card';
                img.crossOrigin     = 'anonymous';
                img.src             = meta.url;
                img.alt             = `${meta.group} ${meta.member} ${meta.category} ${meta.title}`;
                img.dataset.unique  = meta.unique_id;
                img.dataset.group   = meta.group;
                img.dataset.member  = meta.member;
                img.dataset.category= meta.category;
                img.dataset.title   = meta.title;
                img.dataset.version = meta.version;
                const ud = JSON.parse(localStorage.getItem('userData')||'{}');
                if (ud[meta.unique_id]) img.classList.add('checked');
                return img;
              });

                            // â”€â”€ export-modal ë‹«ê¸° í•¸ë“¤ëŸ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              const $exportModalClose = document.getElementById('export-modal-close');
              $exportModalClose.addEventListener('click', () => {
                document.getElementById('export-modal').style.display = 'none';
              });
              // ë°”ê¹¥ í´ë¦­í•´ë„ ë‹«íˆê²Œ (ì„ íƒ)
              const $exportModal = document.getElementById('export-modal');
              $exportModal.addEventListener('click', e => {
                if (e.target === $exportModal) $exportModal.style.display = 'none';
              });
            
                 $exportModal.style.display = 'none';
                  generateImageSheet(nodes);
                });


            /* ğŸ”» âº ë‹¤ë¥¸ UUID ë¶ˆëŸ¬ì˜¤ê¸° --------------------------------*/
            $('#load-other-data')?.addEventListener('click', async () => {
              const other = $('#other-uuid').value.trim();
              if (!other) return alert('UUIDë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
              const r = await fetch(`https://pocali-backend.onrender.com/api/user/${other}`);
              if (!r.ok) return alert('í•´ë‹¹ UUIDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              const json = await r.json();
              localStorage.setItem('userData', json.data);
              localStorage.setItem('myUUID',   other);
              location.reload();                 // â† ë°”ë¡œ ì ìš©
            });
            /* -------------------------------------------------------*/
            /* ğŸ”» âº-B : ìœ ì € ë°ì´í„° ëª¨ë‹¬ & ì„œë²„ ë™ê¸°í™” ----------------------- */
            const $loadUserBtn  = $('#load-user-data');      // â‘  â€œìœ ì € ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°â€

            // 1) UUID ê°€ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ìƒˆë¡œ ë°œê¸‰ë°›ê¸°
            async function ensureMyUUID () {
              let me = localStorage.getItem('myUUID');
              if (me) return me;
               const r = await fetch('https://pocali-backend.onrender.com/api/register', {
                 method: 'POST'
               });
              me = (await r.json()).user_id;
              localStorage.setItem('myUUID', me);
              return me;
            }

            // 2) ë¡œì»¬ userData â†’ ì„œë²„ DB ì—…ë¡œë“œ
            async function syncLocalDataToServer () {
              const me = localStorage.getItem('myUUID');
              if (!me) return;
              const data = JSON.parse(localStorage.getItem('userData') || '{}');
              await fetch(`https://pocali-backend.onrender.com/api/user/${me}`, {
                method : 'POST',
                headers: { 'Content-Type':'application/json' },
                body   : JSON.stringify({ data })
              });
            }

            // 3) â€œìœ ì € ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°â€ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            $loadUserBtn?.addEventListener('click', async () => {
              $userModal.style.display = 'none';          // ê¸°ì¡´ ëª¨ë‹¬ ë‹«ê¸°
              const me = await ensureMyUUID();            // UUID í™•ë³´/í‘œì‹œ
              $('#my-uuid').value    = me;
              $('#other-uuid').value = '';
              $('#uuid-msg').textContent = '';
              $('#user-data-modal').style.display = 'block';
            });
            /* ------------------------------------------------------------- */




            /* â‘  FAB ëˆŒëŸ¬ â†’ â€˜ìœ ì € ì„¤ì •â€™ ëª¨ë‹¬ */
            $fab.addEventListener('click', () => $userModal.style.display = 'block');
            $userModalClose.addEventListener('click', () => $userModal.style.display = 'none');
            $userModal.addEventListener('click', e => {
              if (e.target === $userModal) $userModal.style.display = 'none';
            });

            /* â‘¡ ì¹œêµ¬ ì¶”ê°€ â€“ UUID ì…ë ¥ ëª¨ë‹¬ */
            $addFriendBtn.addEventListener('click', () => {
              $userModal.style.display = 'none';
              $friendModal.style.display = 'block';
            });
            $friendClose.addEventListener('click', () => $friendModal.style.display = 'none');
            $friendModal.addEventListener('click', e => { if (e.target === $friendModal) $friendModal.style.display = 'none'; });

            $friendConfirm.addEventListener('click', async () => {
              const me     = localStorage.getItem('myUUID');
              const friend = $('#friend-uuid').value.trim();
              if (!me || !friend) { alert('UUIDë¥¼ ì…ë ¥í•˜ì„¸ìš”!'); return; }

              const ok = await fetch('https://pocali-backend.onrender.com/api/friends', {
                method : 'POST',
                headers: { 'Content-Type':'application/json' },
                body   : JSON.stringify({ me, friend })
              }).then(r => r.ok);

              if (!ok) return alert('ë“±ë¡ ì‹¤íŒ¨');

              localStorage.setItem('lastFriendUUID', friend);
              $friendModal.style.display = 'none';
              loadFriendDeck(friend);
              alert('ì¹œêµ¬ ë“±ë¡ ì™„ë£Œ!');
            });

            /* â‘¢ ì²´í¬ ìƒíƒœ ì´ˆê¸°í™” */
            $resetBtn.addEventListener('click', async () => {      // â† async ë¡œ ë³€ê²½
              if (!confirm('ëª¨ë“  ì²´í¬ë¥¼ í•´ì œí• ê¹Œìš”?')) return;

              // 1) í™”ë©´-ë¡œì»¬ ì´ˆê¸°í™”
              $$('.photo-card').forEach(img => img.classList.remove('checked'));
              localStorage.removeItem('userData');
              updateCount();

              // 2) ì„œë²„ì—ë„ ë¹ˆ ë°ì´í„° ì—…ë¡œë“œ  â† â˜… ì´ ë‘ ì¤„ ì¶”ê°€
              const me = localStorage.getItem('myUUID');
              if (me) {
                await fetch(`https://pocali-backend.onrender.com/api/user/${me}`, {
                  method : 'POST',
                  headers: { 'Content-Type':'application/json' },
                  body   : JSON.stringify({ data: {} })
                });
              }
            });

            /* â‘£ ì‹œíŠ¸(í”„ë¦°íŠ¸) ëª¨ë‹¬ ì—´ê¸° */
            $exportBtn.addEventListener('click', () => {
              $('#user-modal').style.display = 'none';
              $('#export-modal').style.display = 'block';
            });
            

            // âŠ ìƒì„¸ ê²€ìƒ‰ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
              const searchDetailBtn         = document.getElementById('search-detail-btn');
              const detailSearchModal       = document.getElementById('detail-search-modal');
              const detailSearchModalClose  = document.getElementById('detail-search-modal-close');

              searchDetailBtn.addEventListener('click', () => {
                detailSearchModal.style.display = 'block';
              });
              detailSearchModalClose.addEventListener('click', () => {
                detailSearchModal.style.display = 'none';
              });
              detailSearchModal.addEventListener('click', e => {
                if (e.target === detailSearchModal) detailSearchModal.style.display = 'none';
              });
             
            /* â‘£ ì‹œíŠ¸ â†’ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œìš© í—¬í¼  */
            function generateImageSheet(cards) {
              /* 4-1. ì „ì²´ ì˜¤ë²„ë ˆì´ */
              const overlay = document.createElement('div');
              overlay.style.cssText = `
                position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:9999;
                display:flex; flex-direction:column; align-items:center;
              `; // â† overflow:auto ì œê±°

              /* 4-2. ê·¸ë¦¬ë“œ */
              const grid = document.createElement('div');
              grid.style.cssText = `
                display:grid;
                grid-template-columns:repeat(16, 1fr);
                gap:8px; padding:24px; max-width:none;
                overflow:visible;
              `; // â† overflow-x:auto â†’ overflow:visible
              overlay.appendChild(grid);

              /* 4-3. ì¹´ë“œ ì‚½ì… (ë¶ˆíˆ¬ëª…ë„ = ë³´ìœ  ì—¬ë¶€) */
              cards.forEach(img => {
                const clone = img.cloneNode();
                clone.style.width  = '100%';
                clone.style.opacity= img.classList.contains('checked') ? '1' : '0.4';
                grid.appendChild(clone);
              });

              /* 4-4. ë²„íŠ¼ë“¤ */
              const btnBar = document.createElement('div');
              btnBar.style.cssText = `position:fixed; top:20px; right:20px; display:flex; gap:8px;`;
              overlay.appendChild(btnBar);

              const close = document.createElement('button');
              close.textContent = 'ë‹«ê¸°';
              close.style.cssText = `padding:8px 14px; background:#f44336; color:#fff; border:none;`;
              close.onclick = () => document.body.removeChild(overlay);

              const save  = document.createElement('button');
              save.textContent = 'ì´ë¯¸ì§€ ì €ì¥';
              save.style.cssText = `padding:8px 14px; background:#4CAF50; color:#fff; border:none;`;
              save.onclick  = () => downloadAsImage(overlay);

              btnBar.append(close, save);

              document.body.appendChild(overlay);
            }

            /* â‘¤ html2canvas ë˜í¼ */
            function downloadAsImage(target) {
              const loader = document.createElement('div');
              loader.textContent = 'ì´ë¯¸ì§€ ìƒì„± ì¤‘â€¦';
              loader.style.cssText = `
                position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
                background:rgba(0,0,0,.6); color:#fff; font-size:1.2rem; z-index:10000;
              `;
              document.body.appendChild(loader);

              html2canvas(target, { scale:2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `pocalist_sheet_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(loader);
              }).catch(err => {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
                document.body.removeChild(loader);
              });
            }

            // â”€â”€â”€ í˜ì´ì§•ë³„ ë Œë”ë§ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             function renderNextBatch() {
            if (isRendering) return;
            isRendering = true;

            const start = currentBatch * BATCH_SIZE;
            const end   = start + BATCH_SIZE;
            const slice = allImages.slice(start, end);

            slice.forEach(image => {
              // 1) ì¹´ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
              const container = document.createElement('div');
              container.className = 'photo-card-container';

              // 2) <img> ìš”ì†Œ ìƒì„±
              const img = document.createElement('img');
              img.className       = 'photo-card';
              img.src             = image.url.startsWith('http')
                                    ? image.url
                                    : `https://pocali-backend.onrender.com${image.url}`;
              img.loading         = 'lazy';
              img.alt             = `${image.group} ${image.member} ${image.category} ${image.title} #${image.unique_id}`;
              img.dataset.group   = image.group;
              img.dataset.member  = image.member;
              img.dataset.category= image.category;
              img.dataset.title   = image.title;
              img.dataset.version = image.version;
              img.dataset.unique  = image.unique_id;

              // â”€â”€ ë¡œì»¬ ì €ì¥ì†Œ(userData)ì— ìˆë˜ ì²´í¬ ì •ë³´ ì¬ì ìš©
              const saved = JSON.parse(localStorage.getItem('userData') || '{}');
              if (saved[image.unique_id]) {
                img.classList.add('checked');
              }


              // 3) ì˜¤ë²„ë ˆì´: image.type ë˜ëŠ” ë°±ì—”ë“œ file_type í™œìš©
              const overlay = document.createElement('div');
              overlay.className   = 'image-overlay';
              overlay.textContent = image.type || image.file_type || '';
              container.appendChild(overlay);

              // 4) í„°ì¹˜Â·ë¡±í”„ë ˆìŠ¤ & ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
              let startTime, pressTimer;
              img.addEventListener('pointerdown', e => {
                if (viewOwner !== 'self') return;
                startTime = performance.now();
                pressTimer = setTimeout(() => showModal(img), LONG_PRESS);
              });
              img.addEventListener('pointerup', e => {
                clearTimeout(pressTimer);
                if (performance.now() - startTime < TAP_THRESHOLD) {
                  toggleCheck(img);
                }
              });
              img.addEventListener('pointerleave', () => clearTimeout(pressTimer));
              img.addEventListener('dblclick', () => {
                if (viewOwner !== 'self') return;
                toggleCheck(img);
              });
              img.addEventListener('contextmenu', e => {
                e.preventDefault();
                showModal(img);
              });

              // 5) ê·¸ë¦¬ë“œì— ì¶”ê°€
              container.appendChild(img);
              $grid.appendChild(container);
            });
              // â€” ìºì‹œ ê°±ì‹ 
            originalCards = Array.from($grid.querySelectorAll('.photo-card-container'));
            photoCards    = Array.from($grid.querySelectorAll('.photo-card'));

            // â€” ìƒíƒœ ê°±ì‹ 
            if (currentBatch === 0) {
              totalCount = allImages.length;
            }
            currentBatch++;
            updateCount();

            // â€” í˜„ì¬ ë·°(ID/ì¹´í…Œê³ ë¦¬)ì— ë§ì¶° ì¬ë Œë”
            applyFilters();

            isRendering = false; 
          }
          
            // â”€â”€â”€ ë¬´í•œ ìŠ¤í¬ë¡¤ íŠ¸ë¦¬ê±° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            window.addEventListener('scroll', () => {
              const nearBottom = window.innerHeight + window.scrollY
                               >= document.body.offsetHeight - 200;
              if (nearBottom && currentBatch * BATCH_SIZE < allImages.length) {
                renderNextBatch();
              }
            });
             });
              
          
          </script>
               
      </body>
      </html>