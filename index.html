<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>pocalist</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
        <!-- ìƒë‹¨ ê²€ìƒ‰ì°½ & ì¹´ìš´í„° -->
        <header id="search-header">
          <input type="text" id="search-input" placeholder="í¬í† ì¹´ë“œ ê²€ìƒ‰..." />
          <button id="search-detail-btn">+</button>
          <div id="count-display" style="text-align:center; font-weight:bold; margin-top: 5px;">
            0 / 0
          </div>
          <button id="view-toggle">ğŸ‘¥ ì¹œêµ¬ë³´ê¸°</button>  <!-- â† ìƒˆ ë²„íŠ¼ -->
        </header>
  <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->        
	<div id="photo-grid">  
    </div>
    <!-- ì¹´ë“œ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="photo-modal" class="modal" style="display: none;">
     <div class="modal-content">
      <span id="modal-close" class="close">&times;</span>
      <img id="modal-image" src="" alt="í™•ëŒ€ëœ í¬í† ì¹´ë“œ" draggable="false" />
      <div id="modal-info">
        <!-- íŒŒì¼ëª… íŒŒì‹± ë“±ìœ¼ë¡œ ì¶”í›„ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•  ì˜ˆì • -->
        </div>
      </div>
    </div>
    <!-- ìœ ì € ë°ì´í„° ëª¨ë‹¬ -->
   <div id="user-data-modal" class="modal" style="display: none;">
   <div class="modal-content">
    <span id="user-data-modal-close" class="close">&times;</span>
    <h3>UUID ë°ì´í„° ê´€ë¦¬</h3>

    <!-- ë‚´ UUID ì˜ì—­ -->
    <label for="my-uuid">ë‚´ UUID:</label>
    <input type="text" id="my-uuid" readonly style="width: 100%;" />

    <!-- ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ì…ë ¥ ì˜ì—­ -->
    <label for="other-uuid">ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ë¶ˆëŸ¬ì˜¤ê¸°:</label>
    <input type="text" id="other-uuid" placeholder="ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤ì˜ UUID ì…ë ¥" style="width: 100%;" />
    <button id="load-other-data">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>

    <!-- ë©”ì‹œì§€ ë˜ëŠ” ì—ëŸ¬ í‘œì‹œ -->
    <div id="uuid-msg" style="margin-top: 10px; color: red;"></div>
    </div>
   </div>

         <!-- ìƒì„¸ ê²€ìƒ‰ ëª¨ë‹¬ -->
        <div id="detail-search-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="detail-search-modal-close" class="close">&times;</span>
            <h3>ìƒì„¸ ê²€ìƒ‰ ì˜µì…˜</h3>
            <form id="detail-search-form">
                <fieldset>
                <legend>ê·¸ë£¹</legend>
                <label>
                    <input type="checkbox" name="group" value="IVE" />
                    ì•„ì´ë¸Œ
                </label>
                <label>
                    <input type="checkbox" name="group" value="IZONE" />
                    ì•„ì´ì¦ˆì›
                </label>
                </fieldset>
                <fieldset>
                <legend>ë©¤ë²„</legend>
                <label>
                    <input type="checkbox" name="member" value="ìœ ì§„" />
                    ìœ ì§„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ê°€ì„" />
                    ê°€ì„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë ˆì´" />
                    ë ˆì´
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì›ì˜" />
                    ì›ì˜
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë¦¬ì¦ˆ" />
                    ë¦¬ì¦ˆ
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì´ì„œ" />
                    ì´ì„œ
                </label>
                </fieldset>
                <fieldset>
                <legend>í…ìŠ¤íŠ¸ ê²€ìƒ‰</legend>
                <input type="text" id="filter-text" name="filter-text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
                </fieldset>
                <button type="submit">ê²€ìƒ‰</button>
            </form>
            </div>
        </div>
        <!-- ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥ ëª¨ë‹¬ -->
        <div id="export-modal" class="modal" style="display: none;">
          <div class="modal-content">
              <span id="export-modal-close" class="close">&times;</span>
              <h3>í¬í† ì¹´ë“œ ì‹œíŠ¸ ì¶œë ¥</h3>
              <form id="export-form">
                  <fieldset>
                      <legend>ê·¸ë£¹ ì„ íƒ</legend>
                      <label><input type="radio" name="group" value="IVE" checked> ì•„ì´ë¸Œ</label>
                      <label><input type="radio" name="group" value="IZONE"> ì•„ì´ì¦ˆì›</label>
                  </fieldset>
                  <fieldset>
                      <legend>ë©¤ë²„ ì„ íƒ</legend>
                      <label><input type="checkbox" name="member" value="ìœ ì§„"> ìœ ì§„</label>
                      <label><input type="checkbox" name="member" value="ê°€ì„"> ê°€ì„</label>
                      <label><input type="checkbox" name="member" value="ë ˆì´"> ë ˆì´</label>
                      <label><input type="checkbox" name="member" value="ì›ì˜"> ì›ì˜</label>
                      <label><input type="checkbox" name="member" value="ë¦¬ì¦ˆ"> ë¦¬ì¦ˆ</label>
                      <label><input type="checkbox" name="member" value="ì´ì„œ"> ì´ì„œ</label>
                  </fieldset>
                  <button type="submit">ì‹œíŠ¸ ìƒì„±</button>
              </form>
          </div>
        </div>
          <!-- ì¹œêµ¬ UUID ì…ë ¥ ëª¨ë‹¬ -->
         <div id="friend-modal" class="modal"><div class="modal-content">
          <span id="friend-modal-close" class="close">&times;</span>
          <h3>ì¹œêµ¬ UUID ì…ë ¥</h3>
          <input id="friend-uuid" placeholder="ì¹œêµ¬ UUID" style="width:100%">
          <button id="friend-add-confirm">ì¶”ê°€</button></div></div>

	<!-- í•˜ë‹¨ ìš°ì¸¡ FAB ë²„íŠ¼ -->
        <button
        id="categoryToggleBtn"
        class="floating-btn left"
        title="ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°"
      >ğŸ·ï¸</button>
        <button id="fab">+</button>
        <!-- FAB ëª¨ë‹¬: ìœ ì € ë°ì´í„°/ê´€ë¦¬ì ë©”ë‰´ -->
        <div id="user-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="user-modal-close" class="close">&times;</span>
            <h3>ìœ ì € ë°ì´í„° ë° ê´€ë¦¬ì ë©”ë‰´</h3>
            <ul>
                <li><button id="load-user-data">ìœ ì € ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button></li>
                <li><button id="reset-checks">ì²´í¬ ìƒíƒœ ì´ˆê¸°í™”</button></li>
                <li><button id="export-sheet">ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥</button></li>
                <li><button id="add-friend">ì¹œêµ¬ ì¶”ê°€</button></li>
            </ul>
            </div>
        </div>
        <!-- ë¡œë”© í™”ë©´ ìˆ˜ì • ë¶€ë¶„ - Firebase Storage ì´ë¯¸ì§€ë¡œ êµì²´ -->
        <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: #f8f9fa; 
        display: flex; flex-direction: column; 
        align-items: center; justify-content: center; z-index: 9999; overflow: hidden;">
        
        <!-- ë°°ê²½ ì¹´ë“œ íš¨ê³¼ - Firebase Storage URLë¡œ ë³€ê²½ -->
        <div class="background-card" style="position: absolute; width: 150px; height: 210px; 
        background-image: url('/static/images/default-card1.jpg');
        background-size: cover; background-position: center;
        border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        top: 15%; left: 10%; transform: rotate(-8deg); z-index: -1;"></div>
      
        <div class="background-card" style="position: absolute; width: 150px; height: 210px; 
        background-image: url('/static/images/default-card2.jpg');
        background-size: cover; background-position: center;
        border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        top: 25%; right: 10%; transform: rotate(12deg); z-index: -1;"></div>
      
        <div class="background-card" style="position: absolute; width: 120px; height: 180px; 
        background-image: url('/static/images/default-card3.jpg');
        background-size: cover; background-position: center;
        border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        bottom: 20%; left: 15%; transform: rotate(5deg); z-index: -1;"></div>
      
        <div class="background-card" style="position: absolute; width: 135px; height: 190px; 
        background-image: url('/static/images/default-card4.jpg');
        background-size: cover; background-position: center;
        border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        bottom: 15%; right: 15%; transform: rotate(-15deg); z-index: -1;"></div>

        <!-- ë¡œê³  ì˜ì—­ - í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ ë° ê·¸ë¦¼ì ì¶”ê°€ -->
        <h1 style="margin-bottom: 30px; font-size: 32px; font-weight: 800; color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">POCALIST</h1>

        <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
        <div class="loading-spinner" style="width: 50px; height: 50px; border: 3px solid rgba(0, 0, 0, 0.1); 
              border-top: 3px solid #3498db; border-radius: 50%; 
              animation: spin 1s linear infinite;"></div>

        <!-- ë¡œë”© í…ìŠ¤íŠ¸ - í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ ë° ê·¸ë¦¼ì ì¶”ê°€ -->
        <p style="margin-top: 20px; font-size: 18px; color: #fff; font-weight: 600; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">ì•„ì´ë¸Œ ëª¨ì…”ì˜¤ëŠ” ì¤‘...</p>
      </div>

        <style>
        @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
        }

        @keyframes float {
        0%, 100% { transform: translateY(0) rotate(var(--rotate)); }
        50% { transform: translateY(-15px) rotate(var(--rotate)); }
        }

        .background-card {
        --rotate: -8deg;
        animation: float 6s ease-in-out infinite;
        animation-delay: calc(var(--index) * 0.5s);
        }

        .background-card:nth-child(1) { --index: 1; --rotate: -8deg; }
        .background-card:nth-child(2) { --index: 2; --rotate: 12deg; }
        .background-card:nth-child(3) { --index: 3; --rotate: 5deg; }
        .background-card:nth-child(4) { --index: 4; --rotate: -15deg; }
        </style>

        <script>
        // ë¡œë”© í™”ë©´ ì œê±° í•¨ìˆ˜
        function hideLoadingScreen() {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transition = 'opacity 0.5s';
        setTimeout(() => loadingScreen.remove(), 500);
        }
        }

        // ğŸ”¥ ìë™ ìˆ¨ê¹€ ìŠ¤í¬ë¦½íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
        // â° ì—¬ê¸°ì„œ ì‹œê°„ ë³€ê²½ (ë°€ë¦¬ì´ˆ ë‹¨ìœ„)
        const LOADING_TIME = 3000; // 3ì´ˆ (ì›í•˜ëŠ” ì‹œê°„ìœ¼ë¡œ ë³€ê²½)

        setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transition = 'opacity 0.5s';
        setTimeout(() => loadingScreen.remove(), 500);
        }
        }, LOADING_TIME);
        });
        </script>
       <!-- âœ… html2canvas ë“± ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
      <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
      <script>
        // ğŸ”’ ê¸°ë³¸ì ì¸ ì†ŒìŠ¤ì½”ë“œ ë³´í˜¸ + ê°•ë ¥í•œ ëŒ€ì‘
           (function() {
            'use strict';
            
            // 1. ìš°í´ë¦­ ë°©ì§€
            document.addEventListener('contextmenu', e => {
              e.preventDefault();
              return false;
            });
            
            // 2. í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ë°©ì§€
            document.addEventListener('keydown', e => {
              // F12 (ê°œë°œìë„êµ¬)
              if (e.keyCode === 123) {
                e.preventDefault();
                return false;
              }
              
              // Ctrl+Shift+I (ê°œë°œìë„êµ¬)
              if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                e.preventDefault();
                return false;
              }
              
              // Ctrl+Shift+J (ì½˜ì†”)
              if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                e.preventDefault();
                return false;
              }
              
              // Ctrl+U (ì†ŒìŠ¤ë³´ê¸°)
              if (e.ctrlKey && e.keyCode === 85) {
                e.preventDefault();
                return false;
              }
              
              // Ctrl+S (ì €ì¥)
              if (e.ctrlKey && e.keyCode === 83) {
                e.preventDefault();
                return false;
              }
            });
            
            // âœ… ê°œë°œìë„êµ¬ ê°ì§€ ë¶€ë¶„ ì œê±° (ìŠ¤í¬ë¡¤ ì´ìŠˆ í•´ê²°)
            
            // Console ë©”ì‹œì§€ ë®ì–´ì“°ê¸° (ì„ íƒì‚¬í•­)
            /*
            setInterval(() => {
              console.clear();
              console.log('%cSTOP!', 'color: red; font-size: 50px; font-weight: bold;');
              console.log('%cì´ ì˜ì—­ì€ ê°œë°œìë¥¼ ìœ„í•œ ì½˜ì†”ì…ë‹ˆë‹¤.\nì•…ì˜ì ì¸ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ë³´ì•ˆ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 
                          'color: red; font-size: 14px;');
            }, 3000);
            */
            
          })();
      </script>
      <script>
        /* ==========================================================
          ğŸ“Œ pocalist ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ - ì™„ì „ ìˆ˜ì • ë²„ì „
          ========================================================== */

        // IndexedDB ì„¤ì •
        const DB_NAME = 'pocalistDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'userDataStore';
        let db = null;

        // IndexedDB ì´ˆê¸°í™”
        function initIndexedDB() {
          return new Promise((resolve, reject) => {
            if (db) {
              return resolve(db);
            }

            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
              console.error('IndexedDB ì—´ê¸° ì‹¤íŒ¨:', event);
              reject('IndexedDBë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            };

            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'key' });
                console.log('IndexedDB ìŠ¤í† ì–´ ìƒì„± ì™„ë£Œ');
              }
            };

            request.onsuccess = (event) => {
              db = event.target.result;
              console.log('IndexedDB ì—°ê²° ì„±ê³µ');
              resolve(db);
            };
          });
        }

        // IndexedDBì— ë°ì´í„° ì €ì¥
        function saveToIndexedDB(key, value) {
          return new Promise(async (resolve, reject) => {
            try {
              const db = await initIndexedDB();
              const transaction = db.transaction([STORE_NAME], 'readwrite');
              const store = transaction.objectStore(STORE_NAME);
              
              const request = store.put({ key, value });
              
              request.onsuccess = () => {
                console.log(`IndexedDBì— ${key} ì €ì¥ ì„±ê³µ`);
                resolve(true);
              };
              
              request.onerror = (event) => {
                console.error(`IndexedDBì— ${key} ì €ì¥ ì‹¤íŒ¨:`, event);
                reject(event);
              };
            } catch (error) {
              console.error('IndexedDB ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
              reject(error);
            }
          });
        }

        // IndexedDBì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getFromIndexedDB(key) {
          return new Promise(async (resolve, reject) => {
            try {
              const db = await initIndexedDB();
              const transaction = db.transaction([STORE_NAME], 'readonly');
              const store = transaction.objectStore(STORE_NAME);
              
              const request = store.get(key);
              
              request.onsuccess = () => {
                const result = request.result;
                if (result) {
                  console.log(`IndexedDBì—ì„œ ${key} ë¡œë“œ ì„±ê³µ`);
                  resolve(result.value);
                } else {
                  console.log(`IndexedDBì— ${key} ì—†ìŒ`);
                  resolve(null);
                }
              };
              
              request.onerror = (event) => {
                console.error(`IndexedDBì—ì„œ ${key} ë¡œë“œ ì‹¤íŒ¨:`, event);
                reject(event);
              };
            } catch (error) {
              console.error('IndexedDB ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
              reject(error);
            }
          });
        }

        // ì¿ í‚¤ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function setCookie(name, value, days) {
          let expires = "";
          if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
          }
          document.cookie = name + "=" + encodeURIComponent(value || "") + expires + "; path=/; SameSite=Strict";
        }

        function getCookie(name) {
          const nameEQ = name + "=";
          const ca = document.cookie.split(';');
          for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
          }
          return null;
        }

        // UUID ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
        function isValidUUID(uuid) {
          if (!uuid) return false;
          // ê¸°ë³¸ì ì¸ UUID í˜•ì‹ ê²€ì‚¬
          const regex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
          return regex.test(uuid.trim());
        }

        // ëª¨ë“  ì €ì¥ì†Œì— ë°ì´í„° ì €ì¥
        async function saveUserData(key, value) {
          const stringValue = typeof value === 'string' ? value : JSON.stringify(value);
          
          try {
            // 1. localStorageì— ì €ì¥
            localStorage.setItem(key, stringValue);
            
            // 2. ì¿ í‚¤ì— ì €ì¥ (30ì¼)
            setCookie(key, stringValue, 30);
            
            // 3. IndexedDBì— ì €ì¥
            await saveToIndexedDB(key, stringValue);
            
            console.log(`${key} ë°ì´í„° ëª¨ë“  ì €ì¥ì†Œì— ì €ì¥ ì™„ë£Œ`);
            return true;
          } catch (error) {
            console.error(`${key} ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:`, error);
            return false;
          }
        }

        // ëª¨ë“  ì €ì¥ì†Œì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìš°ì„ ìˆœìœ„: IndexedDB > localStorage > cookies)
        async function getUserData(key) {
          try {
            // 1. IndexedDBì—ì„œ ì‹œë„
            try {
              const indexedDBValue = await getFromIndexedDB(key);
              if (indexedDBValue) {
                console.log(`IndexedDBì—ì„œ ${key} ë³µêµ¬ ì„±ê³µ`);
                // ë‹¤ë¥¸ ì €ì¥ì†Œì—ë„ ë³µì‚¬
                localStorage.setItem(key, indexedDBValue);
                setCookie(key, indexedDBValue, 30);
                return indexedDBValue;
              }
            } catch (error) {
              console.warn('IndexedDB ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
            
            // 2. localStorageì—ì„œ ì‹œë„
            const localValue = localStorage.getItem(key);
            if (localValue) {
              console.log(`localStorageì—ì„œ ${key} ë³µêµ¬ ì„±ê³µ`);
              // ë‹¤ë¥¸ ì €ì¥ì†Œì— ë³µì‚¬
              setCookie(key, localValue, 30);
              try {
                await saveToIndexedDB(key, localValue);
              } catch (error) {
                console.warn('IndexedDB ì €ì¥ ì‹¤íŒ¨:', error);
              }
              return localValue;
            }
            
            // 3. ì¿ í‚¤ì—ì„œ ì‹œë„
            const cookieValue = getCookie(key);
            if (cookieValue) {
              console.log(`ì¿ í‚¤ì—ì„œ ${key} ë³µêµ¬ ì„±ê³µ`);
              // ë‹¤ë¥¸ ì €ì¥ì†Œì— ë³µì‚¬
              localStorage.setItem(key, cookieValue);
              try {
                await saveToIndexedDB(key, cookieValue);
              } catch (error) {
                console.warn('IndexedDB ì €ì¥ ì‹¤íŒ¨:', error);
              }
              return cookieValue;
            }
            
            console.log(`${key} ë°ì´í„° ëª¨ë“  ì €ì¥ì†Œì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            return null;
          } catch (error) {
            console.error(`${key} ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:`, error);
            return null;
          }
        }

        // UUID ê°€ì ¸ì˜¤ê¸°
        async function getMyUUID() {
          try {
            const uuid = await getUserData('myUUID');
            if (isValidUUID(uuid)) {
              return uuid;
            }
            return null;
          } catch (error) {
            console.error('UUID ì¡°íšŒ ì‹¤íŒ¨:', error);
            return null;
          }
        }

        // ì¹œêµ¬ UUID ê°€ì ¸ì˜¤ê¸°
        async function getLastFriendUUID() {
          try {
            return await getUserData('lastFriendUUID');
          } catch (error) {
            console.error('ì¹œêµ¬ UUID ì¡°íšŒ ì‹¤íŒ¨:', error);
            return null;
          }
        }

        // ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function getUserDataObj() {
          try {
            const userData = await getUserData('userData');
            if (userData) {
              try {
                return JSON.parse(userData);
              } catch (error) {
                console.error('userData íŒŒì‹± ì‹¤íŒ¨', error);
                return userData; // ì´ë¯¸ ê°ì²´ì¼ ìˆ˜ë„ ìˆìŒ
              }
            }
            return {};
          } catch (error) {
            console.error('ì‚¬ìš©ì ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', error);
            return {};
          }
        }

        // UUID í™•ë³´/ìƒì„± í•¨ìˆ˜
        async function ensureMyUUID() {
          try {
            // ì €ì¥ì†Œì—ì„œ UUID ì¡°íšŒ
            let uuid = await getMyUUID();
            if (uuid) {
              console.log('ê¸°ì¡´ UUID ì‚¬ìš©:', uuid);
              return uuid;
            }
            
            // ìƒˆ UUID ë°œê¸‰
            console.log('ìƒˆ UUID ë°œê¸‰ ìš”ì²­');
            const response = await fetch('https://pocali-backend.onrender.com/api/register', {
              method: 'POST'
            });
            
            if (!response.ok) {
              throw new Error('UUID ë°œê¸‰ ì‹¤íŒ¨');
            }
            
            const data = await response.json();
            uuid = data.user_id;
            
            if (!isValidUUID(uuid)) {
              throw new Error('ì„œë²„ì—ì„œ ìœ íš¨í•˜ì§€ ì•Šì€ UUID ë°˜í™˜');
            }
            
            // ëª¨ë“  ì €ì¥ì†Œì— ì €ì¥
            await saveUserData('myUUID', uuid);
            await saveUserData('userData', JSON.stringify({}));
            
            console.log('ìƒˆ UUID ë°œê¸‰ ë° ì €ì¥ ì™„ë£Œ:', uuid);
            return uuid;
          } catch (error) {
            console.error('UUID ë°œê¸‰ ì˜¤ë¥˜:', error);
            alert('ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
            return null;
          }
        }

        // UUID ê²€ì¦ ë° ë³µêµ¬
        async function validateUserID() {
          try {
            // ì €ì¥ì†Œì—ì„œ UUID ì¡°íšŒ
            const uuid = await getMyUUID();
            
            // UUIDê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì´ˆê¸°í™”
            if (!uuid) {
              console.log('ìœ íš¨í•œ UUID ì—†ìŒ, ìƒˆë¡œ ë°œê¸‰');
              return await ensureMyUUID();
            }
            
            // userData í™•ì¸
            let userData = await getUserDataObj();
            if (Object.keys(userData).length === 0) {
              console.log('userData ëˆ„ë½, ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°');
              try {
                const response = await fetch(`https://pocali-backend.onrender.com/api/user/${uuid}`);
                if (response.ok) {
                  const data = await response.json();
                  
                  if (data.data) {
                    // ë°ì´í„° í˜•ì‹ì— ë”°ë¼ ì ì ˆíˆ ì²˜ë¦¬
                    let processedData;
                    if (typeof data.data === 'string') {
                      try {
                        processedData = JSON.parse(data.data);
                      } catch {
                        processedData = data.data;
                      }
                    } else {
                      processedData = data.data;
                    }
                    
                    // ëª¨ë“  ì €ì¥ì†Œì— ì €ì¥
                    await saveUserData('userData', JSON.stringify(processedData));
                  }
                }
              } catch (error) {
                console.error('ì„œë²„ì—ì„œ userData ì¡°íšŒ ì‹¤íŒ¨:', error);
              }
            }
            
            return uuid;
          } catch (error) {
            console.error('UUID ê²€ì¦ ì˜¤ë¥˜:', error);
            return await ensureMyUUID();
          }
        }

        // ë¡œì»¬ ë°ì´í„°ë¥¼ ì„œë²„ì— ë™ê¸°í™”
        async function syncLocalDataToServer() {
          try {
            const uuid = await getMyUUID();
            if (!uuid || viewOwner !== 'self') return;
            
            const userData = await getUserDataObj();
            
            // ì„œë²„ì— ë°ì´í„° ì €ì¥
            const response = await fetch(`https://pocali-backend.onrender.com/api/user/${uuid}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: userData })
            });
            
            if (response.ok) {
              console.log('ì„œë²„ ë™ê¸°í™” ì„±ê³µ');
            } else {
              console.error('ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨');
            }
          } catch (error) {
            console.error('ì„œë²„ ë™ê¸°í™” ì˜¤ë¥˜:', error);
          }
        }

        // load-other-data í•¸ë“¤ëŸ¬ ì„¸íŒ…
        function setupLoadOtherDataHandler() {
          $('#load-other-data')?.addEventListener('click', async () => {
            const other = $('#other-uuid').value.trim();
            if (!isValidUUID(other)) {
              return alert('ìœ íš¨í•œ UUIDë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            }
            
            try {
              const response = await fetch(`https://pocali-backend.onrender.com/api/user/${other}`);
              if (!response.ok) {
                return alert('í•´ë‹¹ UUIDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              }
              
              const json = await response.json();
              let userDataObj;
              
              // ë°ì´í„° í˜•ì‹ ì²˜ë¦¬
              if (typeof json.data === 'string') {
                try {
                  userDataObj = JSON.parse(json.data);
                } catch {
                  userDataObj = json.data;
                }
              } else {
                userDataObj = json.data || {};
              }
              
              // ëª¨ë“  ì €ì¥ì†Œì— ì €ì¥
              await saveUserData('myUUID', other);
              await saveUserData('userData', JSON.stringify(userDataObj));
              
              location.reload();
            } catch (error) {
              console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
              alert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          });
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          0. ì „ì—­ ìƒíƒœ ë° ë„ìš°ë¯¸
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        // â”€â”€â”€ í˜ì´ì§•ìš© ì „ì—­ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const BATCH_SIZE   = 100;      // í•œ ë²ˆì— ë¡œë“œí•  ì¹´ë“œ ê°œìˆ˜
        let backupAllImages = [];      // allImages ì›ë³¸ ë°±ì—…ìš©
        let allImages      = [];       // ì „ì²´ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì €ì¥
        let currentBatch   = 0;        // ë Œë”ëœ ë°°ì¹˜ ì¸ë±ìŠ¤
        let isRendering    = false;    // ì¤‘ë³µ ë Œë”ë§ ë°©ì§€ í”Œë˜ê·¸
        let totalCount     = 0;        // â† ì „ì²´ ê°œìˆ˜ í—¤ë”ì—ì„œ ì½ì–´ ì €ì¥
        let currentView    = 'id';     // 'id'  | 'category'
        let viewOwner      = 'self';   // 'self'| 'friend'
        let currentFriendUUID = null;  // ì´ˆê¸°í™”: DOMContentLoadedì—ì„œ ì„¤ì •ë¨
        let userData       = {};       // í˜„ì¬ ë³´ì—¬ì§€ëŠ” ë°ì´í„° (ë‚´ ê²ƒ ë˜ëŠ” ì¹œêµ¬ ê²ƒ)

        const advancedFilters = { groups: [], members: [] };

        /* ì§§ì€ ì…€ë ‰í„° ë„ìš°ë¯¸ */
        function $(sel,  scope=document) { return scope.querySelector(sel); }
        function $$(sel, scope=document) { return Array.from(scope.querySelectorAll(sel)); }

        /* â”€â”€ ê³µí†µ: ì´ë¯¸ì§€ ìƒì„¸ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function showModal(img) {
          const $modal      = $('#photo-modal');
          const $modalImg   = $('#modal-image');
          const $modalInfo  = $('#modal-info');

          $modalImg.src = img.src;

          $modalInfo.innerHTML = `
            <p>${img.dataset.group   || ''}</p>
            <p>${img.dataset.member  || ''}</p>
            <p>${img.dataset.category || ''} ${img.dataset.title || ''}</p>
            <p>${img.dataset.version || ''}</p>
            <p>#${img.dataset.unique}</p>
          `;

          $modal.style.display = 'block';
        }

        // ì•± ì´ˆê¸°í™” ì‹œ ì‹¤í–‰í•  í•¨ìˆ˜
        async function initApp() {
          try {
            // IndexedDB ì´ˆê¸°í™”
            await initIndexedDB();
            
            // ì¹œêµ¬ UUID ë³µêµ¬
            const friendUUID = await getLastFriendUUID();
            if (friendUUID) {
              currentFriendUUID = friendUUID;
              console.log('ë³µêµ¬ëœ ì¹œêµ¬ UUID:', currentFriendUUID);
            }
            
            // UUID ê²€ì¦ ë° ë³µêµ¬
            const uuid = await validateUserID();
            console.log('ê²€ì¦ëœ UUID:', uuid);
            
            if (uuid) {
              // userData ë¡œë“œ
              const userDataObj = await getUserDataObj();
              userData = userDataObj;
            }
            
            // load-other-data í•¸ë“¤ëŸ¬ ì„¤ì •
            setupLoadOtherDataHandler();
          } catch (error) {
            console.error('ì•± ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
          }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          1. ì´ˆê¸°í™” ë° ë©”ì¸ ê¸°ëŠ¥ë“¤
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        document.addEventListener('DOMContentLoaded', () => {
          // ì•± ì´ˆê¸°í™”
          initApp();
          
          // â”€â”€ export-modal ë‹«ê¸° í•¸ë“¤ëŸ¬
          const $exportModal      = document.getElementById('export-modal');
          const $exportModalClose = document.getElementById('export-modal-close');
          
          $exportModalClose.addEventListener('click', () => {
            $exportModal.style.display = 'none';
          });
          
          $exportModal.addEventListener('click', e => {
            if (e.target === $exportModal) {
              $exportModal.style.display = 'none';
            }
          });
          
          const LONG_PRESS     = 500;
          const TAP_THRESHOLD  = 200;
          const MOVE_THRESHOLD = 10;

          const $grid          = $('#photo-grid');
          const $viewToggleBtn = $('#view-toggle');
          const $catToggleBtn  = $('#categoryToggleBtn');
          const $searchInput   = $('#search-input');

          // ë Œë”ë§ í›„ì— ê°’ì„ ì±„ìš¸ ë³€ìˆ˜ë“¤
          let originalCards = [];
          let photoCards    = [];

          // âœ… toggleCheck í•¨ìˆ˜: ì²´í¬ ìƒíƒœ ë³€ê²½
          function toggleCheck(img) {
            if (viewOwner !== 'self') return; // ì¹œêµ¬ ë±ì—ì„œëŠ” ìˆ˜ì • ë¶ˆê°€
            
            img.classList.toggle('checked');
            
            // userData ì—…ë°ì´íŠ¸
            userData[img.dataset.unique] = img.classList.contains('checked');
            
            // ëª¨ë“  ì €ì¥ì†Œì— ì €ì¥
            saveUserData('userData', userData);
            
            // ì„œë²„ ë™ê¸°í™”
            syncLocalDataToServer();
            updateCount();
          }

          async function fetchAndRenderImages() {
            const resp = await fetch('https://pocali-backend.onrender.com/api/images');
            allImages     = await resp.json();
            backupAllImages = allImages.slice();
            totalCount    = allImages.length;
            currentBatch = 0;
            $grid.innerHTML = '';
            renderNextBatch();
          }

          // âœ… ë± ì „í™˜ ê¸°ëŠ¥ ìˆ˜ì •
          /** ë‚´ ë³´ìœ  ì¹´ë“œ í‘œì‹œ */
          async function loadSelfDeck() {
            // ìµœì‹  userData ê°€ì ¸ì˜¤ê¸°
            const myData = await getUserDataObj();
            userData = myData;
            
            photoCards.forEach(img => {
              img.classList.toggle('checked', !!myData[img.dataset.unique]);
              img.style.pointerEvents = ''; // ë”ë¸”í´ë¦­ í—ˆìš©
            });

            viewOwner = 'self';
            $viewToggleBtn.textContent = 'ğŸ‘¥ ì¹œêµ¬ë³´ê¸°';
            updateCount();
          }

          /** ì¹œêµ¬ ë³´ìœ  ì¹´ë“œ í‘œì‹œ */
          async function loadFriendDeck(uuid) {
            try {
              const res = await fetch(`https://pocali-backend.onrender.com/api/friend/${uuid}/collection`);
              if (!res.ok) {
                alert('ì¹œêµ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return false;
              }

              const friendData = (await res.json()).data || {};
              userData = friendData; // í˜„ì¬ ë³´ì—¬ì§€ëŠ” ë°ì´í„°ë¥¼ ì¹œêµ¬ ë°ì´í„°ë¡œ ì„¤ì •
              
              photoCards.forEach(img => {
                img.classList.toggle('checked', !!friendData[img.dataset.unique]);
                img.style.pointerEvents = 'none'; // ìˆ˜ì • ê¸ˆì§€
              });

              viewOwner = 'friend';
              currentFriendUUID = uuid;
              // ëª¨ë“  ì €ì¥ì†Œì— ì¹œêµ¬ UUID ì €ì¥
              await saveUserData('lastFriendUUID', uuid);
              
              $viewToggleBtn.textContent = 'ğŸ‘¤ ë‚´ ì¹´ë“œë³´ê¸°';
              updateCount();
              return true;
            } catch (error) {
              console.error('ì¹œêµ¬ ë± ë¡œë“œ ì‹¤íŒ¨:', error);
              alert('ì¹œêµ¬ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              return false;
            }
          }

          /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            2. ê³µí†µ ìœ í‹¸
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
          /** í˜„ì¬ í™”ë©´ì˜ ì´ ì¹´ë“œìˆ˜ / ë³´ìœ ì¹´ë“œìˆ˜ í‘œì‹œ */
          function updateCount() {
            // í˜„ì¬ ë³´ì—¬ì§€ëŠ” userDataë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const have = Object.values(userData).filter(v => v).length;
            document.getElementById('count-display').textContent = `${have} / ${totalCount}`;
          }

          /** ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ë¦¬ë“œì— ê·¸ëŒ€ë¡œ ë Œë”ë§ */
          function render(cards) {
            $grid.innerHTML = '';
            cards.forEach(c => $grid.appendChild(c));
            updateCount();
          }

          /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            3. ë·° ê·¸ë¦¬ê¸°(ì •ë ¬) í•¨ìˆ˜
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
          /** ê³ ìœ ë²ˆí˜¸(ID) ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ë·° */
          function showById(list = null) {
            const cards = (list ?? originalCards).slice();
            cards.sort((a, b) =>
              $('.photo-card', b).dataset.unique -
              $('.photo-card', a).dataset.unique
            );
            render(cards);
          }

          /** ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹ + ì œëª© + ë²„ì „ í—¤ë” ë·° */
          function showByCategory() {
            const query = ($searchInput.value || '').toLowerCase();
            
            const filtered = originalCards.filter(div => {
              const img = $('.photo-card', div);
              const alt = img.alt.toLowerCase();
              const group = img.dataset.group.toLowerCase();
              const member = img.dataset.member.toLowerCase();

              const textOK = !query || alt.includes(query);
              const groupOK = !advancedFilters.groups.length ||
                            advancedFilters.groups.includes(group.toUpperCase());
              const memberOK = !advancedFilters.members.length ||
                              advancedFilters.members.some(v => member.includes(v.toLowerCase()));

              return textOK && groupOK && memberOK;
            });

            const buckets = {};
            filtered.forEach(div => {
              const img = $('.photo-card', div);
              const key = [
                img.dataset.category || 'ë¯¸ë¶„ë¥˜',
                img.dataset.title || '',
                img.dataset.version || ''
              ].filter(Boolean).join(' | ');
              (buckets[key] = buckets[key] || []).push(div);
            });

            $grid.innerHTML = '';
            Object.entries(buckets)
              .sort(([,a],[,b]) =>
                +$('.photo-card', b[0]).dataset.unique -
                +$('.photo-card', a[0]).dataset.unique
              )
              .forEach(([header, cards]) => {
                const h2 = document.createElement('h2');
                h2.textContent = header;
                h2.style.margin = '16px 0 8px';
                $grid.appendChild(h2);

                cards.sort((a, b) =>
                  +$('.photo-card', b).dataset.unique -
                  +$('.photo-card', a).dataset.unique
                ).forEach(div => $grid.appendChild(div));
              });

            updateCount();
          }

          /** í˜„ì¬ í•„í„°/ë·° ìƒíƒœë¡œ ë‹¤ì‹œ ê·¸ë¦¬ê¸° */
          function applyFilters() {
            if (currentView === 'category') {
              showByCategory();
            } else {
              showById();
            }
          }

          // â”€â”€â”€ í˜ì´ì§•ë³„ ë Œë”ë§ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          function renderNextBatch() {
            if (isRendering) return;
            
            const start = currentBatch * BATCH_SIZE;
            const end = start + BATCH_SIZE;
            const slice = allImages.slice(start, end);
            
            // ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
            if (slice.length === 0) {
              isRendering = false;
              return;
            }
            
            isRendering = true;

            slice.forEach(image => {
              // 1) ì¹´ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
              const container = document.createElement('div');
              container.className = 'photo-card-container';

              // 2) <img> ìš”ì†Œ ìƒì„±
              const img = document.createElement('img');
              img.className = 'photo-card';
              // Firebase Storage URLì€ í•­ìƒ httpë¡œ ì‹œì‘í•˜ë¯€ë¡œ í•­ìƒ ì›ë³¸ URL ì‚¬ìš©
              img.src = image.url;
              img.loading = 'lazy';
              img.alt = `${image.group} ${image.member} ${image.category} ${image.title} #${image.unique_id}`;
              img.dataset.group = image.group;
              img.dataset.member = image.member;
              img.dataset.category = image.category;
              img.dataset.title = image.title;
              img.dataset.version = image.version;
              img.dataset.unique = image.unique_id;

              // â”€â”€ í˜„ì¬ userDataì— ë”°ë¥¸ ì²´í¬ ì •ë³´ ì ìš©
              if (userData[image.unique_id]) {
                img.classList.add('checked');
              }

              // í¬ì¸í„° ì´ë²¤íŠ¸ ì„¤ì •
              img.style.pointerEvents = viewOwner === 'self' ? '' : 'none';

              // 3) ì˜¤ë²„ë ˆì´: í•˜ìœ„ í´ë”ëª… í‘œì‹œ
              const overlay = document.createElement('div');
              overlay.className = 'image-overlay';

              // Firebase Storage ê²½ë¡œì—ì„œ í´ë” ì´ë¦„ ì¶”ì¶œ
              let displayType = '';
              if (image.url && image.url.includes('/')) {
                // URLì—ì„œ í´ë” êµ¬ì¡° ì¶”ì¶œ ì‹œë„
                const urlParts = image.url.split('/');
                // URLì—ì„œ í´ë” ì´ë¦„ ì°¾ê¸° (ì¼ë°˜ì ìœ¼ë¡œ o/<í´ë”ëª…>/ íŒ¨í„´)
                for (let i = 0; i < urlParts.length; i++) {
                  if (urlParts[i] === 'o' && i+1 < urlParts.length) {
                    displayType = urlParts[i+1];
                    break;
                  }
                }
                
                // URLì—ì„œ ì°¾ì§€ ëª»í–ˆë‹¤ë©´ file_type ë¶„ì„
                if (!displayType && image.file_type) {
                  const typeParts = image.file_type.split('/');
                  displayType = typeParts.length > 1 ? typeParts[1] : '';
                }
              } else {
                // ê¸°ì¡´ ë°©ì‹ ìœ ì§€
                displayType = image.category || image.type || '';
              }

              overlay.textContent = displayType;
              container.appendChild(overlay);

              // 4) í„°ì¹˜Â·ë¡±í”„ë ˆìŠ¤ & ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
              let startX, startY;
              let moved = false;
              let startTime, pressTimer;
              
              img.addEventListener('pointerdown', e => {
                if (viewOwner !== 'self') return;
                
                // ì‹œì‘ ìœ„ì¹˜ ê¸°ë¡
                startX = e.clientX;
                startY = e.clientY;
                moved = false;
                
                startTime = performance.now();
                pressTimer = setTimeout(() => showModal(img), LONG_PRESS);
              });

              img.addEventListener('pointermove', e => {
                if (!startX || !startY) return;
                
                // ì›€ì§ì¸ ê±°ë¦¬ ê³„ì‚°
                const deltaX = Math.abs(e.clientX - startX);
                const deltaY = Math.abs(e.clientY - startY);
                
                // ì¼ì • ê±°ë¦¬ ì´ìƒ ì›€ì§ì˜€ìœ¼ë©´ ìŠ¤í¬ë¡¤ë¡œ ê°„ì£¼
                if (deltaX > MOVE_THRESHOLD || deltaY > MOVE_THRESHOLD) {
                  moved = true;
                  clearTimeout(pressTimer); // ë¡±í”„ë ˆìŠ¤ íƒ€ì´ë¨¸ ì·¨ì†Œ
                }
              });

              img.addEventListener('pointerup', e => {
                clearTimeout(pressTimer);
                
                // ìŠ¤í¬ë¡¤ì´ ì•„ë‹Œ ì§§ì€ íƒ­ì¸ ê²½ìš°ì—ë§Œ í† ê¸€
                if (!moved && (performance.now() - startTime < TAP_THRESHOLD)) {
                  toggleCheck(img);
                }
                
                // ë³€ìˆ˜ ì´ˆê¸°í™”
                startX = startY = null;
                moved = false;
              });

              img.addEventListener('pointerleave', () => {
                clearTimeout(pressTimer);
                startX = startY = null;
                moved = false;
              });

              img.addEventListener('dblclick', () => {
                if (viewOwner !== 'self') return;
                toggleCheck(img);
              });

              img.addEventListener('contextmenu', e => {
                e.preventDefault();
                showModal(img);
              });

              // 5) ê·¸ë¦¬ë“œì— ì¶”ê°€
              container.appendChild(img);
              $grid.appendChild(container);
            });
            
            // â€” ìºì‹œ ê°±ì‹ 
            originalCards = Array.from($grid.querySelectorAll('.photo-card-container'));
            photoCards = Array.from($grid.querySelectorAll('.photo-card'));

            // â€” ìƒíƒœ ê°±ì‹ 
            currentBatch++;
            updateCount();

            isRendering = false; 
          }

          // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (10ì´ˆë§ˆë‹¤ í´ë§)
          async function pollServerData() {
            if (viewOwner !== 'self') return;
            
            const me = await getMyUUID();
            if (!me) return;
            
            try {
              const r = await fetch(`https://pocali-backend.onrender.com/api/user/${me}`);
              if (!r.ok) return;
              
              const data = await r.json();
              let serverData;
              
              // ë°ì´í„° í˜•ì‹ ì²˜ë¦¬
              if (typeof data.data === 'string') {
                try {
                  serverData = JSON.parse(data.data);
                } catch {
                  serverData = data.data || {};
                }
              } else {
                serverData = data.data || {};
              }
              
              userData = serverData;
              
              // ëª¨ë“  ì €ì¥ì†Œì— ì €ì¥
              await saveUserData('userData', serverData);
              
              photoCards.forEach(img =>
                img.classList.toggle('checked', !!serverData[img.dataset.unique]));
              updateCount();
            } catch (error) {
              console.error('ì„œë²„ ë°ì´í„° í´ë§ ì‹¤íŒ¨:', error);
            }
          }
          
          // ì¼ì • ê°„ê²©ìœ¼ë¡œ ì„œë²„ ë°ì´í„° í´ë§
          setInterval(pollServerData, 10000);

          /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            5. UI ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
          // âœ… ë·° í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ (ì¤‘ë³µ ì œê±°) - ë‹¨ í•œ ë²ˆë§Œ ë“±ë¡
          $viewToggleBtn.addEventListener('click', async () => {
            if (viewOwner === 'friend') {
              await loadSelfDeck();
            } else {
              if (currentFriendUUID) {
                await loadFriendDeck(currentFriendUUID);
              } else {
                alert('ë¨¼ì € ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!');
              }
            }
          });

          // ì¹´í…Œê³ ë¦¬/ID ì „í™˜ ë²„íŠ¼
          $catToggleBtn.addEventListener('click', () => {
            currentView = currentView === 'id' ? 'category' : 'id';
            $catToggleBtn.textContent = currentView === 'id' ? 'ğŸ·ï¸' : 'ğŸ”¢';
            $catToggleBtn.title = currentView === 'id'
                                ? 'ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°'
                                : 'ê³ ìœ ë²ˆí˜¸ ìˆœ ë³´ê¸°';
            applyFilters();
          });

          // âœ… ê²€ìƒ‰ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
          $searchInput.addEventListener('input', e => {
            const q = e.target.value.trim().toLowerCase();
            if (!q) {
              allImages = backupAllImages.slice();
            } else {
              allImages = backupAllImages.filter(meta =>
                (`${meta.group} ${meta.member} ${meta.category} ${meta.title}`)
                  .toLowerCase().includes(q)
              );
            }
            // í˜ì´ì§• ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ë Œë”
            currentBatch = 0;
            isRendering = false;
            $grid.innerHTML = '';
            renderNextBatch();
            // ì²« ë°°ì¹˜ ë Œë”ë§ í›„ í˜„ì¬ ë·° ì ìš©
            setTimeout(() => applyFilters(), 100);
          });

          // â”€â”€â”€ ë¬´í•œ ìŠ¤í¬ë¡¤ íŠ¸ë¦¬ê±° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          window.addEventListener('scroll', () => {
            // ì´ë¯¸ ë Œë”ë§ ì¤‘ì´ê±°ë‚˜ ë” ì´ìƒ ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
            if (isRendering || currentBatch * BATCH_SIZE >= allImages.length) {
              return;
            }
            
            const nearBottom = window.innerHeight + window.scrollY
                            >= document.body.offsetHeight - 500;
            
            if (nearBottom) {
              renderNextBatch();
              // ë°°ì¹˜ ë Œë”ë§ í›„ í˜„ì¬ ë·° ì ìš©
              setTimeout(() => applyFilters(), 100);
            }
          });

          // FAB ë° ëª¨ë‹¬ë“¤
          const $fab = $('#fab');
          const $userModal = $('#user-modal');
          const $userModalClose = $('#user-modal-close');
          const $addFriendBtn = $('#add-friend');
          const $friendModal = $('#friend-modal');
          const $friendClose = $('#friend-modal-close');
          const $friendConfirm = $('#friend-add-confirm');
          const $resetBtn = $('#reset-checks');
          const $exportBtn = $('#export-sheet');
          const $userDataModal = $('#user-data-modal');
          const $userDataModalClose = $('#user-data-modal-close');

          $userDataModalClose.addEventListener('click', () => $userDataModal.style.display = 'none');
          $userDataModal.addEventListener('click', e => {
            if (e.target === $userDataModal) $userDataModal.style.display = 'none';
          });

          // ìƒì„¸ ê²€ìƒ‰ ëª¨ë‹¬
          const detailBtn = document.getElementById('search-detail-btn');
          const detailModal = document.getElementById('detail-search-modal');
          const detailForm = document.getElementById('detail-search-form');

          detailBtn.addEventListener('click', () => detailModal.style.display = 'block');
          detailModal.querySelector('.close').addEventListener('click', () => detailModal.style.display = 'none');
          detailModal.addEventListener('click', e => { 
            if (e.target === detailModal) detailModal.style.display = 'none'; 
          });

          detailForm.addEventListener('submit', e => {
            e.preventDefault();
            const fd = new FormData(detailForm);
            const groups = fd.getAll('group');
            const members = fd.getAll('member');
            
            if (!groups.length && !members.length) {
              allImages = backupAllImages.slice();
            } else {
              allImages = backupAllImages.filter(meta =>
                (groups.length === 0 || groups.includes(meta.group)) &&
                (members.length === 0 || members.includes(meta.member))
              );
            }
            
            currentBatch = 0;
            isRendering = false;
            $grid.innerHTML = '';
            renderNextBatch();
            setTimeout(() => applyFilters(), 100);
            detailModal.style.display = 'none';
          });

          // Export form
          const $exportForm = document.getElementById('export-form');
          $exportForm.addEventListener('submit', e => {
            e.preventDefault();
            const fd = new FormData($exportForm);
            const group = fd.get('group');
            const members = fd.getAll('member');

            const sel = backupAllImages.filter(meta =>
              meta.group === group &&
              (members.length === 0 || members.includes(meta.member))
            );
            
            if (!sel.length) {
              return alert('ì„ íƒí•˜ì‹  ì¡°ê±´ì— ë§ëŠ” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const nodes = sel.map(meta => {
              const img = document.createElement('img');
              img.className = 'photo-card';
              img.crossOrigin = 'anonymous';
              img.src = meta.url;
              img.alt = `${meta.group} ${meta.member} ${meta.category} ${meta.title}`;
              img.dataset.unique = meta.unique_id;
              img.dataset.group = meta.group;
              img.dataset.member = meta.member;
              img.dataset.category = meta.category;
              img.dataset.title = meta.title;
              img.dataset.version = meta.version;
              
              // í˜„ì¬ ë³´ì—¬ì§€ëŠ” ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ì²´í¬ ìƒíƒœ ì„¤ì •
              if (userData[meta.unique_id]) img.classList.add('checked');
              return img;
            });
            
            $exportModal.style.display = 'none';
            generateImageSheet(nodes);
          });

          // ìœ ì € ë°ì´í„° ëª¨ë‹¬
          const $loadUserBtn = $('#load-user-data');
          $loadUserBtn?.addEventListener('click', async () => {
            $userModal.style.display = 'none';
            const me = await getMyUUID() || await ensureMyUUID();
            $('#my-uuid').value = me;
            $('#other-uuid').value = '';
            $('#uuid-msg').textContent = '';
            $('#user-data-modal').style.display = 'block';
          });

          // FAB ëª¨ë‹¬
          $fab.addEventListener('click', () => $userModal.style.display = 'block');
          $userModalClose.addEventListener('click', () => $userModal.style.display = 'none');
          $userModal.addEventListener('click', e => {
            if (e.target === $userModal) $userModal.style.display = 'none';
          });

          // ì¹œêµ¬ ì¶”ê°€
          $addFriendBtn.addEventListener('click', () => {
            $userModal.style.display = 'none';
            $friendModal.style.display = 'block';
          });
          
          $friendClose.addEventListener('click', () => $friendModal.style.display = 'none');
          
          $friendModal.addEventListener('click', e => { 
            if (e.target === $friendModal) $friendModal.style.display = 'none'; 
          });

          $friendConfirm.addEventListener('click', async () => {
            const me = await getMyUUID();
            const friend = $('#friend-uuid').value.trim();
            
            if (!me || !friend) { 
              alert('UUIDë¥¼ ì…ë ¥í•˜ì„¸ìš”!'); 
              return; 
            }

            try {
              const response = await fetch('https://pocali-backend.onrender.com/api/friends', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ me, friend })
              });
              
              if (!response.ok) {
                return alert('ë“±ë¡ ì‹¤íŒ¨');
              }
              
              // ëª¨ë“  ì €ì¥ì†Œì— ì¹œêµ¬ UUID ì €ì¥
              await saveUserData('lastFriendUUID', friend);
              
              $friendModal.style.display = 'none';
              await loadFriendDeck(friend);
              alert('ì¹œêµ¬ ë“±ë¡ ì™„ë£Œ!');
            } catch (error) {
              console.error('ì¹œêµ¬ ë“±ë¡ ì˜¤ë¥˜:', error);
              alert('ì¹œêµ¬ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          });

          // ì²´í¬ ìƒíƒœ ì´ˆê¸°í™”
          $resetBtn.addEventListener('click', async () => {
            if (!confirm('ëª¨ë“  ì²´í¬ë¥¼ í•´ì œí• ê¹Œìš”?')) return;

            // í™”ë©´ ì´ˆê¸°í™”
            $$('.photo-card').forEach(img => img.classList.remove('checked'));
            
            // ë°ì´í„° ì´ˆê¸°í™”
            userData = {}; 
            
            // ëª¨ë“  ì €ì¥ì†Œì— ë¹ˆ ë°ì´í„° ì €ì¥
            await saveUserData('userData', {});
            
            // ì„œë²„ì—ë„ ë¹ˆ ë°ì´í„° ì—…ë¡œë“œ
            const me = await getMyUUID();
            if (me) {
              await fetch(`https://pocali-backend.onrender.com/api/user/${me}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: {} })
              });
            }
            
            updateCount();
          });

          // ì‹œíŠ¸ ëª¨ë‹¬ ì—´ê¸°
          $exportBtn.addEventListener('click', () => {
            $('#user-modal').style.display = 'none';
            $('#export-modal').style.display = 'block';
          });

          // ì‹œíŠ¸ ìƒì„± í•¨ìˆ˜
          function generateImageSheet(nodes) {
            // â‘  ì˜¤ë²„ë ˆì´ ìƒì„±
            const overlay = document.createElement('div');
            overlay.id = 'sheet-overlay';
            overlay.style.cssText = `
              position:fixed; inset:0; background:#fff; overflow:auto;
              z-index:10000; padding:20px; overscroll-behavior:contain;
            `;
            document.body.appendChild(overlay);

            // â‘¡ ì‹œíŠ¸ ì „ìš© ê·¸ë¦¬ë“œ
            const sheetGrid = document.createElement('div');
            sheetGrid.id = 'sheet-grid';
            sheetGrid.style.cssText = `
              display: grid;
              grid-template-columns: repeat(20, 100px);
              grid-auto-rows: auto;
              gap: 12px;
              padding: 20px;
              width: fit-content;
            `;
            overlay.appendChild(sheetGrid);

            // â‘¢ ë‹«ê¸°/ì €ì¥ ë²„íŠ¼
            const btnBar = document.createElement('div');
            btnBar.style.cssText = 'position:fixed;top:10px;right:10px;display:flex;gap:8px;z-index:10001;';
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'ë‹«ê¸°';
            closeBtn.onclick = () => overlay.remove();
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'ì €ì¥';
            saveBtn.onclick = async () => {
              try {
                // ìƒíƒœ í‘œì‹œ
                const status = document.createElement('div');
                status.textContent = "ì´ë¯¸ì§€ ìƒì„± ì¤‘...";
                status.style.cssText = 'position:fixed; bottom:20px; left:20px; background:rgba(0,0,0,0.7); color:white; padding:10px; border-radius:5px; z-index:10002;';
                overlay.appendChild(status);
                
                // ëª¨ë“  ì´ë¯¸ì§€ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                const images = Array.from(sheetGrid.querySelectorAll('img'));
                await Promise.all(images.map(img => {
                  // ì´ë¯¸ ë¡œë“œëœ ì´ë¯¸ì§€ëŠ” ì¦‰ì‹œ í•´ê²°
                  if (img.complete) return Promise.resolve();
                  // ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ì´ë¯¸ì§€ëŠ” ë¡œë“œ ì´ë²¤íŠ¸ ê¸°ë‹¤ë¦¼
                  return new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve; // ì—ëŸ¬ê°€ ë‚˜ë„ ì§„í–‰
                  });
                }));
                
                console.log('ëª¨ë“  ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ, html2canvas ì‹œì‘');
                status.textContent = "ìº”ë²„ìŠ¤ ìƒì„± ì¤‘...";
                
                const canvas = await html2canvas(sheetGrid, {
                  scale: 2,
                  backgroundColor: '#fff',
                  useCORS: true,
                  allowTaint: true,
                  logging: true, // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
                  onclone: (clonedDoc) => {
                    // ë³µì œëœ DOMì˜ ëª¨ë“  ì´ë¯¸ì§€ì— crossOrigin ì„¤ì •
                    const clonedImages = clonedDoc.querySelectorAll('img');
                    clonedImages.forEach(img => {
                      img.crossOrigin = 'anonymous';
                      // ë¶ˆíˆ¬ëª…ë„ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
                    });
                  }
                });
                
                console.log('ìº”ë²„ìŠ¤ í¬ê¸°:', canvas.width, 'Ã—', canvas.height);
                status.textContent = "ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘...";
                
                // canvasë¥¼ ë°ì´í„° URLë¡œ ë³€í™˜í•˜ì—¬ ë‹¤ìš´ë¡œë“œ
                const dataURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `pocalist_sheet_${Date.now()}.png`;
                a.click();
                
                overlay.removeChild(status);
              } catch (e) {
                console.error('ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e);
                alert('ìº¡ì²˜ ì‹¤íŒ¨: ' + e.message);
              }
            };
            
            btnBar.append(closeBtn, saveBtn);
            overlay.appendChild(btnBar);

            // â‘£ ë…¸ë“œ ë³µì œí•´ì„œ ì‹œíŠ¸ì— ì¶”ê°€ (ì´ë¯¸ì§€ ë¡œë”© ì²˜ë¦¬ ê°œì„ )
            nodes.forEach(n => {
              const container = document.createElement('div');
              container.style.cssText = 'position:relative; width:100px; height:140px; display:flex; justify-content:center; align-items:center;';
              
              const img = new Image();
              img.crossOrigin = 'anonymous'; // CORS ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ í•„ìˆ˜
              img.className = 'photo-card';
              img.style.cssText = 'max-width:100%; max-height:140px; object-fit:contain;';
              
              // ì²´í¬ ìƒíƒœì— ë”°ë¼ ë¶ˆíˆ¬ëª…ë„ ì„¤ì •
              if (n.classList.contains('checked')) {
                img.style.opacity = '1'; // ë³´ìœ  ì¹´ë“œëŠ” 100% ë¶ˆíˆ¬ëª…ë„
              } else {
                img.style.opacity = '0.4'; // ë¯¸ë³´ìœ  ì¹´ë“œëŠ” 40% ë¶ˆíˆ¬ëª…ë„
              }
              
              // ì›ë³¸ ì†ŒìŠ¤ì™€ ë°ì´í„°ì…‹ ë³µì‚¬
              img.src = n.src;
              img.alt = n.alt;
              
              // ë¡œë”© í‘œì‹œê¸°
              const loader = document.createElement('div');
              loader.textContent = 'ë¡œë”©ì¤‘...';
              loader.style.cssText = 'position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:center; align-items:center; background:rgba(255,255,255,0.8);';
              container.appendChild(loader);
              
              // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ë¡œë”© í‘œì‹œê¸° ì œê±°
              img.onload = () => {
                if (loader.parentNode === container) {
                  container.removeChild(loader);
                }
              };
              
              container.appendChild(img);
              sheetGrid.appendChild(container);
            });
          }

          // ëª¨ë‹¬ ì „ì²´ì—ì„œ ìš°í´ë¦­ ë©”ë‰´ ì°¨ë‹¨
          $('#photo-modal').addEventListener('contextmenu', e => e.preventDefault());
          
          // ëª¨ë‹¬ ì•ˆ ì´ë¯¸ì§€ì—ì„œë„ ìš°í´ë¦­ ë©”ë‰´ ì°¨ë‹¨
          $('#modal-image').addEventListener('contextmenu', e => e.preventDefault());

          /* X ë²„íŠ¼ -or- ë°”ê¹¥ í´ë¦­ â†’ ëª¨ë‹¬ ë‹«ê¸° */
          $('#modal-close').addEventListener('click', () => $('#photo-modal').style.display = 'none');
          
          $('#photo-modal').addEventListener('click', e => {
            if (e.target === $('#photo-modal')) $('#photo-modal').style.display = 'none';
          });

          // ì´ˆê¸° ë¡œë“œ
          fetchAndRenderImages()
            .then(() => {
              // ì´ˆê¸°í™”ê°€ ì™„ë£Œëœ í›„ ë‚´ ë± ë¡œë“œ
              setTimeout(() => {
                loadSelfDeck();
              }, 100);
            })
            .catch(console.error);
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•± ì´ˆê¸°í™” (DOMContentLoadedì™€ ë³„ê°œë¡œ window.onloadì—ë„ í˜¸ì¶œ)
        window.addEventListener('load', initApp);


        // iOS/iPadOS UUID ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ê¸°ëŠ¥
        (function() {
          // í¬í† ì¹´ë“œ ì²´í¬ ê°ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜
          let hasCheckedCard = false;
          
          // UUID ì•ˆë‚´ ëª¨ë‹¬
          const uuidGuideModal = document.createElement('div');
          uuidGuideModal.className = 'modal';
          uuidGuideModal.id = 'uuid-guide-modal';
          uuidGuideModal.innerHTML = `
            // í•´ë‹¹ ë¶€ë¶„ë§Œ ë³€ê²½
              <div class="modal-content" style="max-width: 500px;">
                <span class="close">&times;</span>
                <h3>ì¤‘ìš”: ë°ì´í„° ë³´ì¡´ ì•ˆë‚´</h3>
                <p style="margin-bottom: 15px; font-weight: bold; color: #e74c3c;">iOS/iPadOSì—ì„œëŠ” ë¸Œë¼ìš°ì €ë¥¼ ì¢…ë£Œí•˜ë©´ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p style="margin-bottom: 15px;">ì•„ë˜ ë§í¬ë¥¼ <strong>ë¶ë§ˆí¬</strong>í•˜ê±°ë‚˜ <strong>í™ˆ í™”ë©´ì— ì¶”ê°€</strong>í•˜ì—¬ ì–¸ì œë“  ê°™ì€ UUIDë¡œ ì ‘ì†í•˜ì„¸ìš”:</p>
                
                <div style="background: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                  <div style="display: flex; align-items: center;">
                    <input id="uuid-bookmark-link" type="text" readonly style="flex: 1; padding: 8px; font-family: monospace;" />
                    <button id="copy-link-btn" style="margin-left: 10px; padding: 8px;">ë³µì‚¬</button>
                  </div>
                </div>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                  <p><strong>í™ˆ í™”ë©´ì— ì¶”ê°€ ë˜ëŠ” ë¶ë§ˆí¬ì— ì¶”ê°€:</strong></p>
                  <ol style="margin: 0 0 10px 20px;">
                    <li style="margin-bottom: 8px;"><strong>ë³µì‚¬í•œë§í¬ì˜ ì£¼ì†Œë¡œ ì¬ì ‘ì†í•œ í›„</strong></li>
                    <li style="margin-bottom: 8px;">ë¸Œë¼ìš°ì € <strong>ìƒë‹¨</strong> ë˜ëŠ” <strong>í•˜ë‹¨</strong>ì˜ <strong>ê³µìœ  ë²„íŠ¼</strong> <span style="display: inline-block; width: 20px; height: 20px; background: #eee; text-align: center; border-radius: 4px; line-height: 20px; vertical-align: middle;">â†‘</span>ì„ ëˆ„ë¦…ë‹ˆë‹¤.</li>
                    <li style="margin-bottom: 8px;"><strong>"í™ˆ í™”ë©´ì— ì¶”ê°€"</strong> ë˜ëŠ” <strong>"ë¶ë§ˆí¬"</strong> ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</li>
                  </ol>
                </div>
                
                <label>
                  <input type="checkbox" id="dont-show-again" />
                  ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°
                </label>
                <button id="uuid-guide-close" style="display: block; margin: 15px auto 0; padding: 8px 15px;">í™•ì¸</button>
              </div>
            `;

          // ëª¨ë‹¬ ìŠ¤íƒ€ì¼
          const style = document.createElement('style');
          style.textContent = `
            #uuid-guide-modal .modal-content {
              background-color: white;
              max-width: 550px;
              width: 90%;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            }
            #uuid-guide-modal p {
              line-height: 1.5;
              color: #333;
            }
            #uuid-guide-modal button {
              background-color: #4a90e2;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            }
            #uuid-guide-modal #uuid-bookmark-link {
              font-size: 13px;
            }
          `;
          document.head.appendChild(style);
          document.body.appendChild(uuidGuideModal);

          // UUID ë¶ë§ˆí¬ ë§í¬ ìƒì„± ë° ëª¨ë‹¬ ì—…ë°ì´íŠ¸
          async function updateUuidGuideModal() {
            try {
              // í˜„ì¬ UUID ê°€ì ¸ì˜¤ê¸°
              let uuid = await getMyUUID();
              
              if (!uuid) return false; // UUIDê°€ ì—†ìœ¼ë©´ ëª¨ë‹¬ í‘œì‹œ ì•ˆí•¨
              
              // ë¶ë§ˆí¬ URL ìƒì„± (ê¸°ë³¸ URL + uuid íŒŒë¼ë¯¸í„°)
              const baseUrl = window.location.origin + window.location.pathname;
              const finalUrl = new URL(baseUrl);
              finalUrl.searchParams.set('uuid', uuid);
              
              // ë¶ë§ˆí¬ ë§í¬ í•„ë“œ ì„¤ì •
              document.getElementById('uuid-bookmark-link').value = finalUrl.toString();
              
              // í˜„ì¬ URLì— UUID íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì¶”ê°€ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´)
              const currentUrl = new URL(window.location.href);
              if (!currentUrl.searchParams.has('uuid') && history.replaceState) {
                currentUrl.searchParams.set('uuid', uuid);
                history.replaceState(null, null, currentUrl.toString());
              }
              
              return true; // UUIDê°€ ìˆì–´ ëª¨ë‹¬ í‘œì‹œ ê°€ëŠ¥
              
            } catch (error) {
              console.error('UUID ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
              return false;
            }
          }

          // ë§í¬ ë³µì‚¬ ë²„íŠ¼
          document.getElementById('copy-link-btn')?.addEventListener('click', () => {
            const linkInput = document.getElementById('uuid-bookmark-link');
            linkInput.select();
            document.execCommand('copy');
            
            alert('UUID ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ ë§í¬ë¥¼ ë¶ë§ˆí¬í•˜ê±°ë‚˜ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì„¸ìš”.');
          });

          // ë‹«ê¸° ë²„íŠ¼
          document.getElementById('uuid-guide-close')?.addEventListener('click', () => {
            document.getElementById('uuid-guide-modal').style.display = 'none';
            
            // ë‹¤ì‹œ ë³´ì§€ ì•Šê¸° ì˜µì…˜ ì €ì¥
            if (document.getElementById('dont-show-again').checked) {
              try {
                localStorage.setItem('hideUuidGuide', 'true');
                setCookie('hideUuidGuide', 'true', 30);
              } catch (error) {
                console.error('ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
              }
            }
          });

          // X ë²„íŠ¼
          document.querySelector('#uuid-guide-modal .close')?.addEventListener('click', () => {
            document.getElementById('uuid-guide-modal').style.display = 'none';
          });

          // ================= ì¤‘ìš”: UUID ì²˜ë¦¬ ë¡œì§ ê°œì„  =================
          
          // URLì—ì„œ UUID íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
          function getUuidFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUuid = urlParams.get('uuid');
            return isValidUUID(urlUuid) ? urlUuid : null;
          }
          
          // UUID ê°€ì ¸ì˜¤ê¸° (ìš°ì„ ìˆœìœ„: URL > ì¿ í‚¤ > localStorage)
          async function getMyUUID() {
            // 1. URLì—ì„œ UUID í™•ì¸ (ìµœìš°ì„ )
            const urlUuid = getUuidFromUrl();
            if (urlUuid) {
              return urlUuid;
            }
            
            // 2. ì¿ í‚¤ì—ì„œ UUID í™•ì¸
            const cookieUuid = getCookie('myUUID');
            if (isValidUUID(cookieUuid)) {
              return cookieUuid;
            }
            
            // 3. localStorageì—ì„œ UUID í™•ì¸
            const localUuid = localStorage.getItem('myUUID');
            if (isValidUUID(localUuid)) {
              return localUuid;
            }
            
            return null;
          }
          
          // URLì—ì„œ UUID í™•ì¸ ë° ë°ì´í„° ë¡œë“œ (í˜ì´ì§€ ë¡œë“œ ì‹œ í˜¸ì¶œ)
          async function processUrlUuid() {
            try {
              const urlUuid = getUuidFromUrl();
              if (!urlUuid) return false;
              
              console.log('URLì—ì„œ UUID ë°œê²¬:', urlUuid);
              
              // ë¡œì»¬ ì €ì¥ì†Œë¥¼ ë¨¼ì € í™•ì¸ (URLì˜ UUIDê°€ ìš°ì„ )
              const urlUuidLoaded = localStorage.getItem(`uuid_loaded_${urlUuid}`);
              if (urlUuidLoaded === 'true') {
                console.log('ì´ë¯¸ ì´ UUIDë¡œ ë¡œë“œëœ ì  ìˆìŒ. ë°ì´í„° ì¬ë¡œë“œ ìƒëµ');
                return true;
              }
              
              // ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ
              try {
                console.log('ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„:', urlUuid);
                const response = await fetch(`https://pocali-backend.onrender.com/api/user/${urlUuid}`);
                
                if (!response.ok) {
                  console.error('ì„œë²„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', await response.text());
                  return false;
                }
                
                const data = await response.json();
                console.log('ì„œë²„ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
                
                // ê¸°ì¡´ UUID ë°±ì—…
                const oldUuid = localStorage.getItem('myUUID');
                if (oldUuid) {
                  localStorage.setItem('previous_uuid', oldUuid);
                  console.log('ê¸°ì¡´ UUID ë°±ì—…:', oldUuid);
                }
                
                // ìƒˆ UUIDì™€ ë°ì´í„° ì €ì¥
                localStorage.setItem('myUUID', urlUuid);
                setCookie('myUUID', urlUuid, 30);
                
                // userData ì €ì¥
                const userData = typeof data.data === 'string' ? data.data : JSON.stringify(data.data || {});
                localStorage.setItem('userData', userData);
                setCookie('userData', userData, 30);
                
                // ë¡œë“œ ì™„ë£Œ í‘œì‹œ
                localStorage.setItem(`uuid_loaded_${urlUuid}`, 'true');
                
                console.log('ìƒˆ UUID ì ìš© ì™„ë£Œ:', urlUuid);
                
                // UUID ë³€ê²½ í›„ ì¦‰ì‹œ í˜ì´ì§€ ê°±ì‹  (ì£¼ì†ŒëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
                window.location.reload();
                return true;
              } catch (error) {
                console.error('URL UUID ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                return false;
              }
            } catch (error) {
              console.error('URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
              return false;
            }
          }

          // ì²« í¬í† ì¹´ë“œ ì²´í¬ ì‹œ UUID ê°€ì´ë“œ ëª¨ë‹¬ í‘œì‹œ
          function setupCardCheckListener() {
            // iOS ê¸°ê¸°ì¸ì§€ í™•ì¸
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (!isIOS) return; // iOS ê¸°ê¸°ê°€ ì•„ë‹ˆë©´ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì•ˆí•¨
            
            // URLì— UUIDê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
            const urlHasUuid = getUuidFromUrl() !== null;
            if (urlHasUuid) return; // URLì— UUIDê°€ ìˆìœ¼ë©´ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì•ˆí•¨
            
            // ì›ë³¸ toggleCheck í•¨ìˆ˜ ì°¸ì¡° ì €ì¥
            const originalToggleCheck = window.toggleCheck;
            
            if (typeof originalToggleCheck === 'function') {
              // toggleCheck í•¨ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆëŠ” ê²½ìš°
              window.toggleCheck = async function(img) {
                // ì›ë˜ í•¨ìˆ˜ í˜¸ì¶œ
                originalToggleCheck.apply(this, arguments);
                
                // ì²« ì²´í¬ ê°ì§€
                if (!hasCheckedCard) {
                  hasCheckedCard = true;
                  
                  // ë‹¤ì‹œ ë³´ì§€ ì•Šê¸° ì„¤ì • í™•ì¸
                  const hideGuide = localStorage.getItem('hideUuidGuide') || getCookie('hideUuidGuide');
                  if (hideGuide === 'true') return;
                  
                  // ëª¨ë‹¬ í‘œì‹œ (ì•½ê°„ì˜ ì§€ì—° í›„)
                  setTimeout(async () => {
                    if (await updateUuidGuideModal()) {
                      document.getElementById('uuid-guide-modal').style.display = 'block';
                    }
                  }, 500);
                }
              };
            } else {
              // toggleCheck í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°, í´ë¦­ ì´ë²¤íŠ¸ ê°ì‹œ
              document.addEventListener('click', async function(e) {
                // í¬í† ì¹´ë“œ í´ë¦­ ê°ì§€
                if (e.target && e.target.classList && e.target.classList.contains('photo-card')) {
                  if (!hasCheckedCard) {
                    hasCheckedCard = true;
                    
                    // ë‹¤ì‹œ ë³´ì§€ ì•Šê¸° ì„¤ì • í™•ì¸
                    const hideGuide = localStorage.getItem('hideUuidGuide') || getCookie('hideUuidGuide');
                    if (hideGuide === 'true') return;
                    
                    // ëª¨ë‹¬ í‘œì‹œ (ì•½ê°„ì˜ ì§€ì—° í›„)
                    setTimeout(async () => {
                      if (await updateUuidGuideModal()) {
                        document.getElementById('uuid-guide-modal').style.display = 'block';
                      }
                    }, 1000);
                  }
                }
              });
            }
          }

          // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
          window.addEventListener('load', async () => {
            console.log('POCALIST UUID í—¬í¼ ë¡œë“œë¨');
            
            // URL UUID ë¨¼ì € ì²˜ë¦¬ (ìµœìš°ì„ )
            const urlProcessed = await processUrlUuid();
            
            // URLì— UUIDê°€ ì—†ê±°ë‚˜ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¹´ë“œ ì²´í¬ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            if (!urlProcessed) {
              setupCardCheckListener();
            }
          });

          // 'ìœ ì € ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°' ë²„íŠ¼ì— ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
          document.getElementById('load-user-data')?.addEventListener('click', async () => {
            // iOS ê¸°ê¸° ê°ì§€
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
              // 'ìœ ì € ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°' ëª¨ë‹¬ì´ ë‹«íˆë©´ UUID ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ
              const userDataModal = document.getElementById('user-data-modal');
              
              // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ìœ ì§€í•˜ë©´ì„œ ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
              const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                  if (mutation.attributeName === 'style' && 
                      userDataModal.style.display === 'none') {
                    
                    // ë‹¤ì‹œ ë³´ì§€ ì•Šê¸° ì„¤ì • í™•ì¸
                    const hideGuide = localStorage.getItem('hideUuidGuide') || getCookie('hideUuidGuide');
                    if (hideGuide === 'true') return;
                    
                    // URLì— UUIDê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ëª¨ë‹¬ í‘œì‹œ
                    setTimeout(async () => {
                      const urlHasUuid = getUuidFromUrl() !== null;
                      if (!urlHasUuid && await updateUuidGuideModal()) {
                        document.getElementById('uuid-guide-modal').style.display = 'block';
                      }
                    }, 500);
                    
                    // í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ê³  Observer ì œê±°
                    observer.disconnect();
                  }
                });
              });
              
              // userDataModalì˜ style ì†ì„± ë³€í™” ê°ì‹œ ì‹œì‘
              observer.observe(userDataModal, { attributes: true });
            }
          });

          // ì›ë˜ì˜ validateUserID í•¨ìˆ˜ë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ URL UUID ì²˜ë¦¬ ê°œì„ 
          const originalValidateUserID = window.validateUserID;
          
          if (typeof originalValidateUserID === 'function') {
            window.validateUserID = async function() {
              // URLì—ì„œ UUID í™•ì¸ (ìµœìš°ì„ )
              const urlUuid = getUuidFromUrl();
              
              if (urlUuid) {
                console.log('validateUserID: URLì—ì„œ UUID ì‚¬ìš©:', urlUuid);
                
                // localStorageì™€ ì¿ í‚¤ì— URL UUID ì €ì¥
                localStorage.setItem('myUUID', urlUuid);
                setCookie('myUUID', urlUuid, 30);
                
                // ì„œë²„ì—ì„œ ë°ì´í„° í™•ì¸
                try {
                  const resp = await fetch(`https://pocali-backend.onrender.com/api/user/${urlUuid}`);
                  if (resp.ok) {
                    const data = await resp.json();
                    if (data.data) {
                      const userData = typeof data.data === 'string' ? data.data : JSON.stringify(data.data || {});
                      localStorage.setItem('userData', userData);
                      setCookie('userData', userData, 30);
                    }
                  }
                } catch (error) {
                  console.error('URL UUID ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                }
                
                return urlUuid;
              }
              
              // URLì— UUIDê°€ ì—†ìœ¼ë©´ ì›ë˜ í•¨ìˆ˜ í˜¸ì¶œ
              return await originalValidateUserID.apply(this, arguments);
            };
          }
          
          // ì›ë˜ì˜ ensureMyUUID í•¨ìˆ˜ë¥¼ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ URL UUID ì²˜ë¦¬ ê°œì„ 
          const originalEnsureMyUUID = window.ensureMyUUID;
          
          if (typeof originalEnsureMyUUID === 'function') {
            window.ensureMyUUID = async function() {
              // URLì—ì„œ UUID í™•ì¸ (ìµœìš°ì„ )
              const urlUuid = getUuidFromUrl();
              
              if (urlUuid) {
                console.log('ensureMyUUID: URLì—ì„œ UUID ì‚¬ìš©:', urlUuid);
                return urlUuid;
              }
              
              // URLì— UUIDê°€ ì—†ìœ¼ë©´ ì›ë˜ í•¨ìˆ˜ í˜¸ì¶œ
              return await originalEnsureMyUUID.apply(this, arguments);
            };
          }
        })();
      </script>
               
      </body>
      </html>