<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>pocalist</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
        <!-- ìƒë‹¨ ê²€ìƒ‰ì°½ & ì¹´ìš´í„° -->
        <header id="search-header">
          <input type="text" id="search-input" placeholder="í¬í† ì¹´ë“œ ê²€ìƒ‰..." />
          <button id="search-detail-btn">+</button>
          <div id="count-display" style="text-align:center; font-weight:bold; margin-top: 5px;">
            0 / 0
          </div>
          <button id="view-toggle">ğŸ‘¥ ì¹œêµ¬ë³´ê¸°</button>  <!-- â† ìƒˆ ë²„íŠ¼ -->
        </header>
  <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->        
	<div id="photo-grid">  
    </div>
    <!-- ì¹´ë“œ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="photo-modal" class="modal" style="display: none;">
     <div class="modal-content">
      <span id="modal-close" class="close">&times;</span>
      <img id="modal-image" src="" alt="í™•ëŒ€ëœ í¬í† ì¹´ë“œ" draggable="false" />
      <div id="modal-info">
        <!-- íŒŒì¼ëª… íŒŒì‹± ë“±ìœ¼ë¡œ ì¶”í›„ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•  ì˜ˆì • -->
        </div>
      </div>
    </div>
    <!-- ìœ ì € ë°ì´í„° ëª¨ë‹¬ -->
   <div id="user-data-modal" class="modal" style="display: none;">
   <div class="modal-content">
    <span id="user-data-modal-close" class="close">&times;</span>
    <h3>UUID ë°ì´í„° ê´€ë¦¬</h3>

    <!-- ë‚´ UUID ì˜ì—­ -->
    <label for="my-uuid">ë‚´ UUID:</label>
    <input type="text" id="my-uuid" readonly style="width: 100%;" />

    <!-- ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ì…ë ¥ ì˜ì—­ -->
    <label for="other-uuid">ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ë¶ˆëŸ¬ì˜¤ê¸°:</label>
    <input type="text" id="other-uuid" placeholder="ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤ì˜ UUID ì…ë ¥" style="width: 100%;" />
    <button id="load-other-data">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>

    <!-- ë©”ì‹œì§€ ë˜ëŠ” ì—ëŸ¬ í‘œì‹œ -->
    <div id="uuid-msg" style="margin-top: 10px; color: red;"></div>
    </div>
   </div>

         <!-- ìƒì„¸ ê²€ìƒ‰ ëª¨ë‹¬ -->
        <div id="detail-search-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="detail-search-modal-close" class="close">&times;</span>
            <h3>ìƒì„¸ ê²€ìƒ‰ ì˜µì…˜</h3>
            <form id="detail-search-form">
                <fieldset>
                <legend>ê·¸ë£¹</legend>
                <label>
                    <input type="checkbox" name="group" value="IVE" />
                    ì•„ì´ë¸Œ
                </label>
                <label>
                    <input type="checkbox" name="group" value="IZONE" />
                    ì•„ì´ì¦ˆì›
                </label>
                </fieldset>
                <fieldset>
                <legend>ë©¤ë²„</legend>
                <label>
                    <input type="checkbox" name="member" value="ìœ ì§„" />
                    ìœ ì§„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ê°€ì„" />
                    ê°€ì„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë ˆì´" />
                    ë ˆì´
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì›ì˜" />
                    ì›ì˜
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë¦¬ì¦ˆ" />
                    ë¦¬ì¦ˆ
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì´ì„œ" />
                    ì´ì„œ
                </label>
                </fieldset>
                <fieldset>
                <legend>í…ìŠ¤íŠ¸ ê²€ìƒ‰</legend>
                <input type="text" id="filter-text" name="filter-text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
                </fieldset>
                <button type="submit">ê²€ìƒ‰</button>
            </form>
            </div>
        </div>
        <!-- ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥ ëª¨ë‹¬ -->
        <div id="export-modal" class="modal" style="display: none;">
          <div class="modal-content">
              <span id="export-modal-close" class="close">&times;</span>
              <h3>í¬í† ì¹´ë“œ ì‹œíŠ¸ ì¶œë ¥</h3>
              <form id="export-form">
                  <fieldset>
                      <legend>ê·¸ë£¹ ì„ íƒ</legend>
                      <label><input type="radio" name="group" value="IVE" checked> ì•„ì´ë¸Œ</label>
                      <label><input type="radio" name="group" value="IZONE"> ì•„ì´ì¦ˆì›</label>
                  </fieldset>
                  <fieldset>
                      <legend>ë©¤ë²„ ì„ íƒ</legend>
                      <label><input type="checkbox" name="member" value="ìœ ì§„"> ìœ ì§„</label>
                      <label><input type="checkbox" name="member" value="ê°€ì„"> ê°€ì„</label>
                      <label><input type="checkbox" name="member" value="ë ˆì´"> ë ˆì´</label>
                      <label><input type="checkbox" name="member" value="ì›ì˜"> ì›ì˜</label>
                      <label><input type="checkbox" name="member" value="ë¦¬ì¦ˆ"> ë¦¬ì¦ˆ</label>
                      <label><input type="checkbox" name="member" value="ì´ì„œ"> ì´ì„œ</label>
                  </fieldset>
                  <button type="submit">ì‹œíŠ¸ ìƒì„±</button>
              </form>
          </div>
        </div>
          <!-- ì¹œêµ¬ UUID ì…ë ¥ ëª¨ë‹¬ -->
         <div id="friend-modal" class="modal"><div class="modal-content">
          <span id="friend-modal-close" class="close">&times;</span>
          <h3>ì¹œêµ¬ UUID ì…ë ¥</h3>
          <input id="friend-uuid" placeholder="ì¹œêµ¬ UUID" style="width:100%">
          <button id="friend-add-confirm">ì¶”ê°€</button></div></div>

	<!-- í•˜ë‹¨ ìš°ì¸¡ FAB ë²„íŠ¼ -->
        <button
        id="categoryToggleBtn"
        class="floating-btn left"
        title="ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°"
      >ğŸ·ï¸</button>
        <button id="fab">+</button>
        <!-- FAB ëª¨ë‹¬: ìœ ì € ë°ì´í„°/ê´€ë¦¬ì ë©”ë‰´ -->
        <div id="user-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="user-modal-close" class="close">&times;</span>
            <h3>ìœ ì € ë°ì´í„° ë° ê´€ë¦¬ì ë©”ë‰´</h3>
            <ul>
                <li><button id="load-user-data">ìœ ì € ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button></li>
                <li><button id="reset-checks">ì²´í¬ ìƒíƒœ ì´ˆê¸°í™”</button></li>
                <li><button id="export-sheet">ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥</button></li>
                <li><button id="add-friend">ì¹œêµ¬ ì¶”ê°€</button></li>
            </ul>
            </div>
        </div>
       <!-- âœ… html2canvas ë“± ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
        <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            // 0. ìƒìˆ˜ & ìƒíƒœ
            const PAGE_SIZE    = 50;
            const LONG_PRESS   = 500;
            const TAP_THRESHOLD= 200;

            let page       = 0;
            let loading    = false;
            let totalCount = 0;
            let originalCards = [];
            let photoCards    = [];

            // 1. DOM ìºì‹±
            const $grid          = document.getElementById('photo-grid');
            const $searchInput   = document.getElementById('search-input');
            const $catToggleBtn  = document.getElementById('categoryToggleBtn');
            const $viewToggleBtn = document.getElementById('view-toggle');
            // â”€â”€ ë± ì „í™˜ & ì¹´í…Œê³ ë¦¬ ë·° ìƒíƒœ
            let currentView      = 'id';     // 'id' or 'category'
            let viewOwner        = 'self';   // 'self' or 'friend'
            let currentFriendUUID= localStorage.getItem('lastFriendUUID')||null;
            const $fab           = document.getElementById('fab');
            const $userModal     = document.getElementById('user-modal');
            const $userModalClose= document.getElementById('user-modal-close');
            const $resetBtn      = document.getElementById('reset-checks');

            // 2. ë³´ìœ  ì²´í¬ í† ê¸€
            function toggleCheck(img) {
              img.classList.toggle('checked');
              const data = JSON.parse(localStorage.getItem('userData')||'{}');
              data[img.dataset.unique] = img.classList.contains('checked');
              localStorage.setItem('userData', JSON.stringify(data));
              updateCount();
            }

            // 3. ìƒì„¸ ëª¨ë‹¬ ë„ìš°ê¸°
            function showModal(img) {
              const $modal     = document.getElementById('photo-modal');
              const $modalImg  = document.getElementById('modal-image');
              const $modalInfo = document.getElementById('modal-info');
              $modalImg.src = img.src;
              $modalInfo.innerHTML = `
                <p>${img.dataset.group}</p>
                <p>${img.dataset.member}</p>
                <p>${img.dataset.category} ${img.dataset.title}</p>
                <p>${img.dataset.version}</p>
                <p>#${img.dataset.unique}</p>
              `;
              $modal.style.display = 'block';
            }

            // 4. ì¹´ìš´í„° ê°±ì‹ 
            function updateCount() {
              const data = JSON.parse(localStorage.getItem('userData')||'{}');
              const have = Object.values(data).filter(v=>v).length;
              document.getElementById('count-display').textContent = `${have} / ${totalCount}`;
            }

            // 5. ì„œë²„ì—ì„œ í˜ì´ì§• ë‹¨ìœ„ë¡œ ë¶ˆëŸ¬ì™€ ë Œë”
            async function renderPage() {
              if (loading) return;
              loading = true;
            // ê²€ìƒ‰ì–´(q) íŒŒë¼ë¯¸í„° í¬í•¨ + ì ˆëŒ€ê²½ë¡œ ë°±ì—”ë“œ í˜¸ì¶œ
            const q     = $searchInput.value.trim();
            const base  = `https://pocali-backend.onrender.com/api/images?page=${page}&limit=${PAGE_SIZE}`;
            const url   = q ? `${base}&q=${encodeURIComponent(q)}` : base;
            const res   = await fetch(url);
              const items = await res.json();
              if (page===0) {
                // í—¤ë”ì—ì„œ ì „ì²´ ê°œìˆ˜ ì½ê¸°
                totalCount = parseInt(res.headers.get('X-Total-Count')|| items.length,10);
                $grid.innerHTML = '';
              }
              if (!items.length) {
                loading = false;
                return;
              }

              items.forEach(image => {
                const container = document.createElement('div');
                container.className = 'photo-card-container';
                const img = document.createElement('img');
                img.className = 'photo-card';
                img.src         = image.url;
                img.alt         = image.member;
                img.dataset.group   = image.group;
                img.dataset.member  = image.member;
                img.dataset.category= image.category;
                img.dataset.title   = image.title;
                img.dataset.version = image.version;
                img.dataset.unique  = image.unique_id;

                // ë”ë¸”í´ë¦­(PC) â†’ ì²´í¬
                img.addEventListener('dblclick', ()=> {
                  if (viewOwner==='self') toggleCheck(img);
                });
                // í„°ì¹˜(ëª¨ë°”ì¼) ì§§ê²Œ â†’ ì²´í¬, ê¸¸ê²Œ â†’ ëª¨ë‹¬
                let pressStart, pressTimer;
                img.addEventListener('pointerdown', e => {
                  if (viewOwner!=='self') return;
                  pressStart = performance.now();
                  pressTimer = setTimeout(()=>showModal(img), LONG_PRESS);
                });
                img.addEventListener('pointerup', e => {
                  clearTimeout(pressTimer);
                  const dt = performance.now() - pressStart;
                  if (e.pointerType==='touch' && dt < TAP_THRESHOLD) toggleCheck(img);
                });
                img.addEventListener('pointerleave', ()=>clearTimeout(pressTimer));
                // ìš°í´ë¦­ â†’ ëª¨ë‹¬
                img.addEventListener('contextmenu', e => {
                  e.preventDefault();
                  showModal(img);
                });

                container.appendChild(img);
                $grid.appendChild(container);
              });

              // ìºì‹œ ê°±ì‹ 
              originalCards = Array.from($grid.querySelectorAll('.photo-card-container'));
              photoCards    = Array.from($grid.querySelectorAll('.photo-card'));

              page += 1;
              loading = false;
              updateCount();
            }
            // 6. ë¬´í•œ ìŠ¤í¬ë¡¤
            window.addEventListener('scroll', () => {
              console.log('scroll', window.scrollY, document.body.offsetHeight);
              if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
                renderPage();
              }
            });

            // 7. ê²€ìƒ‰ & í•„í„°
            function applyFilters() {
              if (currentView==='category') showByCategory();
              else showById(
                originalCards.filter(div => 
                  div.querySelector('.photo-card').alt
                    .toLowerCase().includes($searchInput.value.toLowerCase())
                )
              );
            }
            $searchInput.addEventListener('input', ()=> {
              page = 0;
              renderPage();
            });

            // 8. ì •ë ¬ í•¨ìˆ˜
            function showById(list=null) {
              const cards = (list||originalCards).slice();
              cards.sort((a,b)=>
                +b.querySelector('.photo-card').dataset.unique -
                +a.querySelector('.photo-card').dataset.unique
              );
              $grid.innerHTML = '';
              cards.forEach(c=>$grid.appendChild(c));
              updateCount();
            }
            function showByCategory() {
              const buckets = {};
              originalCards.forEach(div => {
                const img = div.querySelector('.photo-card');
                const key = [img.dataset.category, img.dataset.title, img.dataset.version]
                            .filter(Boolean).join(' | ');
                (buckets[key]=buckets[key]||[]).push(div);
              });
              $grid.innerHTML = '';
              Object.entries(buckets).forEach(([hdr, cards])=>{
                const h2 = document.createElement('h2');
                h2.textContent = hdr;
                $grid.appendChild(h2);
                cards.forEach(d=>$grid.appendChild(d));
              });
              updateCount();
            }
            $catToggleBtn.addEventListener('click', () => {
              currentView = currentView==='id'?'category':'id';
              applyFilters();
            });

            // 9. ì¹œêµ¬ë³´ê¸° í† ê¸€
            $viewToggleBtn.addEventListener('click', () => {
              if (viewOwner==='friend') loadSelfDeck();
              else if (currentFriendUUID) loadFriendDeck(currentFriendUUID);
              else alert('ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!');
            });

            // â”€â”€ 9. ë± ì „í™˜ (loadSelfDeck / loadFriendDeck) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            /** ë‚´ ë³´ìœ  ì¹´ë“œ í‘œì‹œ */
            function loadSelfDeck () {
              const myData = JSON.parse(localStorage.getItem('userData') || '{}');
              photoCards.forEach(img => {
                img.classList.toggle('checked', !!myData[img.dataset.unique]);
                img.style.pointerEvents = '';        // ë”ë¸”í´ë¦­ í—ˆìš©
              });
              viewOwner = 'self';
              $viewToggleBtn.textContent = 'ğŸ‘¥ ì¹œêµ¬ë³´ê¸°';
              updateCount();
            }

            /** ì¹œêµ¬ ë³´ìœ  ì¹´ë“œ í‘œì‹œ */
            async function loadFriendDeck (uuid) {
              const res = await fetch(`https://pocali-backend.onrender.com/api/friend/${uuid}/collection`);
              if (!res.ok) { alert('ì¹œêµ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
              const friendData = (await res.json()).data || {};
              photoCards.forEach(img => {
                img.classList.toggle('checked', !!friendData[img.dataset.unique]);
                img.style.pointerEvents = 'none';   // ìˆ˜ì • ê¸ˆì§€
              });
              viewOwner = 'friend';
              currentFriendUUID = uuid;
              localStorage.setItem('lastFriendUUID', uuid);
              $viewToggleBtn.textContent = 'ğŸ‘¤ ë‚´ ì¹´ë“œë³´ê¸°';
              updateCount();
            }

            // ì „ì—­(ì½˜ì†”)ì—ì„œë„ í˜¸ì¶œ ê°€ëŠ¥
            window.loadSelfDeck   = loadSelfDeck;
            window.loadFriendDeck = loadFriendDeck;

            // â€œì¹œêµ¬ë³´ê¸° â†” ë‚´ì¹´ë“œë³´ê¸°â€ í† ê¸€ ë²„íŠ¼
            $viewToggleBtn.addEventListener('click', () => {
              if (viewOwner === 'friend') loadSelfDeck();
              else if (currentFriendUUID) loadFriendDeck(currentFriendUUID);
              else alert('ë¨¼ì € ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!');
            });
            // :contentReference[oaicite:0]{index=0}:contentReference[oaicite:1]{index=1}

            // â”€â”€ 10. FAB ë²„íŠ¼ & ìœ ì € ì„¤ì • ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            $fab.addEventListener('click',   () => $userModal.style.display = 'block');
            $userModalClose.addEventListener('click', () => $userModal.style.display = 'none');
            $userModal.addEventListener('click', e => {
              if (e.target === $userModal) $userModal.style.display = 'none';
            });

            // â”€â”€ 11. ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥(html2canvas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const $exportBtn   = document.getElementById('export-sheet');
            const $exportModal = document.getElementById('export-modal');
            const $exportClose = document.getElementById('export-modal-close');
            const $exportForm  = document.getElementById('export-form');

            // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
            $exportBtn.addEventListener('click',   () => $exportModal.style.display = 'block');
            $exportClose.addEventListener('click', () => $exportModal.style.display = 'none');

            // ì„ íƒëœ ì¹´ë“œë¡œ ì‹œíŠ¸ ìƒì„±
            $exportForm.addEventListener('submit', e => {
              e.preventDefault();
              const fd      = new FormData($exportForm);
              const group   = fd.get('group');
              const members = fd.getAll('member');
              if (!members.length) { alert('ë©¤ë²„ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”!'); return; }

              // photoCards ëŠ” renderPage() í›„ ìºì‹œì— ìˆìŠµë‹ˆë‹¤
              const selCards = photoCards.filter(img =>
                img.dataset.group === group &&
                members.includes(img.dataset.member)
              );
              if (!selCards.length) { alert('í•´ë‹¹ ì¡°ê±´ì˜ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

              $exportModal.style.display = 'none';
              generateImageSheet(selCards);
            });

            // ì‹œíŠ¸ â†’ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œìš© í—¬í¼
            function generateImageSheet(cards) {
              const overlay = document.createElement('div');
              overlay.style.cssText = `
                position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:9999;
                display:flex; flex-direction:column; align-items:center; overflow:auto;
              `;
              const grid = document.createElement('div');
              grid.style.cssText = `
                display:grid; grid-template-columns:repeat(16,1fr);
                gap:8px; padding:24px; max-width:100%; overflow-x:auto;
              `;
              overlay.appendChild(grid);
              cards.forEach(img => {
                const clone = img.cloneNode();
                clone.style.width   = '100%';
                clone.style.opacity = img.classList.contains('checked') ? '1' : '0.4';
                grid.appendChild(clone);
              });
              const btnBar = document.createElement('div');
              btnBar.style.cssText = `position:fixed; top:20px; right:20px; display:flex; gap:8px;`;
              const close = document.createElement('button');
              close.textContent = 'ë‹«ê¸°';
              close.style.cssText = `padding:8px 14px; background:#f44336; color:#fff; border:none;`;
              close.onclick = () => document.body.removeChild(overlay);
              const save = document.createElement('button');
              save.textContent = 'ì´ë¯¸ì§€ ì €ì¥';
              save.style.cssText = `padding:8px 14px; background:#4CAF50; color:#fff; border:none;`;
              save.onclick = () => downloadAsImage(grid);
              btnBar.append(close, save);
              overlay.appendChild(btnBar);
              document.body.appendChild(overlay);
            }

            // html2canvas ë˜í¼
            function downloadAsImage(target) {
              const loader = document.createElement('div');
              loader.textContent = 'ì´ë¯¸ì§€ ìƒì„± ì¤‘â€¦';
              loader.style.cssText = `
                position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
                background:rgba(0,0,0,.6); color:#fff; font-size:1.2rem; z-index:10000;
              `;
              document.body.appendChild(loader);
              html2canvas(target, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `pocalist_sheet_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(loader);
              }).catch(err => {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
                document.body.removeChild(loader);
              });
            }
            // :contentReference[oaicite:2]{index=2}:contentReference[oaicite:3]{index=3}

            // â”€â”€ 12. ì²´í¬ ì´ˆê¸°í™” ë²„íŠ¼
            $resetBtn.addEventListener('click', async () => {
              if (!confirm('ëª¨ë‘ í•´ì œí• ê¹Œìš”?')) return;
              photoCards.forEach(img => img.classList.remove('checked'));
              localStorage.removeItem('userData');
              updateCount();
              const me = localStorage.getItem('myUUID');
              if (me) await fetch(`https://pocali-backend.onrender.com/api/user/${me}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: {} })
              });
            });

            // â”€â”€ 13. ì´ˆê¸° ë Œë”
            renderPage();
          });
          </script>

               
      </body>
      </html>