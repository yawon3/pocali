<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>pocalist</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
        <!-- ìƒë‹¨ ê²€ìƒ‰ì°½ & ì¹´ìš´í„° -->
        <header id="search-header">
          <input type="text" id="search-input" placeholder="í¬í† ì¹´ë“œ ê²€ìƒ‰..." />
          <button id="search-detail-btn">+</button>
          <div id="count-display" style="text-align:center; font-weight:bold; margin-top: 5px;">
            0 / 0
          </div>
          <button id="view-toggle">ğŸ‘¥ ì¹œêµ¬ë³´ê¸°</button>  <!-- â† ìƒˆ ë²„íŠ¼ -->
        </header>
  <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->        
	<div id="photo-grid">  
    </div>
    <!-- ì¹´ë“œ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="photo-modal" class="modal" style="display: none;">
     <div class="modal-content">
      <span id="modal-close" class="close">&times;</span>
      <img id="modal-image" src="" alt="í™•ëŒ€ëœ í¬í† ì¹´ë“œ" draggable="false" />
      <div id="modal-info">
        <!-- íŒŒì¼ëª… íŒŒì‹± ë“±ìœ¼ë¡œ ì¶”í›„ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•  ì˜ˆì • -->
        </div>
      </div>
    </div>
    <!-- ìœ ì € ë°ì´í„° ëª¨ë‹¬ -->
   <div id="user-data-modal" class="modal" style="display: none;">
   <div class="modal-content">
    <span id="user-data-modal-close" class="close">&times;</span>
    <h3>UUID ë°ì´í„° ê´€ë¦¬</h3>

    <!-- ë‚´ UUID ì˜ì—­ -->
    <label for="my-uuid">ë‚´ UUID:</label>
    <input type="text" id="my-uuid" readonly style="width: 100%;" />

    <!-- ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ì…ë ¥ ì˜ì—­ -->
    <label for="other-uuid">ë‹¤ë¥¸ ê¸°ê¸°ì˜ UUID ë¶ˆëŸ¬ì˜¤ê¸°:</label>
    <input type="text" id="other-uuid" placeholder="ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤ì˜ UUID ì…ë ¥" style="width: 100%;" />
    <button id="load-other-data">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>

    <!-- ë©”ì‹œì§€ ë˜ëŠ” ì—ëŸ¬ í‘œì‹œ -->
    <div id="uuid-msg" style="margin-top: 10px; color: red;"></div>
    </div>
   </div>

         <!-- ìƒì„¸ ê²€ìƒ‰ ëª¨ë‹¬ -->
        <div id="detail-search-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="detail-search-modal-close" class="close">&times;</span>
            <h3>ìƒì„¸ ê²€ìƒ‰ ì˜µì…˜</h3>
            <form id="detail-search-form">
                <fieldset>
                <legend>ê·¸ë£¹</legend>
                <label>
                    <input type="checkbox" name="group" value="IVE" />
                    ì•„ì´ë¸Œ
                </label>
                <label>
                    <input type="checkbox" name="group" value="IZONE" />
                    ì•„ì´ì¦ˆì›
                </label>
                </fieldset>
                <fieldset>
                <legend>ë©¤ë²„</legend>
                <label>
                    <input type="checkbox" name="member" value="ìœ ì§„" />
                    ìœ ì§„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ê°€ì„" />
                    ê°€ì„
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë ˆì´" />
                    ë ˆì´
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì›ì˜" />
                    ì›ì˜
                </label>
                <label>
                    <input type="checkbox" name="member" value="ë¦¬ì¦ˆ" />
                    ë¦¬ì¦ˆ
                </label>
                <label>
                    <input type="checkbox" name="member" value="ì´ì„œ" />
                    ì´ì„œ
                </label>
                </fieldset>
                <fieldset>
                <legend>í…ìŠ¤íŠ¸ ê²€ìƒ‰</legend>
                <input type="text" id="filter-text" name="filter-text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
                </fieldset>
                <button type="submit">ê²€ìƒ‰</button>
            </form>
            </div>
        </div>
        <!-- ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥ ëª¨ë‹¬ -->
        <div id="export-modal" class="modal" style="display: none;">
          <div class="modal-content">
              <span id="export-modal-close" class="close">&times;</span>
              <h3>í¬í† ì¹´ë“œ ì‹œíŠ¸ ì¶œë ¥</h3>
              <form id="export-form">
                  <fieldset>
                      <legend>ê·¸ë£¹ ì„ íƒ</legend>
                      <label><input type="radio" name="group" value="IVE" checked> ì•„ì´ë¸Œ</label>
                      <label><input type="radio" name="group" value="IZONE"> ì•„ì´ì¦ˆì›</label>
                  </fieldset>
                  <fieldset>
                      <legend>ë©¤ë²„ ì„ íƒ</legend>
                      <label><input type="checkbox" name="member" value="ìœ ì§„"> ìœ ì§„</label>
                      <label><input type="checkbox" name="member" value="ê°€ì„"> ê°€ì„</label>
                      <label><input type="checkbox" name="member" value="ë ˆì´"> ë ˆì´</label>
                      <label><input type="checkbox" name="member" value="ì›ì˜"> ì›ì˜</label>
                      <label><input type="checkbox" name="member" value="ë¦¬ì¦ˆ"> ë¦¬ì¦ˆ</label>
                      <label><input type="checkbox" name="member" value="ì´ì„œ"> ì´ì„œ</label>
                  </fieldset>
                  <button type="submit">ì‹œíŠ¸ ìƒì„±</button>
              </form>
          </div>
        </div>
          <!-- ì¹œêµ¬ UUID ì…ë ¥ ëª¨ë‹¬ -->
         <div id="friend-modal" class="modal"><div class="modal-content">
          <span id="friend-modal-close" class="close">&times;</span>
          <h3>ì¹œêµ¬ UUID ì…ë ¥</h3>
          <input id="friend-uuid" placeholder="ì¹œêµ¬ UUID" style="width:100%">
          <button id="friend-add-confirm">ì¶”ê°€</button></div></div>

	<!-- í•˜ë‹¨ ìš°ì¸¡ FAB ë²„íŠ¼ -->
        <button
        id="categoryToggleBtn"
        class="floating-btn left"
        title="ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°"
      >ğŸ·ï¸</button>
        <button id="fab">+</button>
        <!-- FAB ëª¨ë‹¬: ìœ ì € ë°ì´í„°/ê´€ë¦¬ì ë©”ë‰´ -->
        <div id="user-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="user-modal-close" class="close">&times;</span>
            <h3>ìœ ì € ë°ì´í„° ë° ê´€ë¦¬ì ë©”ë‰´</h3>
            <ul>
                <li><button id="load-user-data">ìœ ì € ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button></li>
                <li><button id="reset-checks">ì²´í¬ ìƒíƒœ ì´ˆê¸°í™”</button></li>
                <li><button id="export-sheet">ì´ë¯¸ì§€ ì‹œíŠ¸ ì¶œë ¥</button></li>
                <li><button id="add-friend">ì¹œêµ¬ ì¶”ê°€</button></li>
            </ul>
            </div>
        </div>
       <!-- âœ… html2canvas ë“± ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
        <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

        <script>
            /* ==========================================================
            ğŸ“Œ pocalist.js (ë¦¬íŒ©í„°ë§ ë²„ì „)
            - ì¤‘ë³µ ì œê±°
            - ì—­í• ë³„ë¡œ ì„¹ì…˜í™”
            - ìì„¸í•œ í•œê¸€ ì£¼ì„ ì¶”ê°€
            ========================================================== */

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 0. ì „ì—­ ìƒíƒœ & í—¬í¼ í•¨ìˆ˜
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          let currentView       = 'id';                       // 'id' | 'category'
          let viewOwner         = 'self';                     // 'self' | 'friend'
          let currentFriendUUID = localStorage.getItem('lastFriendUUID') || null;
          const PAGE_SIZE       = 50;                         // í•œ í˜ì´ì§€ë‹¹ ì´ë¯¸ì§€ ê°œìˆ˜
          const LONG_PRESS      = 500;                        // í„°ì¹˜ ì‹œ ë¡± í”„ë ˆìŠ¤ ê¸°ì¤€(ms)
          const TAP_THRESHOLD   = 200;                        // í„°ì¹˜ ì‹œ íƒ­ ê¸°ì¤€(ms)

          // ì§§ì€ ì…€ë ‰í„° ë„ìš°ë¯¸
          const $  = (sel,  scope = document) => scope.querySelector(sel);
          const $$ = (sel, scope = document) => Array.from(scope.querySelectorAll(sel));

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 1. ëª¨ë‹¬(ìƒì„¸ë³´ê¸°) ê´€ë ¨ ê¸°ëŠ¥
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          function showModal(img) {
            const $modal     = $('#photo-modal');
            const $modalImg  = $('#modal-image');
            const $modalInfo = $('#modal-info');

            // ì´ë¯¸ì§€ ë° ë©”íƒ€ë°ì´í„° ì„¤ì •
            $modalImg.src = img.src;
            $modalInfo.innerHTML = `
              <p>${img.dataset.group   || ''}</p>
              <p>${img.dataset.member  || ''}</p>
              <p>${img.dataset.category || ''} ${img.dataset.title || ''}</p>
              <p>${img.dataset.version || ''}</p>
              <p>#${img.dataset.unique}</p>
            `;

            // ëª¨ë‹¬ í‘œì‹œ
            $modal.style.display = 'block';
          }

          // ëª¨ë‹¬ ìš°í´ë¦­ ì°¨ë‹¨
          $('#photo-modal').addEventListener('contextmenu', e => e.preventDefault());
          $('#modal-image').addEventListener('contextmenu',   e => e.preventDefault());

          // ëª¨ë‹¬ ë‹«ê¸° (X ë²„íŠ¼ ë° ë°°ê²½ í´ë¦­)
          $('#modal-close').addEventListener('click', () => $('#photo-modal').style.display = 'none');
          $('#photo-modal').addEventListener('click', e => {
            if (e.target === $('#photo-modal')) $('#photo-modal').style.display = 'none';
          });

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 2. í˜ì´ì§€ë„¤ì´ì…˜ & ì´ë¯¸ì§€ ë¡œë”©
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          let allImages = [];    // APIì—ì„œ ë°›ì•„ì˜¨ ì „ì²´ ì´ë¯¸ì§€ ë°ì´í„°
          let page      = 0;     // í˜„ì¬ í˜ì´ì§€ ì¸ë±ìŠ¤
          let loading   = false; // ë¡œë”© í”Œë˜ê·¸

          async function loadImages() {
            // ì„œë²„ì—ì„œ ì´ë¯¸ì§€ URL ëª©ë¡ì„ ê°€ì ¸ì˜´
            const res = await fetch('https://pocali-backend.onrender.com/api/images');
            allImages  = await res.json();
            page       = 0;
            renderPage();
          }

          function renderPage() {
            if (loading) return;
            loading = true;

            const start = page * PAGE_SIZE;
            const chunk = allImages.slice(start, start + PAGE_SIZE);
            if (!chunk.length) { loading = false; return; }

            if (page === 0) $('#photo-grid').innerHTML = '';

            chunk.forEach(image => {
              // ì¹´ë“œ ì»¨í…Œì´ë„ˆ ë° ì´ë¯¸ì§€ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
              const container = document.createElement('div');
              container.className = 'photo-card-container';

              const img = document.createElement('img');
              img.className = 'photo-card';
              img.src   = image.url;
              img.alt   = `${image.group} ${image.member} ${image.category} ${image.title} ${image.version} #${image.unique_id}`;
              img.dataset = {
                group:   image.group,
                member:  image.member,
                category:image.category,
                title:   image.title,
                version: image.version,
                unique:  image.unique_id
              };

              bindCardEvents(img);
              container.appendChild(img);
              $('#photo-grid').appendChild(container);
            });

            page += 1;
            loading = false;
            updateCount();
          }

          // ë¬´í•œ ìŠ¤í¬ë¡¤
          window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
              renderPage();
            }
          });

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 3. ì¹´ë“œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          function bindCardEvents(img) {
            // ë”ë¸”í´ë¦­ â†’ ë³´ìœ  í† ê¸€
            img.addEventListener('dblclick', () => {
              if (viewOwner !== 'self') return;
              toggleCheck(img);
            });

            // í„°ì¹˜ ê¸°ë°˜ ë¡±í”„ë ˆìŠ¤ & íƒ­ ì²˜ë¦¬
            let pressStart, pressTimer;
            img.addEventListener('pointerdown', e => {
              if (viewOwner !== 'self') return;
              pressStart = performance.now();
              pressTimer = setTimeout(() => showModal(img), LONG_PRESS);
            });
            img.addEventListener('pointerup', e => {
              clearTimeout(pressTimer);
              const delta = performance.now() - pressStart;
              if (e.pointerType === 'touch' && delta < TAP_THRESHOLD) toggleCheck(img);
            });
            img.addEventListener('pointerleave', () => clearTimeout(pressTimer));

            // ìš°í´ë¦­ â†’ ìƒì„¸ë³´ê¸°
            img.addEventListener('contextmenu', e => {
              e.preventDefault();
              showModal(img);
            });
          }

          // ë³´ìœ  í† ê¸€ í•¨ìˆ˜
          function toggleCheck(img) {
            img.classList.toggle('checked');
            const data = JSON.parse(localStorage.getItem('userData') || '{}');
            data[img.dataset.unique] = img.classList.contains('checked');
            localStorage.setItem('userData', JSON.stringify(data));
            syncLocalDataToServer();
            updateCount();
          }

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 4. ê²€ìƒ‰ ë° í•„í„°
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          $('#search-input').addEventListener('input', () => {
            const q = $('#search-input').value.trim().toLowerCase();
            allImages = q ?
              allImages.filter(img =>
                img.group.toLowerCase().includes(q) ||
                img.member.toLowerCase().includes(q) ||
                img.category.toLowerCase().includes(q) ||
                img.title.toLowerCase().includes(q)
              ) :
              allImages;  // ë¹ˆ ê²€ìƒ‰ì–´ë©´ ì „ì²´ ë¡œë“œ
            page = 0;
            renderPage();
          });

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 5. ë·° ì „í™˜ ë° í•„í„° ì ìš©
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          $('#categoryToggleBtn').addEventListener('click', () => {
            currentView = currentView === 'id' ? 'category' : 'id';
            const btn = $('#categoryToggleBtn');
            btn.textContent = currentView === 'id' ? 'ğŸ·ï¸' : 'ğŸ”¢';
            btn.title       = currentView === 'id' ? 'ì¹´í…Œê³ ë¦¬ë³„ ë³´ê¸°' : 'ê³ ìœ ë²ˆí˜¸ ìˆœ ë³´ê¸°';
            applyFilters();
          });

          $('#view-toggle').addEventListener('click', () => {
            if (viewOwner === 'friend') loadSelfDeck();
            else if (currentFriendUUID) loadFriendDeck(currentFriendUUID);
            else alert('ë¨¼ì € ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!');
          });

          function applyFilters() {
            const query = $('#search-input').value.trim().toLowerCase();
            const filtered = $$('.photo-card-container').filter(div => {
              const img = $('.photo-card', div);
              const textOK = !query || img.alt.toLowerCase().includes(query);
              // TODO: advancedFilters ì ìš©
              return textOK;
            });

            if (currentView === 'category') showByCategory(filtered);
            else showById(filtered);
          }

          // ID ì •ë ¬ ë·°
          function showById(list = null) {
            const containers = (list || $$('.photo-card-container')).slice();
            containers.sort((a, b) =>
              +$('.photo-card', b).dataset.unique - +$('.photo-card', a).dataset.unique
            );
            render(containers);
          }

          // ì¹´í…Œê³ ë¦¬ë³„ ë·°
          function showByCategory(list = null) {
            const buckets = {};
            (list || $$('.photo-card-container')).forEach(div => {
              const img = $('.photo-card', div);
              const key = [img.dataset.category, img.dataset.title, img.dataset.version]
                .filter(Boolean).join(' | ');
              (buckets[key] = buckets[key] || []).push(div);
            });

            const grid = $('#photo-grid');
            grid.innerHTML = '';
            Object.entries(buckets)
              .sort(([,a],[,b]) =>
                +$('.photo-card', b[0]).dataset.unique - +$('.photo-card', a[0]).dataset.unique
              )
              .forEach(([header, cards]) => {
                const h2 = document.createElement('h2');
                h2.textContent  = header;
                h2.style.margin = '16px 0 8px';
                grid.appendChild(h2);

                cards.sort((a,b) =>
                  +$('.photo-card', b).dataset.unique - +$('.photo-card', a).dataset.unique
                ).forEach(div => grid.appendChild(div));
              });

            updateCount();
          }

          function render(containers) {
            const grid = $('#photo-grid');
            grid.innerHTML = '';
            containers.forEach(c => grid.appendChild(c));
            updateCount();
          }

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 6. ë³´ìœ  ì¹´ë“œ í‘œì‹œ (Self / Friend)
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          function loadSelfDeck() {
            const myData = JSON.parse(localStorage.getItem('userData') || '{}');
            $$('.photo-card').forEach(img => {
              img.classList.toggle('checked', !!myData[img.dataset.unique]);
              img.style.pointerEvents = '';
            });
            viewOwner = 'self';
            $('#view-toggle').textContent = 'ğŸ‘¥ ì¹œêµ¬ë³´ê¸°';
            updateCount();
          }

          async function loadFriendDeck(uuid) {
            const res = await fetch(`/api/friend/${uuid}/collection`);
            if (!res.ok) return alert('ì¹œêµ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            const friendData = (await res.json()).data || {};

            $$('.photo-card').forEach(img => {
              img.classList.toggle('checked', !!friendData[img.dataset.unique]);
              img.style.pointerEvents = 'none';
            });
            viewOwner = 'friend';
            currentFriendUUID = uuid;
            localStorage.setItem('lastFriendUUID', uuid);
            $('#view-toggle').textContent = 'ğŸ‘¤ ë‚´ ì¹´ë“œë³´ê¸°';
            updateCount();
          }

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 7. ì¹´ìš´í„° ì—…ë°ì´íŠ¸
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          function updateCount() {
            const visible = $$('.photo-card-container').filter(c => c.offsetParent !== null);
            const have    = visible.filter(c => $('.photo-card', c).classList.contains('checked'));
            $('#count-display').textContent = `${have.length} / ${visible.length}`;
          }

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 8. ì„œë²„ ë™ê¸°í™” (Polling)
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          async function syncLocalDataToServer() {
            const me = localStorage.getItem('myUUID');
            if (!me) return;
            const data = JSON.parse(localStorage.getItem('userData') || '{}');
            await fetch(`/api/user/${me}`, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({data})
            });
          }

          setInterval(() => {
            if (viewOwner !== 'self') return;
            const me = localStorage.getItem('myUUID');
            if (!me) return;
            fetch(`/api/user/${me}`).then(r => r.json()).then(json => {
              const userData = JSON.parse(json.data || '{}');
              localStorage.setItem('userData', JSON.stringify(userData));
              $$('.photo-card').forEach(img => {
                img.classList.toggle('checked', !!userData[img.dataset.unique]);
              });
              updateCount();
            });
          }, 10000);

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 9. UI ëª¨ë‹¬ & ë²„íŠ¼ ì¡°ì‘ (FAB, ì¹œêµ¬ ì¶”ê°€, ë¦¬ì…‹, ì‹œíŠ¸ ì¶œë ¥ ë“±)
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // FAB: ìœ ì € ì„¤ì • ì—´ê¸°
          $('#fab').addEventListener('click', () => $('#user-modal').style.display = 'block');
          $('#user-modal-close').addEventListener('click', () => $('#user-modal').style.display = 'none');

          // ì¹œêµ¬ ì¶”ê°€
          $('#add-friend').addEventListener('click', () => {
            $('#user-modal').style.display   = 'none';
            $('#friend-modal').style.display = 'block';
          });
          $('#friend-close').addEventListener('click', () => $('#friend-modal').style.display = 'none');
          $('#friend-add-confirm').addEventListener('click', async () => {
            const me     = localStorage.getItem('myUUID');
            const friend = $('#friend-uuid').value.trim();
            if (!me || !friend) return alert('UUIDë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            const ok = await fetch('/api/friends',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({me,friend})}).then(r=>r.ok);
            if (!ok) return alert('ë“±ë¡ ì‹¤íŒ¨');
            localStorage.setItem('lastFriendUUID', friend);
            $('#friend-modal').style.display = 'none';
            loadFriendDeck(friend);
            alert('ì¹œêµ¬ ë“±ë¡ ì™„ë£Œ!');
          });

          // ì²´í¬ ì´ˆê¸°í™”
          $('#reset-checks').addEventListener('click', async () => {
            if (!confirm('ëª¨ë“  ì²´í¬ë¥¼ í•´ì œí• ê¹Œìš”?')) return;
            $$('.photo-card').forEach(img => img.classList.remove('checked'));
            localStorage.removeItem('userData');
            updateCount();
            const me = localStorage.getItem('myUUID');
            if (me) await fetch(`/api/user/${me}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:{}})});
          });

          // ì‹œíŠ¸ ì¶œë ¥
          $('#export-sheet').addEventListener('click', () => {
            $('#user-modal').style.display   = 'none';
            $('#export-modal').style.display = 'block';
          });
          $('#export-modal-close').addEventListener('click', () => $('#export-modal').style.display = 'none');
          $('#export-form').addEventListener('submit', e => {
            e.preventDefault();
            const fd      = new FormData($('#export-form'));
            const group   = fd.get('group');
            const members = fd.getAll('member');
            if (!members.length) return alert('ë©¤ë²„ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”!');

            const sel = $$('.photo-card').filter(img => img.dataset.group === group && members.includes(img.dataset.member));
            if (!sel.length) return alert('í•´ë‹¹ ì¡°ê±´ì˜ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
            $('#export-modal').style.display = 'none';
            generateImageSheet(sel);
          });

          // ìƒì„¸ê²€ìƒ‰ ëª¨ë‹¬
          $('#search-detail-btn').addEventListener('click', () => $('#detail-search-modal').style.display = 'block');
          $('#detail-search-modal-close').addEventListener('click', () => $('#detail-search-modal').style.display = 'none');
          $('#detail-search-modal').addEventListener('click', e => { if (e.target === $('#detail-search-modal')) $('#detail-search-modal').style.display = 'none'; });

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 10. ì´ë¯¸ì§€ ì‹œíŠ¸ ìƒì„± & ë‹¤ìš´ë¡œë“œ
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          function generateImageSheet(cards) {
            const overlay = document.createElement('div'); overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:9999; display:flex; flex-direction:column; align-items:center; overflow:auto;';
            const grid    = document.createElement('div');    grid.style.cssText    = 'display:grid; grid-template-columns:repeat(16,1fr); gap:8px; padding:24px; max-width:100%; overflow-x:auto;';
            overlay.appendChild(grid);
            cards.forEach(img => { const clone = img.cloneNode(); clone.style.width='100%'; clone.style.opacity = img.classList.contains('checked')?'1':'0.4'; grid.appendChild(clone); });
            const btnBar = document.createElement('div'); btnBar.style.cssText = 'position:fixed; top:20px; right:20px; display:flex; gap:8px;'; overlay.appendChild(btnBar);
            const close  = Object.assign(document.createElement('button'),{textContent:'ë‹«ê¸°',onclick:()=>document.body.removeChild(overlay)});
            const save   = Object.assign(document.createElement('button'),{textContent:'ì´ë¯¸ì§€ ì €ì¥',onclick:()=>downloadAsImage(grid)});
            [close,save].forEach(b=>{b.style.padding='8px 14px'; b.style.border='none';});
            close.style.background='#f44336'; save.style.background='#4CAF50'; save.style.color='#fff'; close.style.color='#fff';
            btnBar.append(close, save);
            document.body.appendChild(overlay);
          }

          function downloadAsImage(target) {
            const loader = Object.assign(document.createElement('div'),{textContent:'ì´ë¯¸ì§€ ìƒì„± ì¤‘â€¦'}); loader.style.cssText='position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.6); color:#fff; font-size:1.2rem; z-index:10000;'; document.body.appendChild(loader);
            html2canvas(target, {scale:2}).then(canvas => { const link=document.createElement('a'); link.download=`pocalist_sheet_${Date.now()}.png`; link.href=canvas.toDataURL('image/png'); link.click(); document.body.removeChild(loader); }).catch(err=>{ alert('ì €ì¥ ì‹¤íŒ¨: '+err.message); document.body.removeChild(loader); });
          }

          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // 11. ì´ˆê¸°í™”
          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          document.addEventListener('DOMContentLoaded', () => {
            loadImages();      // ì´ë¯¸ì§€ fetch & ë Œë”ë§ ì‹œì‘
            showById();        // ê¸°ë³¸ ì •ë ¬
            loadSelfDeck();    // ë‚´ ì¹´ë“œ í‘œì‹œ
            updateCount();     // ì¹´ìš´í„° ì´ˆê¸°í™”
          });

          </script>
               
      </body>
      </html>