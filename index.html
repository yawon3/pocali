<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>pocalist</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
        <!-- 상단 검색창 & 카운터 -->
        <header id="search-header">
          <input type="text" id="search-input" placeholder="포토카드 검색..." />
          <button id="search-detail-btn">+</button>
          <div id="count-display" style="text-align:center; font-weight:bold; margin-top: 5px;">
            0 / 0
          </div>
          <button id="view-toggle">👥 친구보기</button>  <!-- ← 새 버튼 -->
        </header>
  <!-- 카드 그리드 -->        
	<div id="photo-grid">  
    </div>
    <!-- 카드 상세 모달 -->
    <div id="photo-modal" class="modal" style="display: none;">
     <div class="modal-content">
      <span id="modal-close" class="close">&times;</span>
      <img id="modal-image" src="" alt="확대된 포토카드" draggable="false" />
      <div id="modal-info">
        <!-- 파일명 파싱 등으로 추후 상세 정보를 표시할 예정 -->
        </div>
      </div>
    </div>
    <!-- 유저 데이터 모달 -->
   <div id="user-data-modal" class="modal" style="display: none;">
   <div class="modal-content">
    <span id="user-data-modal-close" class="close">&times;</span>
    <h3>UUID 데이터 관리</h3>

    <!-- 내 UUID 영역 -->
    <label for="my-uuid">내 UUID:</label>
    <input type="text" id="my-uuid" readonly style="width: 100%;" />

    <!-- 다른 기기의 UUID 입력 영역 -->
    <label for="other-uuid">다른 기기의 UUID 불러오기:</label>
    <input type="text" id="other-uuid" placeholder="다른 디바이스의 UUID 입력" style="width: 100%;" />
    <button id="load-other-data">데이터 불러오기</button>

    <!-- 메시지 또는 에러 표시 -->
    <div id="uuid-msg" style="margin-top: 10px; color: red;"></div>
    </div>
   </div>

         <!-- 상세 검색 모달 -->
        <div id="detail-search-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="detail-search-modal-close" class="close">&times;</span>
            <h3>상세 검색 옵션</h3>
            <form id="detail-search-form">
                <fieldset>
                <legend>그룹</legend>
                <label>
                    <input type="checkbox" name="group" value="IVE" />
                    아이브
                </label>
                <label>
                    <input type="checkbox" name="group" value="IZONE" />
                    아이즈원
                </label>
                </fieldset>
                <fieldset>
                <legend>멤버</legend>
                <label>
                    <input type="checkbox" name="member" value="유진" />
                    유진
                </label>
                <label>
                    <input type="checkbox" name="member" value="가을" />
                    가을
                </label>
                <label>
                    <input type="checkbox" name="member" value="레이" />
                    레이
                </label>
                <label>
                    <input type="checkbox" name="member" value="원영" />
                    원영
                </label>
                <label>
                    <input type="checkbox" name="member" value="리즈" />
                    리즈
                </label>
                <label>
                    <input type="checkbox" name="member" value="이서" />
                    이서
                </label>
                </fieldset>
                <fieldset>
                <legend>텍스트 검색</legend>
                <input type="text" id="filter-text" name="filter-text" placeholder="검색어 입력" />
                </fieldset>
                <button type="submit">검색</button>
            </form>
            </div>
        </div>
        <!-- 이미지 시트 출력 모달 -->
        <div id="export-modal" class="modal" style="display: none;">
          <div class="modal-content">
              <span id="export-modal-close" class="close">&times;</span>
              <h3>포토카드 시트 출력</h3>
              <form id="export-form">
                  <fieldset>
                      <legend>그룹 선택</legend>
                      <label><input type="radio" name="group" value="IVE" checked> 아이브</label>
                      <label><input type="radio" name="group" value="IZONE"> 아이즈원</label>
                  </fieldset>
                  <fieldset>
                      <legend>멤버 선택</legend>
                      <label><input type="checkbox" name="member" value="유진"> 유진</label>
                      <label><input type="checkbox" name="member" value="가을"> 가을</label>
                      <label><input type="checkbox" name="member" value="레이"> 레이</label>
                      <label><input type="checkbox" name="member" value="원영"> 원영</label>
                      <label><input type="checkbox" name="member" value="리즈"> 리즈</label>
                      <label><input type="checkbox" name="member" value="이서"> 이서</label>
                  </fieldset>
                  <button type="submit">시트 생성</button>
              </form>
          </div>
        </div>
          <!-- 친구 UUID 입력 모달 -->
         <div id="friend-modal" class="modal"><div class="modal-content">
          <span id="friend-modal-close" class="close">&times;</span>
          <h3>친구 UUID 입력</h3>
          <input id="friend-uuid" placeholder="친구 UUID" style="width:100%">
          <button id="friend-add-confirm">추가</button></div></div>

	<!-- 하단 우측 FAB 버튼 -->
        <button
        id="categoryToggleBtn"
        class="floating-btn left"
        title="카테고리별 보기"
      >🏷️</button>
        <button id="fab">+</button>
        <!-- FAB 모달: 유저 데이터/관리자 메뉴 -->
        <div id="user-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="user-modal-close" class="close">&times;</span>
            <h3>유저 데이터 및 관리자 메뉴</h3>
            <ul>
                <li><button id="load-user-data">유저 데이터 불러오기</button></li>
                <li><button id="reset-checks">체크 상태 초기화</button></li>
                <li><button id="export-sheet">이미지 시트 출력</button></li>
                <li><button id="add-friend">친구 추가</button></li>
            </ul>
            </div>
        </div>
       <!-- ✅ html2canvas 등 외부 라이브러리 로드 -->
        <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

        <script>
            /* ==========================================================
            📌 pocalist.js (리팩터링 버전)
            - 중복 제거
            - 역할별로 섹션화
            - 자세한 한글 주석 추가
            ========================================================== */

          // ────────────────────────────────────────────────
          // 0. 전역 상태 & 헬퍼 함수
          // ────────────────────────────────────────────────
          let currentView       = 'id';                       // 'id' | 'category'
          let viewOwner         = 'self';                     // 'self' | 'friend'
          let currentFriendUUID = localStorage.getItem('lastFriendUUID') || null;
          const PAGE_SIZE       = 50;                         // 한 페이지당 이미지 개수
          const LONG_PRESS      = 500;                        // 터치 시 롱 프레스 기준(ms)
          const TAP_THRESHOLD   = 200;                        // 터치 시 탭 기준(ms)

          // 짧은 셀렉터 도우미
          const $  = (sel,  scope = document) => scope.querySelector(sel);
          const $$ = (sel, scope = document) => Array.from(scope.querySelectorAll(sel));

          // ────────────────────────────────────────────────
          // 1. 모달(상세보기) 관련 기능
          // ────────────────────────────────────────────────
          function showModal(img) {
            const $modal     = $('#photo-modal');
            const $modalImg  = $('#modal-image');
            const $modalInfo = $('#modal-info');

            // 이미지 및 메타데이터 설정
            $modalImg.src = img.src;
            $modalInfo.innerHTML = `
              <p>${img.dataset.group   || ''}</p>
              <p>${img.dataset.member  || ''}</p>
              <p>${img.dataset.category || ''} ${img.dataset.title || ''}</p>
              <p>${img.dataset.version || ''}</p>
              <p>#${img.dataset.unique}</p>
            `;

            // 모달 표시
            $modal.style.display = 'block';
          }

          // 모달 우클릭 차단
          $('#photo-modal').addEventListener('contextmenu', e => e.preventDefault());
          $('#modal-image').addEventListener('contextmenu',   e => e.preventDefault());

          // 모달 닫기 (X 버튼 및 배경 클릭)
          $('#modal-close').addEventListener('click', () => $('#photo-modal').style.display = 'none');
          $('#photo-modal').addEventListener('click', e => {
            if (e.target === $('#photo-modal')) $('#photo-modal').style.display = 'none';
          });

          // ────────────────────────────────────────────────
          // 2. 페이지네이션 & 이미지 로딩
          // ────────────────────────────────────────────────
          let allImages = [];    // API에서 받아온 전체 이미지 데이터
          let page      = 0;     // 현재 페이지 인덱스
          let loading   = false; // 로딩 플래그

          async function loadImages() {
            // 서버에서 이미지 URL 목록을 가져옴
            const res = await fetch('https://pocali-backend.onrender.com/api/images');
            allImages  = await res.json();
            page       = 0;
            renderPage();
          }

          function renderPage() {
            if (loading) return;
            loading = true;

            const start = page * PAGE_SIZE;
            const chunk = allImages.slice(start, start + PAGE_SIZE);
            if (!chunk.length) { loading = false; return; }

            if (page === 0) $('#photo-grid').innerHTML = '';

            chunk.forEach(image => {
              // 카드 컨테이너 및 이미지 엘리먼트 생성
              const container = document.createElement('div');
              container.className = 'photo-card-container';

              const img = document.createElement('img');
              img.className = 'photo-card';
              img.src   = image.url;
              img.alt   = `${image.group} ${image.member} ${image.category} ${image.title} ${image.version} #${image.unique_id}`;
              img.dataset = {
                group:   image.group,
                member:  image.member,
                category:image.category,
                title:   image.title,
                version: image.version,
                unique:  image.unique_id
              };

              bindCardEvents(img);
              container.appendChild(img);
              $('#photo-grid').appendChild(container);
            });

            page += 1;
            loading = false;
            updateCount();
          }

          // 무한 스크롤
          window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
              renderPage();
            }
          });

          // ────────────────────────────────────────────────
          // 3. 카드 이벤트 바인딩
          // ────────────────────────────────────────────────
          function bindCardEvents(img) {
            // 더블클릭 → 보유 토글
            img.addEventListener('dblclick', () => {
              if (viewOwner !== 'self') return;
              toggleCheck(img);
            });

            // 터치 기반 롱프레스 & 탭 처리
            let pressStart, pressTimer;
            img.addEventListener('pointerdown', e => {
              if (viewOwner !== 'self') return;
              pressStart = performance.now();
              pressTimer = setTimeout(() => showModal(img), LONG_PRESS);
            });
            img.addEventListener('pointerup', e => {
              clearTimeout(pressTimer);
              const delta = performance.now() - pressStart;
              if (e.pointerType === 'touch' && delta < TAP_THRESHOLD) toggleCheck(img);
            });
            img.addEventListener('pointerleave', () => clearTimeout(pressTimer));

            // 우클릭 → 상세보기
            img.addEventListener('contextmenu', e => {
              e.preventDefault();
              showModal(img);
            });
          }

          // 보유 토글 함수
          function toggleCheck(img) {
            img.classList.toggle('checked');
            const data = JSON.parse(localStorage.getItem('userData') || '{}');
            data[img.dataset.unique] = img.classList.contains('checked');
            localStorage.setItem('userData', JSON.stringify(data));
            syncLocalDataToServer();
            updateCount();
          }

          // ────────────────────────────────────────────────
          // 4. 검색 및 필터
          // ────────────────────────────────────────────────
          $('#search-input').addEventListener('input', () => {
            const q = $('#search-input').value.trim().toLowerCase();
            allImages = q ?
              allImages.filter(img =>
                img.group.toLowerCase().includes(q) ||
                img.member.toLowerCase().includes(q) ||
                img.category.toLowerCase().includes(q) ||
                img.title.toLowerCase().includes(q)
              ) :
              allImages;  // 빈 검색어면 전체 로드
            page = 0;
            renderPage();
          });

          // ────────────────────────────────────────────────
          // 5. 뷰 전환 및 필터 적용
          // ────────────────────────────────────────────────
          $('#categoryToggleBtn').addEventListener('click', () => {
            currentView = currentView === 'id' ? 'category' : 'id';
            const btn = $('#categoryToggleBtn');
            btn.textContent = currentView === 'id' ? '🏷️' : '🔢';
            btn.title       = currentView === 'id' ? '카테고리별 보기' : '고유번호 순 보기';
            applyFilters();
          });

          $('#view-toggle').addEventListener('click', () => {
            if (viewOwner === 'friend') loadSelfDeck();
            else if (currentFriendUUID) loadFriendDeck(currentFriendUUID);
            else alert('먼저 친구를 추가하세요!');
          });

          function applyFilters() {
            const query = $('#search-input').value.trim().toLowerCase();
            const filtered = $$('.photo-card-container').filter(div => {
              const img = $('.photo-card', div);
              const textOK = !query || img.alt.toLowerCase().includes(query);
              // TODO: advancedFilters 적용
              return textOK;
            });

            if (currentView === 'category') showByCategory(filtered);
            else showById(filtered);
          }

          // ID 정렬 뷰
          function showById(list = null) {
            const containers = (list || $$('.photo-card-container')).slice();
            containers.sort((a, b) =>
              +$('.photo-card', b).dataset.unique - +$('.photo-card', a).dataset.unique
            );
            render(containers);
          }

          // 카테고리별 뷰
          function showByCategory(list = null) {
            const buckets = {};
            (list || $$('.photo-card-container')).forEach(div => {
              const img = $('.photo-card', div);
              const key = [img.dataset.category, img.dataset.title, img.dataset.version]
                .filter(Boolean).join(' | ');
              (buckets[key] = buckets[key] || []).push(div);
            });

            const grid = $('#photo-grid');
            grid.innerHTML = '';
            Object.entries(buckets)
              .sort(([,a],[,b]) =>
                +$('.photo-card', b[0]).dataset.unique - +$('.photo-card', a[0]).dataset.unique
              )
              .forEach(([header, cards]) => {
                const h2 = document.createElement('h2');
                h2.textContent  = header;
                h2.style.margin = '16px 0 8px';
                grid.appendChild(h2);

                cards.sort((a,b) =>
                  +$('.photo-card', b).dataset.unique - +$('.photo-card', a).dataset.unique
                ).forEach(div => grid.appendChild(div));
              });

            updateCount();
          }

          function render(containers) {
            const grid = $('#photo-grid');
            grid.innerHTML = '';
            containers.forEach(c => grid.appendChild(c));
            updateCount();
          }

          // ────────────────────────────────────────────────
          // 6. 보유 카드 표시 (Self / Friend)
          // ────────────────────────────────────────────────
          function loadSelfDeck() {
            const myData = JSON.parse(localStorage.getItem('userData') || '{}');
            $$('.photo-card').forEach(img => {
              img.classList.toggle('checked', !!myData[img.dataset.unique]);
              img.style.pointerEvents = '';
            });
            viewOwner = 'self';
            $('#view-toggle').textContent = '👥 친구보기';
            updateCount();
          }

          async function loadFriendDeck(uuid) {
            const res = await fetch(`/api/friend/${uuid}/collection`);
            if (!res.ok) return alert('친구 데이터를 불러올 수 없습니다.');
            const friendData = (await res.json()).data || {};

            $$('.photo-card').forEach(img => {
              img.classList.toggle('checked', !!friendData[img.dataset.unique]);
              img.style.pointerEvents = 'none';
            });
            viewOwner = 'friend';
            currentFriendUUID = uuid;
            localStorage.setItem('lastFriendUUID', uuid);
            $('#view-toggle').textContent = '👤 내 카드보기';
            updateCount();
          }

          // ────────────────────────────────────────────────
          // 7. 카운터 업데이트
          // ────────────────────────────────────────────────
          function updateCount() {
            const visible = $$('.photo-card-container').filter(c => c.offsetParent !== null);
            const have    = visible.filter(c => $('.photo-card', c).classList.contains('checked'));
            $('#count-display').textContent = `${have.length} / ${visible.length}`;
          }

          // ────────────────────────────────────────────────
          // 8. 서버 동기화 (Polling)
          // ────────────────────────────────────────────────
          async function syncLocalDataToServer() {
            const me = localStorage.getItem('myUUID');
            if (!me) return;
            const data = JSON.parse(localStorage.getItem('userData') || '{}');
            await fetch(`/api/user/${me}`, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({data})
            });
          }

          setInterval(() => {
            if (viewOwner !== 'self') return;
            const me = localStorage.getItem('myUUID');
            if (!me) return;
            fetch(`/api/user/${me}`).then(r => r.json()).then(json => {
              const userData = JSON.parse(json.data || '{}');
              localStorage.setItem('userData', JSON.stringify(userData));
              $$('.photo-card').forEach(img => {
                img.classList.toggle('checked', !!userData[img.dataset.unique]);
              });
              updateCount();
            });
          }, 10000);

          // ────────────────────────────────────────────────
          // 9. UI 모달 & 버튼 조작 (FAB, 친구 추가, 리셋, 시트 출력 등)
          // ────────────────────────────────────────────────
          // FAB: 유저 설정 열기
          $('#fab').addEventListener('click', () => $('#user-modal').style.display = 'block');
          $('#user-modal-close').addEventListener('click', () => $('#user-modal').style.display = 'none');

          // 친구 추가
          $('#add-friend').addEventListener('click', () => {
            $('#user-modal').style.display   = 'none';
            $('#friend-modal').style.display = 'block';
          });
          $('#friend-close').addEventListener('click', () => $('#friend-modal').style.display = 'none');
          $('#friend-add-confirm').addEventListener('click', async () => {
            const me     = localStorage.getItem('myUUID');
            const friend = $('#friend-uuid').value.trim();
            if (!me || !friend) return alert('UUID를 입력하세요!');
            const ok = await fetch('/api/friends',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({me,friend})}).then(r=>r.ok);
            if (!ok) return alert('등록 실패');
            localStorage.setItem('lastFriendUUID', friend);
            $('#friend-modal').style.display = 'none';
            loadFriendDeck(friend);
            alert('친구 등록 완료!');
          });

          // 체크 초기화
          $('#reset-checks').addEventListener('click', async () => {
            if (!confirm('모든 체크를 해제할까요?')) return;
            $$('.photo-card').forEach(img => img.classList.remove('checked'));
            localStorage.removeItem('userData');
            updateCount();
            const me = localStorage.getItem('myUUID');
            if (me) await fetch(`/api/user/${me}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:{}})});
          });

          // 시트 출력
          $('#export-sheet').addEventListener('click', () => {
            $('#user-modal').style.display   = 'none';
            $('#export-modal').style.display = 'block';
          });
          $('#export-modal-close').addEventListener('click', () => $('#export-modal').style.display = 'none');
          $('#export-form').addEventListener('submit', e => {
            e.preventDefault();
            const fd      = new FormData($('#export-form'));
            const group   = fd.get('group');
            const members = fd.getAll('member');
            if (!members.length) return alert('멤버를 하나 이상 선택하세요!');

            const sel = $$('.photo-card').filter(img => img.dataset.group === group && members.includes(img.dataset.member));
            if (!sel.length) return alert('해당 조건의 카드가 없습니다.');
            $('#export-modal').style.display = 'none';
            generateImageSheet(sel);
          });

          // 상세검색 모달
          $('#search-detail-btn').addEventListener('click', () => $('#detail-search-modal').style.display = 'block');
          $('#detail-search-modal-close').addEventListener('click', () => $('#detail-search-modal').style.display = 'none');
          $('#detail-search-modal').addEventListener('click', e => { if (e.target === $('#detail-search-modal')) $('#detail-search-modal').style.display = 'none'; });

          // ────────────────────────────────────────────────
          // 10. 이미지 시트 생성 & 다운로드
          // ────────────────────────────────────────────────
          function generateImageSheet(cards) {
            const overlay = document.createElement('div'); overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:9999; display:flex; flex-direction:column; align-items:center; overflow:auto;';
            const grid    = document.createElement('div');    grid.style.cssText    = 'display:grid; grid-template-columns:repeat(16,1fr); gap:8px; padding:24px; max-width:100%; overflow-x:auto;';
            overlay.appendChild(grid);
            cards.forEach(img => { const clone = img.cloneNode(); clone.style.width='100%'; clone.style.opacity = img.classList.contains('checked')?'1':'0.4'; grid.appendChild(clone); });
            const btnBar = document.createElement('div'); btnBar.style.cssText = 'position:fixed; top:20px; right:20px; display:flex; gap:8px;'; overlay.appendChild(btnBar);
            const close  = Object.assign(document.createElement('button'),{textContent:'닫기',onclick:()=>document.body.removeChild(overlay)});
            const save   = Object.assign(document.createElement('button'),{textContent:'이미지 저장',onclick:()=>downloadAsImage(grid)});
            [close,save].forEach(b=>{b.style.padding='8px 14px'; b.style.border='none';});
            close.style.background='#f44336'; save.style.background='#4CAF50'; save.style.color='#fff'; close.style.color='#fff';
            btnBar.append(close, save);
            document.body.appendChild(overlay);
          }

          function downloadAsImage(target) {
            const loader = Object.assign(document.createElement('div'),{textContent:'이미지 생성 중…'}); loader.style.cssText='position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.6); color:#fff; font-size:1.2rem; z-index:10000;'; document.body.appendChild(loader);
            html2canvas(target, {scale:2}).then(canvas => { const link=document.createElement('a'); link.download=`pocalist_sheet_${Date.now()}.png`; link.href=canvas.toDataURL('image/png'); link.click(); document.body.removeChild(loader); }).catch(err=>{ alert('저장 실패: '+err.message); document.body.removeChild(loader); });
          }

          // ────────────────────────────────────────────────
          // 11. 초기화
          // ────────────────────────────────────────────────
          document.addEventListener('DOMContentLoaded', () => {
            loadImages();      // 이미지 fetch & 렌더링 시작
            showById();        // 기본 정렬
            loadSelfDeck();    // 내 카드 표시
            updateCount();     // 카운터 초기화
          });

          </script>
               
      </body>
      </html>