<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>pocalist</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
        <!-- 상단 검색창 & 카운터 -->
        <header id="search-header">
          <input type="text" id="search-input" placeholder="포토카드 검색..." />
          <button id="search-detail-btn">+</button>
          <div id="count-display" style="text-align:center; font-weight:bold; margin-top: 5px;">
            0 / 0
          </div>
          <button id="view-toggle">👥 친구보기</button>  <!-- ← 새 버튼 -->
        </header>
  <!-- 카드 그리드 -->        
	<div id="photo-grid">  
    </div>
    <!-- 카드 상세 모달 -->
    <div id="photo-modal" class="modal" style="display: none;">
     <div class="modal-content">
      <span id="modal-close" class="close">&times;</span>
      <img id="modal-image" src="" alt="확대된 포토카드" draggable="false" />
      <div id="modal-info">
        <!-- 파일명 파싱 등으로 추후 상세 정보를 표시할 예정 -->
        </div>
      </div>
    </div>
    <!-- 유저 데이터 모달 -->
   <div id="user-data-modal" class="modal" style="display: none;">
   <div class="modal-content">
    <span id="user-data-modal-close" class="close">&times;</span>
    <h3>UUID 데이터 관리</h3>

    <!-- 내 UUID 영역 -->
    <label for="my-uuid">내 UUID:</label>
    <input type="text" id="my-uuid" readonly style="width: 100%;" />

    <!-- 다른 기기의 UUID 입력 영역 -->
    <label for="other-uuid">다른 기기의 UUID 불러오기:</label>
    <input type="text" id="other-uuid" placeholder="다른 디바이스의 UUID 입력" style="width: 100%;" />
    <button id="load-other-data">데이터 불러오기</button>

    <!-- 메시지 또는 에러 표시 -->
    <div id="uuid-msg" style="margin-top: 10px; color: red;"></div>
    </div>
   </div>

         <!-- 상세 검색 모달 -->
        <div id="detail-search-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="detail-search-modal-close" class="close">&times;</span>
            <h3>상세 검색 옵션</h3>
            <form id="detail-search-form">
                <fieldset>
                <legend>그룹</legend>
                <label>
                    <input type="checkbox" name="group" value="IVE" />
                    아이브
                </label>
                <label>
                    <input type="checkbox" name="group" value="IZONE" />
                    아이즈원
                </label>
                </fieldset>
                <fieldset>
                <legend>멤버</legend>
                <label>
                    <input type="checkbox" name="member" value="유진" />
                    유진
                </label>
                <label>
                    <input type="checkbox" name="member" value="가을" />
                    가을
                </label>
                <label>
                    <input type="checkbox" name="member" value="레이" />
                    레이
                </label>
                <label>
                    <input type="checkbox" name="member" value="원영" />
                    원영
                </label>
                <label>
                    <input type="checkbox" name="member" value="리즈" />
                    리즈
                </label>
                <label>
                    <input type="checkbox" name="member" value="이서" />
                    이서
                </label>
                </fieldset>
                <fieldset>
                <legend>텍스트 검색</legend>
                <input type="text" id="filter-text" name="filter-text" placeholder="검색어 입력" />
                </fieldset>
                <button type="submit">검색</button>
            </form>
            </div>
        </div>
        <!-- 이미지 시트 출력 모달 -->
        <div id="export-modal" class="modal" style="display: none;">
          <div class="modal-content">
              <span id="export-modal-close" class="close">&times;</span>
              <h3>포토카드 시트 출력</h3>
              <form id="export-form">
                  <fieldset>
                      <legend>그룹 선택</legend>
                      <label><input type="radio" name="group" value="IVE" checked> 아이브</label>
                      <label><input type="radio" name="group" value="IZONE"> 아이즈원</label>
                  </fieldset>
                  <fieldset>
                      <legend>멤버 선택</legend>
                      <label><input type="checkbox" name="member" value="유진"> 유진</label>
                      <label><input type="checkbox" name="member" value="가을"> 가을</label>
                      <label><input type="checkbox" name="member" value="레이"> 레이</label>
                      <label><input type="checkbox" name="member" value="원영"> 원영</label>
                      <label><input type="checkbox" name="member" value="리즈"> 리즈</label>
                      <label><input type="checkbox" name="member" value="이서"> 이서</label>
                  </fieldset>
                  <button type="submit">시트 생성</button>
              </form>
          </div>
        </div>
          <!-- 친구 UUID 입력 모달 -->
         <div id="friend-modal" class="modal"><div class="modal-content">
          <span id="friend-modal-close" class="close">&times;</span>
          <h3>친구 UUID 입력</h3>
          <input id="friend-uuid" placeholder="친구 UUID" style="width:100%">
          <button id="friend-add-confirm">추가</button></div></div>

	<!-- 하단 우측 FAB 버튼 -->
        <button
        id="categoryToggleBtn"
        class="floating-btn left"
        title="카테고리별 보기"
      >🏷️</button>
        <button id="fab">+</button>
        <!-- FAB 모달: 유저 데이터/관리자 메뉴 -->
        <div id="user-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="user-modal-close" class="close">&times;</span>
            <h3>유저 데이터 및 관리자 메뉴</h3>
            <ul>
                <li><button id="load-user-data">유저 데이터 불러오기</button></li>
                <li><button id="reset-checks">체크 상태 초기화</button></li>
                <li><button id="export-sheet">이미지 시트 출력</button></li>
                <li><button id="add-friend">친구 추가</button></li>
            </ul>
            </div>
        </div>
        <!-- 로딩 화면 수정 부분 - Firebase Storage 이미지로 교체 -->
        <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: #f8f9fa; 
        display: flex; flex-direction: column; 
        align-items: center; justify-content: center; z-index: 9999; overflow: hidden;">
        
        <!-- 배경 카드 효과 - Firebase Storage URL로 변경 -->
        <div class="background-card" style="position: absolute; width: 150px; height: 210px; 
        background-image: url('https://firebasestorage.googleapis.com/v0/b/pocali.firebasestorage.app/o/images%2Fevent%2FIVE_AN_ARENA_351623.jpg?alt=media&token=8946eed9-55b7-422b-af30-f9249f684696');
        background-size: cover; background-position: center;
        border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        top: 15%; left: 10%; transform: rotate(-8deg); z-index: -1;"></div>
      
        <div class="background-card" style="position: absolute; width: 150px; height: 210px; 
        background-image: url('https://firebasestorage.googleapis.com/v0/b/pocali.firebasestorage.app/o/images%2Fevent%2FIVE_AN_ARENA_351624.jpg?alt=media&token=90ecd86b-5618-4f6d-bf9d-41aa415bd85b');
        background-size: cover; background-position: center;
        border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        top: 25%; right: 10%; transform: rotate(12deg); z-index: -1;"></div>
      
        <div class="background-card" style="position: absolute; width: 120px; height: 180px; 
        background-image: url('https://firebasestorage.googleapis.com/v0/b/pocali.firebasestorage.app/o/images%2Fevent%2FIVE_AN_ARENA_351629.jpg?alt=media&token=c4524501-6622-46e6-9616-02b122f37b4d');
        background-size: cover; background-position: center;
        border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        bottom: 20%; left: 15%; transform: rotate(5deg); z-index: -1;"></div>
      
        <div class="background-card" style="position: absolute; width: 135px; height: 190px; 
        background-image: url('https://firebasestorage.googleapis.com/v0/b/pocali.firebasestorage.app/o/images%2Fevent%2FIVE_AN_ARENA_351631.jpg?alt=media&token=6c3625da-57ab-4206-a4c7-d9a9b2a71669g');
        background-size: cover; background-position: center;
        border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        bottom: 15%; right: 15%; transform: rotate(-15deg); z-index: -1;"></div>

        <!-- 로고 영역 - 흰색으로 변경 및 그림자 추가 -->
        <h1 style="margin-bottom: 30px; font-size: 32px; font-weight: 800; color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">POCALIST</h1>

        <!-- 로딩 스피너 -->
        <div class="loading-spinner" style="width: 50px; height: 50px; border: 3px solid rgba(0, 0, 0, 0.1); 
              border-top: 3px solid #3498db; border-radius: 50%; 
              animation: spin 1s linear infinite;"></div>

        <!-- 로딩 텍스트 - 흰색으로 변경 및 그림자 추가 -->
        <p style="margin-top: 20px; font-size: 18px; color: #fff; font-weight: 600; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">아이브 모셔오는 중...</p>
      </div>

        <style>
        @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
        }

        @keyframes float {
        0%, 100% { transform: translateY(0) rotate(var(--rotate)); }
        50% { transform: translateY(-15px) rotate(var(--rotate)); }
        }

        .background-card {
        --rotate: -8deg;
        animation: float 6s ease-in-out infinite;
        animation-delay: calc(var(--index) * 0.5s);
        }

        .background-card:nth-child(1) { --index: 1; --rotate: -8deg; }
        .background-card:nth-child(2) { --index: 2; --rotate: 12deg; }
        .background-card:nth-child(3) { --index: 3; --rotate: 5deg; }
        .background-card:nth-child(4) { --index: 4; --rotate: -15deg; }
        </style>

        <script>
        // 로딩 화면 제거 함수
        function hideLoadingScreen() {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transition = 'opacity 0.5s';
        setTimeout(() => loadingScreen.remove(), 500);
        }
        }

        // 🔥 자동 숨김 스크립트
        document.addEventListener('DOMContentLoaded', () => {
        // ⏰ 여기서 시간 변경 (밀리초 단위)
        const LOADING_TIME = 5000; // 5초 (원하는 시간으로 변경)

        setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transition = 'opacity 0.5s';
        setTimeout(() => loadingScreen.remove(), 500);
        }
        }, LOADING_TIME);
        });
        </script>
       <!-- ✅ html2canvas 등 외부 라이브러리 로드 -->
      <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
      <script>
        // 🔒 기본적인 소스코드 보호 + 강력한 대응
           (function() {
            'use strict';
            
            // 1. 우클릭 방지
            document.addEventListener('contextmenu', e => {
              e.preventDefault();
              return false;
            });
            
            // 2. 키보드 단축키 방지
            document.addEventListener('keydown', e => {
              // F12 (개발자도구)
              if (e.keyCode === 123) {
                e.preventDefault();
                return false;
              }
              
              // Ctrl+Shift+I (개발자도구)
              if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                e.preventDefault();
                return false;
              }
              
              // Ctrl+Shift+J (콘솔)
              if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                e.preventDefault();
                return false;
              }
              
              // Ctrl+U (소스보기)
              if (e.ctrlKey && e.keyCode === 85) {
                e.preventDefault();
                return false;
              }
              
              // Ctrl+S (저장)
              if (e.ctrlKey && e.keyCode === 83) {
                e.preventDefault();
                return false;
              }
            });
            
            // ✅ 개발자도구 감지 부분 제거 (스크롤 이슈 해결)
            
            // Console 메시지 덮어쓰기 (선택사항)
            /*
            setInterval(() => {
              console.clear();
              console.log('%cSTOP!', 'color: red; font-size: 50px; font-weight: bold;');
              console.log('%c이 영역은 개발자를 위한 콘솔입니다.\n악의적인 코드를 입력하면 보안 문제가 발생할 수 있습니다.', 
                          'color: red; font-size: 14px;');
            }, 3000);
            */
            
          })();
      </script>
      <script>
        /* ==========================================================
          📌 pocalist 메인 스크립트 - 완전 수정 버전
          ========================================================== */

        // IndexedDB 설정
        const DB_NAME = 'pocalistDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'userDataStore';
        let db = null;

        // IndexedDB 초기화
        function initIndexedDB() {
          return new Promise((resolve, reject) => {
            if (db) {
              return resolve(db);
            }

            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
              console.error('IndexedDB 열기 실패:', event);
              reject('IndexedDB를 열 수 없습니다.');
            };

            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'key' });
                console.log('IndexedDB 스토어 생성 완료');
              }
            };

            request.onsuccess = (event) => {
              db = event.target.result;
              console.log('IndexedDB 연결 성공');
              resolve(db);
            };
          });
        }

        // IndexedDB에 데이터 저장
        function saveToIndexedDB(key, value) {
          return new Promise(async (resolve, reject) => {
            try {
              const db = await initIndexedDB();
              const transaction = db.transaction([STORE_NAME], 'readwrite');
              const store = transaction.objectStore(STORE_NAME);
              
              const request = store.put({ key, value });
              
              request.onsuccess = () => {
                console.log(`IndexedDB에 ${key} 저장 성공`);
                resolve(true);
              };
              
              request.onerror = (event) => {
                console.error(`IndexedDB에 ${key} 저장 실패:`, event);
                reject(event);
              };
            } catch (error) {
              console.error('IndexedDB 저장 중 오류:', error);
              reject(error);
            }
          });
        }

        // IndexedDB에서 데이터 가져오기
        function getFromIndexedDB(key) {
          return new Promise(async (resolve, reject) => {
            try {
              const db = await initIndexedDB();
              const transaction = db.transaction([STORE_NAME], 'readonly');
              const store = transaction.objectStore(STORE_NAME);
              
              const request = store.get(key);
              
              request.onsuccess = () => {
                const result = request.result;
                if (result) {
                  console.log(`IndexedDB에서 ${key} 로드 성공`);
                  resolve(result.value);
                } else {
                  console.log(`IndexedDB에 ${key} 없음`);
                  resolve(null);
                }
              };
              
              request.onerror = (event) => {
                console.error(`IndexedDB에서 ${key} 로드 실패:`, event);
                reject(event);
              };
            } catch (error) {
              console.error('IndexedDB 로드 중 오류:', error);
              reject(error);
            }
          });
        }

        // 쿠키 유틸리티 함수들
        function setCookie(name, value, days) {
          let expires = "";
          if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
          }
          document.cookie = name + "=" + encodeURIComponent(value || "") + expires + "; path=/; SameSite=Strict";
        }

        function getCookie(name) {
          const nameEQ = name + "=";
          const ca = document.cookie.split(';');
          for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
          }
          return null;
        }

        // UUID 유효성 검사 함수
        function isValidUUID(uuid) {
          if (!uuid) return false;
          // 기본적인 UUID 형식 검사
          const regex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
          return regex.test(uuid.trim());
        }

        // 모든 저장소에 데이터 저장
        async function saveUserData(key, value) {
          const stringValue = typeof value === 'string' ? value : JSON.stringify(value);
          
          try {
            // 1. localStorage에 저장
            localStorage.setItem(key, stringValue);
            
            // 2. 쿠키에 저장 (30일)
            setCookie(key, stringValue, 30);
            
            // 3. IndexedDB에 저장
            await saveToIndexedDB(key, stringValue);
            
            console.log(`${key} 데이터 모든 저장소에 저장 완료`);
            return true;
          } catch (error) {
            console.error(`${key} 데이터 저장 실패:`, error);
            return false;
          }
        }

        // 모든 저장소에서 데이터 가져오기 (우선순위: IndexedDB > localStorage > cookies)
        async function getUserData(key) {
          try {
            // 1. IndexedDB에서 시도
            try {
              const indexedDBValue = await getFromIndexedDB(key);
              if (indexedDBValue) {
                console.log(`IndexedDB에서 ${key} 복구 성공`);
                // 다른 저장소에도 복사
                localStorage.setItem(key, indexedDBValue);
                setCookie(key, indexedDBValue, 30);
                return indexedDBValue;
              }
            } catch (error) {
              console.warn('IndexedDB 조회 실패:', error);
            }
            
            // 2. localStorage에서 시도
            const localValue = localStorage.getItem(key);
            if (localValue) {
              console.log(`localStorage에서 ${key} 복구 성공`);
              // 다른 저장소에 복사
              setCookie(key, localValue, 30);
              try {
                await saveToIndexedDB(key, localValue);
              } catch (error) {
                console.warn('IndexedDB 저장 실패:', error);
              }
              return localValue;
            }
            
            // 3. 쿠키에서 시도
            const cookieValue = getCookie(key);
            if (cookieValue) {
              console.log(`쿠키에서 ${key} 복구 성공`);
              // 다른 저장소에 복사
              localStorage.setItem(key, cookieValue);
              try {
                await saveToIndexedDB(key, cookieValue);
              } catch (error) {
                console.warn('IndexedDB 저장 실패:', error);
              }
              return cookieValue;
            }
            
            console.log(`${key} 데이터 모든 저장소에서 찾을 수 없음`);
            return null;
          } catch (error) {
            console.error(`${key} 데이터 조회 실패:`, error);
            return null;
          }
        }

        // UUID 가져오기
        async function getMyUUID() {
          try {
            const uuid = await getUserData('myUUID');
            if (isValidUUID(uuid)) {
              return uuid;
            }
            return null;
          } catch (error) {
            console.error('UUID 조회 실패:', error);
            return null;
          }
        }

        // 친구 UUID 가져오기
        async function getLastFriendUUID() {
          try {
            return await getUserData('lastFriendUUID');
          } catch (error) {
            console.error('친구 UUID 조회 실패:', error);
            return null;
          }
        }

        // 사용자 데이터 가져오기
        async function getUserDataObj() {
          try {
            const userData = await getUserData('userData');
            if (userData) {
              try {
                return JSON.parse(userData);
              } catch (error) {
                console.error('userData 파싱 실패', error);
                return userData; // 이미 객체일 수도 있음
              }
            }
            return {};
          } catch (error) {
            console.error('사용자 데이터 파싱 실패:', error);
            return {};
          }
        }

        // UUID 확보/생성 함수
        async function ensureMyUUID() {
          try {
            // 저장소에서 UUID 조회
            let uuid = await getMyUUID();
            if (uuid) {
              console.log('기존 UUID 사용:', uuid);
              return uuid;
            }
            
            // 새 UUID 발급
            console.log('새 UUID 발급 요청');
            const response = await fetch('https://pocali-backend.onrender.com/api/register', {
              method: 'POST'
            });
            
            if (!response.ok) {
              throw new Error('UUID 발급 실패');
            }
            
            const data = await response.json();
            uuid = data.user_id;
            
            if (!isValidUUID(uuid)) {
              throw new Error('서버에서 유효하지 않은 UUID 반환');
            }
            
            // 모든 저장소에 저장
            await saveUserData('myUUID', uuid);
            await saveUserData('userData', JSON.stringify({}));
            
            console.log('새 UUID 발급 및 저장 완료:', uuid);
            return uuid;
          } catch (error) {
            console.error('UUID 발급 오류:', error);
            alert('사용자 정보 초기화 중 오류가 발생했습니다. 페이지를 새로고침 해주세요.');
            return null;
          }
        }

        // UUID 검증 및 복구
        async function validateUserID() {
          try {
            // 저장소에서 UUID 조회
            const uuid = await getMyUUID();
            
            // UUID가 없거나 유효하지 않으면 초기화
            if (!uuid) {
              console.log('유효한 UUID 없음, 새로 발급');
              return await ensureMyUUID();
            }
            
            // userData 확인
            let userData = await getUserDataObj();
            if (Object.keys(userData).length === 0) {
              console.log('userData 누락, 서버에서 데이터 가져오기');
              try {
                const response = await fetch(`https://pocali-backend.onrender.com/api/user/${uuid}`);
                if (response.ok) {
                  const data = await response.json();
                  
                  if (data.data) {
                    // 데이터 형식에 따라 적절히 처리
                    let processedData;
                    if (typeof data.data === 'string') {
                      try {
                        processedData = JSON.parse(data.data);
                      } catch {
                        processedData = data.data;
                      }
                    } else {
                      processedData = data.data;
                    }
                    
                    // 모든 저장소에 저장
                    await saveUserData('userData', JSON.stringify(processedData));
                  }
                }
              } catch (error) {
                console.error('서버에서 userData 조회 실패:', error);
              }
            }
            
            return uuid;
          } catch (error) {
            console.error('UUID 검증 오류:', error);
            return await ensureMyUUID();
          }
        }

        // 로컬 데이터를 서버에 동기화
        async function syncLocalDataToServer() {
          try {
            const uuid = await getMyUUID();
            if (!uuid || viewOwner !== 'self') return;
            
            const userData = await getUserDataObj();
            
            // 서버에 데이터 저장
            const response = await fetch(`https://pocali-backend.onrender.com/api/user/${uuid}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: userData })
            });
            
            if (response.ok) {
              console.log('서버 동기화 성공');
            } else {
              console.error('서버 동기화 실패');
            }
          } catch (error) {
            console.error('서버 동기화 오류:', error);
          }
        }

        // load-other-data 핸들러 세팅
        function setupLoadOtherDataHandler() {
          $('#load-other-data')?.addEventListener('click', async () => {
            const other = $('#other-uuid').value.trim();
            if (!isValidUUID(other)) {
              return alert('유효한 UUID를 입력하세요!');
            }
            
            try {
              const response = await fetch(`https://pocali-backend.onrender.com/api/user/${other}`);
              if (!response.ok) {
                return alert('해당 UUID를 찾을 수 없습니다.');
              }
              
              const json = await response.json();
              let userDataObj;
              
              // 데이터 형식 처리
              if (typeof json.data === 'string') {
                try {
                  userDataObj = JSON.parse(json.data);
                } catch {
                  userDataObj = json.data;
                }
              } else {
                userDataObj = json.data || {};
              }
              
              // 모든 저장소에 저장
              await saveUserData('myUUID', other);
              await saveUserData('userData', JSON.stringify(userDataObj));
              
              location.reload();
            } catch (error) {
              console.error('데이터 로드 오류:', error);
              alert('데이터 로드 중 오류가 발생했습니다.');
            }
          });
        }

        /* ───────────────────────────────────────────────
          0. 전역 상태 및 도우미
          ─────────────────────────────────────────────── */
        // ─── 페이징용 전역 변수 ─────────────────────────
        const BATCH_SIZE   = 100;      // 한 번에 로드할 카드 개수
        let backupAllImages = [];      // allImages 원본 백업용
        let allImages      = [];       // 전체 이미지 메타데이터 저장
        let currentBatch   = 0;        // 렌더된 배치 인덱스
        let isRendering    = false;    // 중복 렌더링 방지 플래그
        let totalCount     = 0;        // ← 전체 개수 헤더에서 읽어 저장
        let currentView    = 'id';     // 'id'  | 'category'
        let viewOwner      = 'self';   // 'self'| 'friend'
        let currentFriendUUID = null;  // 초기화: DOMContentLoaded에서 설정됨
        let userData       = {};       // 현재 보여지는 데이터 (내 것 또는 친구 것)

        const advancedFilters = { groups: [], members: [] };

        /* 짧은 셀렉터 도우미 */
        function $(sel,  scope=document) { return scope.querySelector(sel); }
        function $$(sel, scope=document) { return Array.from(scope.querySelectorAll(sel)); }

        /* ── 공통: 이미지 상세 모달 ───────────────────────── */
        function showModal(img) {
          const $modal      = $('#photo-modal');
          const $modalImg   = $('#modal-image');
          const $modalInfo  = $('#modal-info');

          $modalImg.src = img.src;

          $modalInfo.innerHTML = `
            <p>${img.dataset.group   || ''}</p>
            <p>${img.dataset.member  || ''}</p>
            <p>${img.dataset.category || ''} ${img.dataset.title || ''}</p>
            <p>${img.dataset.version || ''}</p>
            <p>#${img.dataset.unique}</p>
          `;

          $modal.style.display = 'block';
        }

        // 앱 초기화 시 실행할 함수
        async function initApp() {
          try {
            // IndexedDB 초기화
            await initIndexedDB();
            
            // 친구 UUID 복구
            const friendUUID = await getLastFriendUUID();
            if (friendUUID) {
              currentFriendUUID = friendUUID;
              console.log('복구된 친구 UUID:', currentFriendUUID);
            }
            
            // UUID 검증 및 복구
            const uuid = await validateUserID();
            console.log('검증된 UUID:', uuid);
            
            if (uuid) {
              // userData 로드
              const userDataObj = await getUserDataObj();
              userData = userDataObj;
            }
            
            // load-other-data 핸들러 설정
            setupLoadOtherDataHandler();
          } catch (error) {
            console.error('앱 초기화 오류:', error);
          }
        }

        /* ───────────────────────────────────────────────
          1. 초기화 및 메인 기능들
          ─────────────────────────────────────────────── */
        document.addEventListener('DOMContentLoaded', () => {
          // 앱 초기화
          initApp();
          
          // ── export-modal 닫기 핸들러
          const $exportModal      = document.getElementById('export-modal');
          const $exportModalClose = document.getElementById('export-modal-close');
          
          $exportModalClose.addEventListener('click', () => {
            $exportModal.style.display = 'none';
          });
          
          $exportModal.addEventListener('click', e => {
            if (e.target === $exportModal) {
              $exportModal.style.display = 'none';
            }
          });
          
          const LONG_PRESS     = 500;
          const TAP_THRESHOLD  = 200;
          const MOVE_THRESHOLD = 10;

          const $grid          = $('#photo-grid');
          const $viewToggleBtn = $('#view-toggle');
          const $catToggleBtn  = $('#categoryToggleBtn');
          const $searchInput   = $('#search-input');

          // 렌더링 후에 값을 채울 변수들
          let originalCards = [];
          let photoCards    = [];

          // ✅ toggleCheck 함수: 체크 상태 변경
          function toggleCheck(img) {
            if (viewOwner !== 'self') return; // 친구 덱에서는 수정 불가
            
            img.classList.toggle('checked');
            
            // userData 업데이트
            userData[img.dataset.unique] = img.classList.contains('checked');
            
            // 모든 저장소에 저장
            saveUserData('userData', userData);
            
            // 서버 동기화
            syncLocalDataToServer();
            updateCount();
          }

          async function fetchAndRenderImages() {
            const resp = await fetch('https://pocali-backend.onrender.com/api/images');
            allImages     = await resp.json();
            backupAllImages = allImages.slice();
            totalCount    = allImages.length;
            currentBatch = 0;
            $grid.innerHTML = '';
            renderNextBatch();
          }

          // ✅ 덱 전환 기능 수정
          /** 내 보유 카드 표시 */
          async function loadSelfDeck() {
            // 최신 userData 가져오기
            const myData = await getUserDataObj();
            userData = myData;
            
            photoCards.forEach(img => {
              img.classList.toggle('checked', !!myData[img.dataset.unique]);
              img.style.pointerEvents = ''; // 더블클릭 허용
            });

            viewOwner = 'self';
            $viewToggleBtn.textContent = '👥 친구보기';
            updateCount();
          }

          /** 친구 보유 카드 표시 */
          async function loadFriendDeck(uuid) {
            try {
              const res = await fetch(`https://pocali-backend.onrender.com/api/friend/${uuid}/collection`);
              if (!res.ok) {
                alert('친구 데이터를 불러올 수 없습니다.');
                return false;
              }

              const friendData = (await res.json()).data || {};
              userData = friendData; // 현재 보여지는 데이터를 친구 데이터로 설정
              
              photoCards.forEach(img => {
                img.classList.toggle('checked', !!friendData[img.dataset.unique]);
                img.style.pointerEvents = 'none'; // 수정 금지
              });

              viewOwner = 'friend';
              currentFriendUUID = uuid;
              // 모든 저장소에 친구 UUID 저장
              await saveUserData('lastFriendUUID', uuid);
              
              $viewToggleBtn.textContent = '👤 내 카드보기';
              updateCount();
              return true;
            } catch (error) {
              console.error('친구 덱 로드 실패:', error);
              alert('친구 데이터 로드 중 오류가 발생했습니다.');
              return false;
            }
          }

          /* ─────────────────────────────────────────────
            2. 공통 유틸
            ───────────────────────────────────────────── */
          /** 현재 화면의 총 카드수 / 보유카드수 표시 */
          function updateCount() {
            // 현재 보여지는 userData를 기준으로 계산
            const have = Object.values(userData).filter(v => v).length;
            document.getElementById('count-display').textContent = `${have} / ${totalCount}`;
          }

          /** 카드 리스트를 그리드에 그대로 렌더링 */
          function render(cards) {
            $grid.innerHTML = '';
            cards.forEach(c => $grid.appendChild(c));
            updateCount();
          }

          /* ─────────────────────────────────────────────
            3. 뷰 그리기(정렬) 함수
            ───────────────────────────────────────────── */
          /** 고유번호(ID) 내림차순 정렬 뷰 */
          function showById(list = null) {
            const cards = (list ?? originalCards).slice();
            cards.sort((a, b) =>
              $('.photo-card', b).dataset.unique -
              $('.photo-card', a).dataset.unique
            );
            render(cards);
          }

          /** 카테고리별 그룹 + 제목 + 버전 헤더 뷰 */
          function showByCategory() {
            const query = ($searchInput.value || '').toLowerCase();
            
            const filtered = originalCards.filter(div => {
              const img = $('.photo-card', div);
              const alt = img.alt.toLowerCase();
              const group = img.dataset.group.toLowerCase();
              const member = img.dataset.member.toLowerCase();

              const textOK = !query || alt.includes(query);
              const groupOK = !advancedFilters.groups.length ||
                            advancedFilters.groups.includes(group.toUpperCase());
              const memberOK = !advancedFilters.members.length ||
                              advancedFilters.members.some(v => member.includes(v.toLowerCase()));

              return textOK && groupOK && memberOK;
            });

            const buckets = {};
            filtered.forEach(div => {
              const img = $('.photo-card', div);
              const key = [
                img.dataset.category || '미분류',
                img.dataset.title || '',
                img.dataset.version || ''
              ].filter(Boolean).join(' | ');
              (buckets[key] = buckets[key] || []).push(div);
            });

            $grid.innerHTML = '';
            Object.entries(buckets)
              .sort(([,a],[,b]) =>
                +$('.photo-card', b[0]).dataset.unique -
                +$('.photo-card', a[0]).dataset.unique
              )
              .forEach(([header, cards]) => {
                const h2 = document.createElement('h2');
                h2.textContent = header;
                h2.style.margin = '16px 0 8px';
                $grid.appendChild(h2);

                cards.sort((a, b) =>
                  +$('.photo-card', b).dataset.unique -
                  +$('.photo-card', a).dataset.unique
                ).forEach(div => $grid.appendChild(div));
              });

            updateCount();
          }

          /** 현재 필터/뷰 상태로 다시 그리기 */
          function applyFilters() {
            if (currentView === 'category') {
              showByCategory();
            } else {
              showById();
            }
          }


          // Google Cloud Storage URL 구조에 맞춘 정확한 파일 정보 파싱 함수
          function parseImageInfo(imageData) {
            let result = {
              subFolder: '',
              group: '',
              member: '',
              category: '',
              title: '',
              version: '',
              uniqueId: ''
            };

            try {
              // API에서 이미 파싱된 데이터가 있는 경우 우선 사용
              if (imageData.group) result.group = imageData.group;
              if (imageData.member) result.member = imageData.member;
              if (imageData.category) result.category = imageData.category;
              if (imageData.title) result.title = imageData.title;
              if (imageData.version) result.version = imageData.version;
              if (imageData.unique_id) result.uniqueId = imageData.unique_id;
              if (imageData.file_type) result.subFolder = imageData.file_type;

              // URL이 있는 경우 파싱 시도
              if (imageData.url && typeof imageData.url === 'string') {
                try {
                  let filePath = '';
                  
                  // Google Cloud Storage URL 구조 처리
                  // 예: https://storage.googleapis.com/pocali.firebasestorage.app/images/album/IVE_AN_EL_Ver.2_36618.jpg
                  if (imageData.url.includes('storage.googleapis.com')) {
                    // URL을 '/' 기준으로 분할
                    const urlParts = imageData.url.split('/');
                    
                    // storage.googleapis.com 이후의 버킷명을 찾고, 그 다음부터가 실제 파일 경로
                    const storageIndex = urlParts.findIndex(part => part === 'storage.googleapis.com');
                    if (storageIndex !== -1 && urlParts.length > storageIndex + 2) {
                      // storage.googleapis.com 다음이 버킷명, 그 다음부터가 파일 경로
                      const pathParts = urlParts.slice(storageIndex + 2); // 버킷명 이후의 모든 부분
                      filePath = pathParts.join('/'); // 'images/album/IVE_AN_EL_Ver.2_36618.jpg'
                    }
                  }
                  // 기존 Firebase Storage URL 구조 처리 (하위 호환성)
                  else if (imageData.url.includes('firebasestorage.googleapis.com')) {
                    const urlParts = imageData.url.split('/o/');
                    if (urlParts.length >= 2) {
                      const pathWithParams = urlParts[1];
                      const pathOnly = pathWithParams.split('?')[0];
                      filePath = decodeURIComponent(pathOnly);
                    }
                  }
                  
                  if (filePath) {
                    // 경로 분해 (예: 'images/album/IVE_AN_EL_Ver.2_36618.jpg')
                    const pathParts = filePath.split('/');
                    
                    // 하위폴더 추출 (두 번째 부분: album, event, benefit 등)
                    // 첫 번째는 'images', 두 번째가 실제 카테고리
                    if (pathParts.length >= 2 && !result.subFolder) {
                      result.subFolder = pathParts[1]; // 'album', 'event', 'benefit' 등
                    }
                    
                    // 파일명 추출 (마지막 경로 부분)
                    if (pathParts.length > 0) {
                      const fileName = pathParts[pathParts.length - 1];
                      
                      if (fileName && fileName.includes('_')) {
                        // 파일명 파싱 (IVE_AN_EL_Ver.2_36618.jpg -> 그룹, 멤버, 카테고리 등)
                        const fileParts = fileName.split('_');
                        
                        if (fileParts.length >= 3) {
                          // 첫 번째 부분은 그룹명
                          if (!result.group && fileParts[0]) {
                            result.group = fileParts[0]; // 'IVE'만 저장
                          }
                          
                          // 두 번째 부분은 멤버 코드 (매핑 필요)
                          if (!result.member && fileParts[1]) {
                            const memberMap = {
                              'AN': '유진', 'WON': '원영', 'GA': '가을', 'REI': '레이',
                              'LIZ': '리즈', 'LEE': '이서', 'II': "I've IVE"
                            };
                            result.member = memberMap[fileParts[1]] || fileParts[1];
                          }
                          
                          // 세 번째 부분은 카테고리
                          if (!result.category && fileParts[2]) {
                            result.category = fileParts[2];
                          }
                          
                          // 네 번째 이상은 title이나 version 등일 수 있음
                          if (fileParts.length > 3 && !result.title && fileParts[3]) {
                            result.title = fileParts[3];
                          }
                          
                          if (fileParts.length > 4 && !result.version && fileParts[4]) {
                            result.version = fileParts[4];
                          }
                          
                          // 마지막 부분에서 숫자만 추출 (고유 ID)
                          if (!result.uniqueId && fileParts.length > 0) {
                            const lastPart = fileParts[fileParts.length - 1];
                            if (lastPart) {
                              const idMatch = lastPart.match(/\d+/);
                              if (idMatch) {
                                result.uniqueId = idMatch[0];
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                } catch (urlParsingError) {
                  console.warn('URL 파싱 중 오류:', urlParsingError, imageData.url);
                }
              }

              // 기본값 설정
              if (!result.group) result.group = 'Unknown';
              if (!result.member) result.member = 'Unknown';
              if (!result.category) result.category = 'Unknown';
              if (!result.uniqueId) result.uniqueId = Math.random().toString(36).substr(2, 9);
              if (!result.subFolder) result.subFolder = 'default';

            } catch (error) {
              console.error('파일 정보 파싱 중 전체 오류:', error, imageData);
              // 모든 파싱이 실패한 경우 기본값 반환
              return {
                subFolder: 'error',
                group: 'Unknown',
                member: 'Unknown', 
                category: 'Unknown',
                title: '',
                version: '',
                uniqueId: Math.random().toString(36).substr(2, 9)
              };
            }

            return result;
          }

          // fetchAndRenderImages 함수의 데이터 처리 부분 수정
          async function fetchAndRenderImages() {
            try {
              const resp = await fetch('https://pocali-backend.onrender.com/api/images');
              
              if (!resp.ok) {
                throw new Error('이미지를 불러오는데 실패했습니다');
              }
              
              let data = await resp.json();
              
              // 데이터 처리 - 각 이미지에 필수 필드 보장
              allImages = data.map(imageData => {
                // 안전한 파싱 함수 사용
                const parsed = parseImageInfo(imageData);
                
                // 원본 데이터와 파싱된 데이터 병합
                return {
                  ...imageData,
                  group: parsed.group,
                  member: parsed.member,
                  category: parsed.category,
                  title: parsed.title,
                  version: parsed.version,
                  unique_id: parsed.uniqueId,
                  file_type: parsed.subFolder
                };
              });
              
              // 백업 저장
              backupAllImages = allImages.slice();
              totalCount = allImages.length;
              
              // 렌더링 초기화
              currentBatch = 0;
              $grid.innerHTML = '';
              
              // 첫 배치 렌더링
              renderNextBatch();
            } catch (error) {
              console.error('이미지 로드 오류:', error);
              alert('이미지를 불러오는 중 오류가 발생했습니다.');
            }
          }

          // renderNextBatch 함수의 파일 정보 파싱 부분 수정
          function renderNextBatch() {
            if (isRendering) return;
            
            const start = currentBatch * BATCH_SIZE;
            const end = start + BATCH_SIZE;
            const slice = allImages.slice(start, end);
            
            // 로드할 이미지가 없으면 종료
            if (slice.length === 0) {
              isRendering = false;
              return;
            }
            
            isRendering = true;

            slice.forEach(image => {
              // 1) 카드 컨테이너 생성
              const container = document.createElement('div');
              container.className = 'photo-card-container';
              
              // 2) 이미 파싱된 데이터 사용 (fetchAndRenderImages에서 파싱 완료)
              const subFolder = image.file_type || 'default';
              const group = image.group || 'Unknown';
              const member = image.member || 'Unknown';
              const category = image.category || 'Unknown';
              const title = image.title || '';
              const version = image.version || '';
              const uniqueId = image.unique_id || Math.random().toString(36).substr(2, 9);
              
              // 3) 오버레이 생성
              const overlay = document.createElement('div');
              overlay.className = 'image-overlay';
              overlay.textContent = subFolder;
              container.appendChild(overlay);
              
              // 4) 이미지 요소 생성
              const img = document.createElement('img');
              img.className = 'photo-card';
              img.src = image.url || '';
              img.loading = 'lazy';
              
              // 데이터셋 설정 (모달 표시에 사용) - 파싱된 데이터 사용
              img.dataset.group = group;
              img.dataset.member = member;
              img.dataset.category = category;
              img.dataset.title = title;
              img.dataset.version = version;
              img.dataset.unique = uniqueId;
              
              // alt 태그 설정 (검색에 사용)
              img.alt = `${group} ${member} ${category} ${title} #${uniqueId}`;
              
              // 체크 상태 설정
              if (userData[uniqueId]) {
                img.classList.add('checked');
              }
              
              // 포인터 이벤트 설정
              img.style.pointerEvents = viewOwner === 'self' ? '' : 'none';
              
              // 5) 이벤트 핸들러 등록 (기존과 동일)
              let startX, startY;
              let moved = false;
              let startTime, pressTimer;
              
              img.addEventListener('pointerdown', e => {
                if (viewOwner !== 'self') return;
                
                startX = e.clientX;
                startY = e.clientY;
                moved = false;
                
                startTime = performance.now();
                pressTimer = setTimeout(() => showModal(img), LONG_PRESS);
              });

              img.addEventListener('pointermove', e => {
                if (!startX || !startY) return;
                
                const deltaX = Math.abs(e.clientX - startX);
                const deltaY = Math.abs(e.clientY - startY);
                
                if (deltaX > MOVE_THRESHOLD || deltaY > MOVE_THRESHOLD) {
                  moved = true;
                  clearTimeout(pressTimer);
                }
              });

              img.addEventListener('pointerup', e => {
                clearTimeout(pressTimer);
                
                if (!moved && (performance.now() - startTime < TAP_THRESHOLD)) {
                  toggleCheck(img);
                }
                
                startX = startY = null;
                moved = false;
              });

              img.addEventListener('pointerleave', () => {
                clearTimeout(pressTimer);
                startX = startY = null;
                moved = false;
              });

              img.addEventListener('dblclick', () => {
                if (viewOwner !== 'self') return;
                toggleCheck(img);
              });

              img.addEventListener('contextmenu', e => {
                e.preventDefault();
                showModal(img);
              });
              
              // 6) 컨테이너에 이미지 추가 후 그리드에 추가
              container.appendChild(img);
              $grid.appendChild(container);
            });
            
            // 캐시 갱신
            originalCards = Array.from($grid.querySelectorAll('.photo-card-container'));
            photoCards = Array.from($grid.querySelectorAll('.photo-card'));
            
            // 상태 갱신
            currentBatch++;
            updateCount();
            
            isRendering = false;
          }


          

          // 서버에서 데이터 가져오기 (10초마다 폴링)
          async function pollServerData() {
            if (viewOwner !== 'self') return;
            
            const me = await getMyUUID();
            if (!me) return;
            
            try {
              const r = await fetch(`https://pocali-backend.onrender.com/api/user/${me}`);
              if (!r.ok) return;
              
              const data = await r.json();
              let serverData;
              
              // 데이터 형식 처리
              if (typeof data.data === 'string') {
                try {
                  serverData = JSON.parse(data.data);
                } catch {
                  serverData = data.data || {};
                }
              } else {
                serverData = data.data || {};
              }
              
              userData = serverData;
              
              // 모든 저장소에 저장
              await saveUserData('userData', serverData);
              
              photoCards.forEach(img =>
                img.classList.toggle('checked', !!serverData[img.dataset.unique]));
              updateCount();
            } catch (error) {
              console.error('서버 데이터 폴링 실패:', error);
            }
          }
          
          // 일정 간격으로 서버 데이터 폴링
          setInterval(pollServerData, 10000);

          /* ─────────────────────────────────────────────
            5. UI 이벤트 핸들러들
            ───────────────────────────────────────────── */
          // ✅ 뷰 토글 버튼 이벤트 (중복 제거) - 단 한 번만 등록
          $viewToggleBtn.addEventListener('click', async () => {
            if (viewOwner === 'friend') {
              await loadSelfDeck();
            } else {
              if (currentFriendUUID) {
                await loadFriendDeck(currentFriendUUID);
              } else {
                alert('먼저 친구를 추가하세요!');
              }
            }
          });

          // 카테고리/ID 전환 버튼
          $catToggleBtn.addEventListener('click', () => {
            currentView = currentView === 'id' ? 'category' : 'id';
            $catToggleBtn.textContent = currentView === 'id' ? '🏷️' : '🔢';
            $catToggleBtn.title = currentView === 'id'
                                ? '카테고리별 보기'
                                : '고유번호 순 보기';
            applyFilters();
          });

          // ✅ 검색 이벤트 핸들러
          $searchInput.addEventListener('input', e => {
            const q = e.target.value.trim().toLowerCase();
            if (!q) {
              allImages = backupAllImages.slice();
            } else {
              allImages = backupAllImages.filter(meta =>
                (`${meta.group} ${meta.member} ${meta.category} ${meta.title}`)
                  .toLowerCase().includes(q)
              );
            }
            // 페이징 초기화 후 다시 렌더
            currentBatch = 0;
            isRendering = false;
            $grid.innerHTML = '';
            renderNextBatch();
            // 첫 배치 렌더링 후 현재 뷰 적용
            setTimeout(() => applyFilters(), 100);
          });

          // ─── 무한 스크롤 트리거 ─────────────────────────
          window.addEventListener('scroll', () => {
            // 이미 렌더링 중이거나 더 이상 로드할 이미지가 없으면 종료
            if (isRendering || currentBatch * BATCH_SIZE >= allImages.length) {
              return;
            }
            
            const nearBottom = window.innerHeight + window.scrollY
                            >= document.body.offsetHeight - 500;
            
            if (nearBottom) {
              renderNextBatch();
              // 배치 렌더링 후 현재 뷰 적용
              setTimeout(() => applyFilters(), 100);
            }
          });

          // FAB 및 모달들
          const $fab = $('#fab');
          const $userModal = $('#user-modal');
          const $userModalClose = $('#user-modal-close');
          const $addFriendBtn = $('#add-friend');
          const $friendModal = $('#friend-modal');
          const $friendClose = $('#friend-modal-close');
          const $friendConfirm = $('#friend-add-confirm');
          const $resetBtn = $('#reset-checks');
          const $exportBtn = $('#export-sheet');
          const $userDataModal = $('#user-data-modal');
          const $userDataModalClose = $('#user-data-modal-close');

          $userDataModalClose.addEventListener('click', () => $userDataModal.style.display = 'none');
          $userDataModal.addEventListener('click', e => {
            if (e.target === $userDataModal) $userDataModal.style.display = 'none';
          });

          // 상세 검색 모달
          const detailBtn = document.getElementById('search-detail-btn');
          const detailModal = document.getElementById('detail-search-modal');
          const detailForm = document.getElementById('detail-search-form');

          detailBtn.addEventListener('click', () => detailModal.style.display = 'block');
          detailModal.querySelector('.close').addEventListener('click', () => detailModal.style.display = 'none');
          detailModal.addEventListener('click', e => { 
            if (e.target === detailModal) detailModal.style.display = 'none'; 
          });

          detailForm.addEventListener('submit', e => {
            e.preventDefault();
            const fd = new FormData(detailForm);
            const groups = fd.getAll('group');
            const members = fd.getAll('member');
            
            if (!groups.length && !members.length) {
              allImages = backupAllImages.slice();
            } else {
              allImages = backupAllImages.filter(meta =>
                (groups.length === 0 || groups.includes(meta.group)) &&
                (members.length === 0 || members.includes(meta.member))
              );
            }
            
            currentBatch = 0;
            isRendering = false;
            $grid.innerHTML = '';
            renderNextBatch();
            setTimeout(() => applyFilters(), 100);
            detailModal.style.display = 'none';
          });

          // Export form
          const $exportForm = document.getElementById('export-form');
          $exportForm.addEventListener('submit', e => {
            e.preventDefault();
            const fd = new FormData($exportForm);
            const group = fd.get('group');
            const members = fd.getAll('member');

            const sel = backupAllImages.filter(meta =>
              meta.group === group &&
              (members.length === 0 || members.includes(meta.member))
            );
            
            if (!sel.length) {
              return alert('선택하신 조건에 맞는 카드가 없습니다.');
            }
            
            const nodes = sel.map(meta => {
              const img = document.createElement('img');
              img.className = 'photo-card';
              img.crossOrigin = 'anonymous';
              img.src = meta.url;
              img.alt = `${meta.group} ${meta.member} ${meta.category} ${meta.title}`;
              img.dataset.unique = meta.unique_id;
              img.dataset.group = meta.group;
              img.dataset.member = meta.member;
              img.dataset.category = meta.category;
              img.dataset.title = meta.title;
              img.dataset.version = meta.version;
              
              // 현재 보여지는 데이터 기준으로 체크 상태 설정
              if (userData[meta.unique_id]) img.classList.add('checked');
              return img;
            });
            
            $exportModal.style.display = 'none';
            generateImageSheet(nodes);
          });

          // 유저 데이터 모달
          const $loadUserBtn = $('#load-user-data');
          $loadUserBtn?.addEventListener('click', async () => {
            $userModal.style.display = 'none';
            const me = await getMyUUID() || await ensureMyUUID();
            $('#my-uuid').value = me;
            $('#other-uuid').value = '';
            $('#uuid-msg').textContent = '';
            $('#user-data-modal').style.display = 'block';
          });

          // FAB 모달
          $fab.addEventListener('click', () => $userModal.style.display = 'block');
          $userModalClose.addEventListener('click', () => $userModal.style.display = 'none');
          $userModal.addEventListener('click', e => {
            if (e.target === $userModal) $userModal.style.display = 'none';
          });

          // 친구 추가
          $addFriendBtn.addEventListener('click', () => {
            $userModal.style.display = 'none';
            $friendModal.style.display = 'block';
          });
          
          $friendClose.addEventListener('click', () => $friendModal.style.display = 'none');
          
          $friendModal.addEventListener('click', e => { 
            if (e.target === $friendModal) $friendModal.style.display = 'none'; 
          });

          $friendConfirm.addEventListener('click', async () => {
            const me = await getMyUUID();
            const friend = $('#friend-uuid').value.trim();
            
            if (!me || !friend) { 
              alert('UUID를 입력하세요!'); 
              return; 
            }

            try {
              const response = await fetch('https://pocali-backend.onrender.com/api/friends', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ me, friend })
              });
              
              if (!response.ok) {
                return alert('등록 실패');
              }
              
              // 모든 저장소에 친구 UUID 저장
              await saveUserData('lastFriendUUID', friend);
              
              $friendModal.style.display = 'none';
              await loadFriendDeck(friend);
              alert('친구 등록 완료!');
            } catch (error) {
              console.error('친구 등록 오류:', error);
              alert('친구 등록 중 오류가 발생했습니다.');
            }
          });

          // 체크 상태 초기화
          $resetBtn.addEventListener('click', async () => {
            if (!confirm('모든 체크를 해제할까요?')) return;

            // 화면 초기화
            $$('.photo-card').forEach(img => img.classList.remove('checked'));
            
            // 데이터 초기화
            userData = {}; 
            
            // 모든 저장소에 빈 데이터 저장
            await saveUserData('userData', {});
            
            // 서버에도 빈 데이터 업로드
            const me = await getMyUUID();
            if (me) {
              await fetch(`https://pocali-backend.onrender.com/api/user/${me}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: {} })
              });
            }
            
            updateCount();
          });

          // 시트 모달 열기
          $exportBtn.addEventListener('click', () => {
            $('#user-modal').style.display = 'none';
            $('#export-modal').style.display = 'block';
          });

          // 시트 생성 함수
          function generateImageSheet(nodes) {
            // ① 오버레이 생성
            const overlay = document.createElement('div');
            overlay.id = 'sheet-overlay';
            overlay.style.cssText = `
              position:fixed; inset:0; background:#fff; overflow:auto;
              z-index:10000; padding:20px; overscroll-behavior:contain;
            `;
            document.body.appendChild(overlay);

            // ② 시트 전용 그리드
            const sheetGrid = document.createElement('div');
            sheetGrid.id = 'sheet-grid';
            sheetGrid.style.cssText = `
              display: grid;
              grid-template-columns: repeat(20, 100px);
              grid-auto-rows: auto;
              gap: 12px;
              padding: 20px;
              width: fit-content;
            `;
            overlay.appendChild(sheetGrid);

            // ③ 닫기/저장 버튼
            const btnBar = document.createElement('div');
            btnBar.style.cssText = 'position:fixed;top:10px;right:10px;display:flex;gap:8px;z-index:10001;';
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '닫기';
            closeBtn.onclick = () => overlay.remove();
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = '저장';
            saveBtn.onclick = async () => {
              try {
                // 상태 표시
                const status = document.createElement('div');
                status.textContent = "이미지 생성 중...";
                status.style.cssText = 'position:fixed; bottom:20px; left:20px; background:rgba(0,0,0,0.7); color:white; padding:10px; border-radius:5px; z-index:10002;';
                overlay.appendChild(status);
                
                // 모든 이미지가 로드될 때까지 기다림
                const images = Array.from(sheetGrid.querySelectorAll('img'));
                await Promise.all(images.map(img => {
                  // 이미 로드된 이미지는 즉시 해결
                  if (img.complete) return Promise.resolve();
                  // 아직 로드되지 않은 이미지는 로드 이벤트 기다림
                  return new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve; // 에러가 나도 진행
                  });
                }));
                
                console.log('모든 이미지 로드 완료, html2canvas 시작');
                status.textContent = "캔버스 생성 중...";
                
                const canvas = await html2canvas(sheetGrid, {
                  scale: 2,
                  backgroundColor: '#fff',
                  useCORS: true,
                  allowTaint: true,
                  logging: true, // 디버깅 정보 출력
                  onclone: (clonedDoc) => {
                    // 복제된 DOM의 모든 이미지에 crossOrigin 설정
                    const clonedImages = clonedDoc.querySelectorAll('img');
                    clonedImages.forEach(img => {
                      img.crossOrigin = 'anonymous';
                      // 불투명도는 그대로 유지
                    });
                  }
                });
                
                console.log('캔버스 크기:', canvas.width, '×', canvas.height);
                status.textContent = "이미지 다운로드 중...";
                
                // canvas를 데이터 URL로 변환하여 다운로드
                const dataURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `pocalist_sheet_${Date.now()}.png`;
                a.click();
                
                overlay.removeChild(status);
              } catch (e) {
                console.error('캡처 중 오류 발생:', e);
                alert('캡처 실패: ' + e.message);
              }
            };
            
            btnBar.append(closeBtn, saveBtn);
            overlay.appendChild(btnBar);

            // ④ 노드 복제해서 시트에 추가 (이미지 로딩 처리 개선)
            nodes.forEach(n => {
              const container = document.createElement('div');
              container.style.cssText = 'position:relative; width:100px; height:140px; display:flex; justify-content:center; align-items:center;';
              
              const img = new Image();
              img.crossOrigin = 'anonymous'; // CORS 문제 해결을 위해 필수
              img.className = 'photo-card';
              img.style.cssText = 'max-width:100%; max-height:140px; object-fit:contain;';
              
              // 체크 상태에 따라 불투명도 설정
              if (n.classList.contains('checked')) {
                img.style.opacity = '1'; // 보유 카드는 100% 불투명도
              } else {
                img.style.opacity = '0.4'; // 미보유 카드는 40% 불투명도
              }
              
              // 원본 소스와 데이터셋 복사
              img.src = n.src;
              img.alt = n.alt;
              
              // 로딩 표시기
              const loader = document.createElement('div');
              loader.textContent = '로딩중...';
              loader.style.cssText = 'position:absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:center; align-items:center; background:rgba(255,255,255,0.8);';
              container.appendChild(loader);
              
              // 이미지 로드 완료 시 로딩 표시기 제거
              img.onload = () => {
                if (loader.parentNode === container) {
                  container.removeChild(loader);
                }
              };
              
              container.appendChild(img);
              sheetGrid.appendChild(container);
            });
          }

          // 모달 전체에서 우클릭 메뉴 차단
          $('#photo-modal').addEventListener('contextmenu', e => e.preventDefault());
          
          // 모달 안 이미지에서도 우클릭 메뉴 차단
          $('#modal-image').addEventListener('contextmenu', e => e.preventDefault());

          /* X 버튼 -or- 바깥 클릭 → 모달 닫기 */
          $('#modal-close').addEventListener('click', () => $('#photo-modal').style.display = 'none');
          
          $('#photo-modal').addEventListener('click', e => {
            if (e.target === $('#photo-modal')) $('#photo-modal').style.display = 'none';
          });

          // 초기 로드
          fetchAndRenderImages()
            .then(() => {
              // 초기화가 완료된 후 내 덱 로드
              setTimeout(() => {
                loadSelfDeck();
              }, 100);
            })
            .catch(console.error);
        });

        // 페이지 로드 시 앱 초기화 (DOMContentLoaded와 별개로 window.onload에도 호출)
        window.addEventListener('load', initApp);


        // iOS/iPadOS UUID 문제 해결을 위한 기능
        (function() {
          // 포토카드 체크 감지를 위한 변수
          let hasCheckedCard = false;
          
          // UUID 안내 모달
          const uuidGuideModal = document.createElement('div');
          uuidGuideModal.className = 'modal';
          uuidGuideModal.id = 'uuid-guide-modal';
          uuidGuideModal.innerHTML = `
            // 해당 부분만 변경
              <div class="modal-content" style="max-width: 500px;">
                <span class="close">&times;</span>
                <h3>중요: 데이터 보존 안내</h3>
                <p style="margin-bottom: 15px; font-weight: bold; color: #e74c3c;">iOS/iPadOS에서는 브라우저를 종료하면 데이터가 초기화될 수 있습니다.</p>
                <p style="margin-bottom: 15px;">아래 링크를 <strong>북마크</strong>하거나 <strong>홈 화면에 추가</strong>하여 언제든 같은 UUID로 접속하세요:</p>
                
                <div style="background: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                  <div style="display: flex; align-items: center;">
                    <input id="uuid-bookmark-link" type="text" readonly style="flex: 1; padding: 8px; font-family: monospace;" />
                    <button id="copy-link-btn" style="margin-left: 10px; padding: 8px;">복사</button>
                  </div>
                </div>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                  <p><strong>홈 화면에 추가 또는 북마크에 추가:</strong></p>
                  <ol style="margin: 0 0 10px 20px;">
                    <li style="margin-bottom: 8px;"><strong>복사한링크의 주소로 재접속한 후</strong></li>
                    <li style="margin-bottom: 8px;">브라우저 <strong>상단</strong> 또는 <strong>하단</strong>의 <strong>공유 버튼</strong> <span style="display: inline-block; width: 20px; height: 20px; background: #eee; text-align: center; border-radius: 4px; line-height: 20px; vertical-align: middle;">↑</span>을 누릅니다.</li>
                    <li style="margin-bottom: 8px;"><strong>"홈 화면에 추가"</strong> 또는 <strong>"북마크"</strong> 옵션을 선택해주세요.</li>
                  </ol>
                </div>
                
                <label>
                  <input type="checkbox" id="dont-show-again" />
                  다시 보지 않기
                </label>
                <button id="uuid-guide-close" style="display: block; margin: 15px auto 0; padding: 8px 15px;">확인</button>
              </div>
            `;

          // 모달 스타일
          const style = document.createElement('style');
          style.textContent = `
            #uuid-guide-modal .modal-content {
              background-color: white;
              max-width: 550px;
              width: 90%;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            }
            #uuid-guide-modal p {
              line-height: 1.5;
              color: #333;
            }
            #uuid-guide-modal button {
              background-color: #4a90e2;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            }
            #uuid-guide-modal #uuid-bookmark-link {
              font-size: 13px;
            }
          `;
          document.head.appendChild(style);
          document.body.appendChild(uuidGuideModal);

          // UUID 북마크 링크 생성 및 모달 업데이트
          async function updateUuidGuideModal() {
            try {
              // 현재 UUID 가져오기
              let uuid = await getMyUUID();
              
              if (!uuid) return false; // UUID가 없으면 모달 표시 안함
              
              // 북마크 URL 생성 (기본 URL + uuid 파라미터)
              const baseUrl = window.location.origin + window.location.pathname;
              const finalUrl = new URL(baseUrl);
              finalUrl.searchParams.set('uuid', uuid);
              
              // 북마크 링크 필드 설정
              document.getElementById('uuid-bookmark-link').value = finalUrl.toString();
              
              // 현재 URL에 UUID 파라미터가 없으면 추가 (페이지 새로고침 없이)
              const currentUrl = new URL(window.location.href);
              if (!currentUrl.searchParams.has('uuid') && history.replaceState) {
                currentUrl.searchParams.set('uuid', uuid);
                history.replaceState(null, null, currentUrl.toString());
              }
              
              return true; // UUID가 있어 모달 표시 가능
              
            } catch (error) {
              console.error('UUID 정보 업데이트 실패:', error);
              return false;
            }
          }

          // 링크 복사 버튼
          document.getElementById('copy-link-btn')?.addEventListener('click', () => {
            const linkInput = document.getElementById('uuid-bookmark-link');
            linkInput.select();
            document.execCommand('copy');
            
            alert('UUID 링크가 클립보드에 복사되었습니다!\n\n이 링크를 북마크하거나 홈 화면에 추가하세요.');
          });

          // 닫기 버튼
          document.getElementById('uuid-guide-close')?.addEventListener('click', () => {
            document.getElementById('uuid-guide-modal').style.display = 'none';
            
            // 다시 보지 않기 옵션 저장
            if (document.getElementById('dont-show-again').checked) {
              try {
                localStorage.setItem('hideUuidGuide', 'true');
                setCookie('hideUuidGuide', 'true', 30);
              } catch (error) {
                console.error('설정 저장 실패:', error);
              }
            }
          });

          // X 버튼
          document.querySelector('#uuid-guide-modal .close')?.addEventListener('click', () => {
            document.getElementById('uuid-guide-modal').style.display = 'none';
          });

          // ================= 중요: UUID 처리 로직 개선 =================
          
          // URL에서 UUID 파라미터 가져오기
          function getUuidFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUuid = urlParams.get('uuid');
            return isValidUUID(urlUuid) ? urlUuid : null;
          }
          
          // UUID 가져오기 (우선순위: URL > 쿠키 > localStorage)
          async function getMyUUID() {
            // 1. URL에서 UUID 확인 (최우선)
            const urlUuid = getUuidFromUrl();
            if (urlUuid) {
              return urlUuid;
            }
            
            // 2. 쿠키에서 UUID 확인
            const cookieUuid = getCookie('myUUID');
            if (isValidUUID(cookieUuid)) {
              return cookieUuid;
            }
            
            // 3. localStorage에서 UUID 확인
            const localUuid = localStorage.getItem('myUUID');
            if (isValidUUID(localUuid)) {
              return localUuid;
            }
            
            return null;
          }
          
          // URL에서 UUID 확인 및 데이터 로드 (페이지 로드 시 호출)
          async function processUrlUuid() {
            try {
              const urlUuid = getUuidFromUrl();
              if (!urlUuid) return false;
              
              console.log('URL에서 UUID 발견:', urlUuid);
              
              // 로컬 저장소를 먼저 확인 (URL의 UUID가 우선)
              const urlUuidLoaded = localStorage.getItem(`uuid_loaded_${urlUuid}`);
              if (urlUuidLoaded === 'true') {
                console.log('이미 이 UUID로 로드된 적 있음. 데이터 재로드 생략');
                return true;
              }
              
              // 서버에서 데이터 로드
              try {
                console.log('서버에서 데이터 로드 시도:', urlUuid);
                const response = await fetch(`https://pocali-backend.onrender.com/api/user/${urlUuid}`);
                
                if (!response.ok) {
                  console.error('서버 데이터 로드 실패:', await response.text());
                  return false;
                }
                
                const data = await response.json();
                console.log('서버 데이터 로드 성공:', data);
                
                // 기존 UUID 백업
                const oldUuid = localStorage.getItem('myUUID');
                if (oldUuid) {
                  localStorage.setItem('previous_uuid', oldUuid);
                  console.log('기존 UUID 백업:', oldUuid);
                }
                
                // 새 UUID와 데이터 저장
                localStorage.setItem('myUUID', urlUuid);
                setCookie('myUUID', urlUuid, 30);
                
                // userData 저장
                const userData = typeof data.data === 'string' ? data.data : JSON.stringify(data.data || {});
                localStorage.setItem('userData', userData);
                setCookie('userData', userData, 30);
                
                // 로드 완료 표시
                localStorage.setItem(`uuid_loaded_${urlUuid}`, 'true');
                
                console.log('새 UUID 적용 완료:', urlUuid);
                
                // UUID 변경 후 즉시 페이지 갱신 (주소는 그대로 유지)
                window.location.reload();
                return true;
              } catch (error) {
                console.error('URL UUID 처리 중 오류:', error);
                return false;
              }
            } catch (error) {
              console.error('URL 파라미터 처리 오류:', error);
              return false;
            }
          }

          // 첫 포토카드 체크 시 UUID 가이드 모달 표시
          function setupCardCheckListener() {
            // iOS 기기인지 확인
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (!isIOS) return; // iOS 기기가 아니면 리스너 설정 안함
            
            // URL에 UUID가 이미 있는지 확인
            const urlHasUuid = getUuidFromUrl() !== null;
            if (urlHasUuid) return; // URL에 UUID가 있으면 리스너 설정 안함
            
            // 원본 toggleCheck 함수 참조 저장
            const originalToggleCheck = window.toggleCheck;
            
            if (typeof originalToggleCheck === 'function') {
              // toggleCheck 함수가 정의되어 있는 경우
              window.toggleCheck = async function(img) {
                // 원래 함수 호출
                originalToggleCheck.apply(this, arguments);
                
                // 첫 체크 감지
                if (!hasCheckedCard) {
                  hasCheckedCard = true;
                  
                  // 다시 보지 않기 설정 확인
                  const hideGuide = localStorage.getItem('hideUuidGuide') || getCookie('hideUuidGuide');
                  if (hideGuide === 'true') return;
                  
                  // 모달 표시 (약간의 지연 후)
                  setTimeout(async () => {
                    if (await updateUuidGuideModal()) {
                      document.getElementById('uuid-guide-modal').style.display = 'block';
                    }
                  }, 500);
                }
              };
            } else {
              // toggleCheck 함수를 찾을 수 없는 경우, 클릭 이벤트 감시
              document.addEventListener('click', async function(e) {
                // 포토카드 클릭 감지
                if (e.target && e.target.classList && e.target.classList.contains('photo-card')) {
                  if (!hasCheckedCard) {
                    hasCheckedCard = true;
                    
                    // 다시 보지 않기 설정 확인
                    const hideGuide = localStorage.getItem('hideUuidGuide') || getCookie('hideUuidGuide');
                    if (hideGuide === 'true') return;
                    
                    // 모달 표시 (약간의 지연 후)
                    setTimeout(async () => {
                      if (await updateUuidGuideModal()) {
                        document.getElementById('uuid-guide-modal').style.display = 'block';
                      }
                    }, 1000);
                  }
                }
              });
            }
          }

          // 페이지 로드 시 실행
          window.addEventListener('load', async () => {
            console.log('POCALIST UUID 헬퍼 로드됨');
            
            // URL UUID 먼저 처리 (최우선)
            const urlProcessed = await processUrlUuid();
            
            // URL에 UUID가 없거나 처리되지 않은 경우에만 카드 체크 리스너 설정
            if (!urlProcessed) {
              setupCardCheckListener();
            }
          });

          // '유저 데이터 불러오기' 버튼에 이벤트 핸들러 추가
          document.getElementById('load-user-data')?.addEventListener('click', async () => {
            // iOS 기기 감지
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
              // '유저 데이터 불러오기' 모달이 닫히면 UUID 안내 모달 표시
              const userDataModal = document.getElementById('user-data-modal');
              
              // 기존 이벤트 리스너는 유지하면서 새 이벤트 리스너 추가
              const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                  if (mutation.attributeName === 'style' && 
                      userDataModal.style.display === 'none') {
                    
                    // 다시 보지 않기 설정 확인
                    const hideGuide = localStorage.getItem('hideUuidGuide') || getCookie('hideUuidGuide');
                    if (hideGuide === 'true') return;
                    
                    // URL에 UUID가 없는 경우에만 모달 표시
                    setTimeout(async () => {
                      const urlHasUuid = getUuidFromUrl() !== null;
                      if (!urlHasUuid && await updateUuidGuideModal()) {
                        document.getElementById('uuid-guide-modal').style.display = 'block';
                      }
                    }, 500);
                    
                    // 한 번만 실행하고 Observer 제거
                    observer.disconnect();
                  }
                });
              });
              
              // userDataModal의 style 속성 변화 감시 시작
              observer.observe(userDataModal, { attributes: true });
            }
          });

          // 원래의 validateUserID 함수를 오버라이드하여 URL UUID 처리 개선
          const originalValidateUserID = window.validateUserID;
          
          if (typeof originalValidateUserID === 'function') {
            window.validateUserID = async function() {
              // URL에서 UUID 확인 (최우선)
              const urlUuid = getUuidFromUrl();
              
              if (urlUuid) {
                console.log('validateUserID: URL에서 UUID 사용:', urlUuid);
                
                // localStorage와 쿠키에 URL UUID 저장
                localStorage.setItem('myUUID', urlUuid);
                setCookie('myUUID', urlUuid, 30);
                
                // 서버에서 데이터 확인
                try {
                  const resp = await fetch(`https://pocali-backend.onrender.com/api/user/${urlUuid}`);
                  if (resp.ok) {
                    const data = await resp.json();
                    if (data.data) {
                      const userData = typeof data.data === 'string' ? data.data : JSON.stringify(data.data || {});
                      localStorage.setItem('userData', userData);
                      setCookie('userData', userData, 30);
                    }
                  }
                } catch (error) {
                  console.error('URL UUID 데이터 로드 실패:', error);
                }
                
                return urlUuid;
              }
              
              // URL에 UUID가 없으면 원래 함수 호출
              return await originalValidateUserID.apply(this, arguments);
            };
          }
          
          // 원래의 ensureMyUUID 함수를 오버라이드하여 URL UUID 처리 개선
          const originalEnsureMyUUID = window.ensureMyUUID;
          
          if (typeof originalEnsureMyUUID === 'function') {
            window.ensureMyUUID = async function() {
              // URL에서 UUID 확인 (최우선)
              const urlUuid = getUuidFromUrl();
              
              if (urlUuid) {
                console.log('ensureMyUUID: URL에서 UUID 사용:', urlUuid);
                return urlUuid;
              }
              
              // URL에 UUID가 없으면 원래 함수 호출
              return await originalEnsureMyUUID.apply(this, arguments);
            };
          }
        })();
      </script>
               
      </body>
      </html>