<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>pocalist</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
        <!-- 상단 검색창 & 카운터 -->
        <header id="search-header">
          <input type="text" id="search-input" placeholder="포토카드 검색..." />
          <button id="search-detail-btn">+</button>
          <div id="count-display" style="text-align:center; font-weight:bold; margin-top: 5px;">
            0 / 0
          </div>
          <button id="view-toggle">👥 친구보기</button>  <!-- ← 새 버튼 -->
        </header>
  <!-- 카드 그리드 -->        
	<div id="photo-grid">  
    </div>
    <!-- 카드 상세 모달 -->
    <div id="photo-modal" class="modal" style="display: none;">
     <div class="modal-content">
      <span id="modal-close" class="close">&times;</span>
      <img id="modal-image" src="" alt="확대된 포토카드" draggable="false" />
      <div id="modal-info">
        <!-- 파일명 파싱 등으로 추후 상세 정보를 표시할 예정 -->
        </div>
      </div>
    </div>
    <!-- 유저 데이터 모달 -->
   <div id="user-data-modal" class="modal" style="display: none;">
   <div class="modal-content">
    <span id="user-data-modal-close" class="close">&times;</span>
    <h3>UUID 데이터 관리</h3>

    <!-- 내 UUID 영역 -->
    <label for="my-uuid">내 UUID:</label>
    <input type="text" id="my-uuid" readonly style="width: 100%;" />

    <!-- 다른 기기의 UUID 입력 영역 -->
    <label for="other-uuid">다른 기기의 UUID 불러오기:</label>
    <input type="text" id="other-uuid" placeholder="다른 디바이스의 UUID 입력" style="width: 100%;" />
    <button id="load-other-data">데이터 불러오기</button>

    <!-- 메시지 또는 에러 표시 -->
    <div id="uuid-msg" style="margin-top: 10px; color: red;"></div>
    </div>
   </div>

         <!-- 상세 검색 모달 -->
        <div id="detail-search-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="detail-search-modal-close" class="close">&times;</span>
            <h3>상세 검색 옵션</h3>
            <form id="detail-search-form">
                <fieldset>
                <legend>그룹</legend>
                <label>
                    <input type="checkbox" name="group" value="IVE" />
                    아이브
                </label>
                <label>
                    <input type="checkbox" name="group" value="IZONE" />
                    아이즈원
                </label>
                </fieldset>
                <fieldset>
                <legend>멤버</legend>
                <label>
                    <input type="checkbox" name="member" value="유진" />
                    유진
                </label>
                <label>
                    <input type="checkbox" name="member" value="가을" />
                    가을
                </label>
                <label>
                    <input type="checkbox" name="member" value="레이" />
                    레이
                </label>
                <label>
                    <input type="checkbox" name="member" value="원영" />
                    원영
                </label>
                <label>
                    <input type="checkbox" name="member" value="리즈" />
                    리즈
                </label>
                <label>
                    <input type="checkbox" name="member" value="이서" />
                    이서
                </label>
                </fieldset>
                <fieldset>
                <legend>텍스트 검색</legend>
                <input type="text" id="filter-text" name="filter-text" placeholder="검색어 입력" />
                </fieldset>
                <button type="submit">검색</button>
            </form>
            </div>
        </div>
        <!-- 이미지 시트 출력 모달 -->
        <div id="export-modal" class="modal" style="display: none;">
          <div class="modal-content">
              <span id="export-modal-close" class="close">&times;</span>
              <h3>포토카드 시트 출력</h3>
              <form id="export-form">
                  <fieldset>
                      <legend>그룹 선택</legend>
                      <label><input type="radio" name="group" value="IVE" checked> 아이브</label>
                      <label><input type="radio" name="group" value="IZONE"> 아이즈원</label>
                  </fieldset>
                  <fieldset>
                      <legend>멤버 선택</legend>
                      <label><input type="checkbox" name="member" value="유진"> 유진</label>
                      <label><input type="checkbox" name="member" value="가을"> 가을</label>
                      <label><input type="checkbox" name="member" value="레이"> 레이</label>
                      <label><input type="checkbox" name="member" value="원영"> 원영</label>
                      <label><input type="checkbox" name="member" value="리즈"> 리즈</label>
                      <label><input type="checkbox" name="member" value="이서"> 이서</label>
                  </fieldset>
                  <button type="submit">시트 생성</button>
              </form>
          </div>
        </div>
          <!-- 친구 UUID 입력 모달 -->
         <div id="friend-modal" class="modal"><div class="modal-content">
          <span id="friend-modal-close" class="close">&times;</span>
          <h3>친구 UUID 입력</h3>
          <input id="friend-uuid" placeholder="친구 UUID" style="width:100%">
          <button id="friend-add-confirm">추가</button></div></div>

	<!-- 하단 우측 FAB 버튼 -->
        <button
        id="categoryToggleBtn"
        class="floating-btn left"
        title="카테고리별 보기"
      >🏷️</button>
        <button id="fab">+</button>
        <!-- FAB 모달: 유저 데이터/관리자 메뉴 -->
        <div id="user-modal" class="modal" style="display: none;">
            <div class="modal-content">
            <span id="user-modal-close" class="close">&times;</span>
            <h3>유저 데이터 및 관리자 메뉴</h3>
            <ul>
                <li><button id="load-user-data">유저 데이터 불러오기</button></li>
                <li><button id="reset-checks">체크 상태 초기화</button></li>
                <li><button id="export-sheet">이미지 시트 출력</button></li>
                <li><button id="add-friend">친구 추가</button></li>
            </ul>
            </div>
        </div>
       <!-- ✅ html2canvas 등 외부 라이브러리 로드 -->
        
        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, get, onValue }
          from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

          let originalCards = [], photoCards = [];
          const advancedFilters = { groups: [], members: [] };

          // ── Firebase 셋업 ─────────────────────────────────
          const firebaseConfig = {
            apiKey: "AIzaSyADRbVXqHqvIW35jyk4NAtt8i4sXTHDFBc",
            authDomain: "pocali.firebaseapp.com",
            databaseURL: "https://pocali-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pocali",
            storageBucket: "pocali.firebasestorage.app",
            messagingSenderId: "460319369852",
            appId: "1:460319369852:web:239f87cc192f4fa392b7f9",
            measurementId: "G-66W2DWXB68"
         };
            const app = initializeApp(firebaseConfig);
            const db  = getDatabase(app);

            // ── 전역 상태 & 도우미 ───────────────────────────────
            const BATCH_SIZE      = 100;
            let allImages         = [];
            let currentBatch      = 0;
            let isRendering       = false;
            let totalCount        = 0;
            let currentView       = 'id';
            let viewOwner         = 'self';
            let currentFriendUUID = localStorage.getItem('lastFriendUUID') || null;
            let userData = {}; 

             function $(sel, scope=document) {
               return scope.querySelector(sel);
             }
             function $$(sel, scope=document) {
               return Array.from(scope.querySelectorAll(sel));
             }
            // ── UUID & Firebase 동기화 함수 ─────────────────────
              function ensureMyUUID() {
                let uid = localStorage.getItem('myUUID');
                if (!uid) {
                  uid = crypto.randomUUID();
                  localStorage.setItem('myUUID', uid);
                  syncLocalDataToServer();
                }
                return uid;
              }
              async function syncLocalDataToServer() {
                const uid  = ensureMyUUID();
                const data = JSON.parse(localStorage.getItem('userData')||'{}');
                await set(ref(db, `users/${uid}/cards`), data);
              }
              async function loadFriendDeck(uuid) {
                const snap    = await get(ref(db, `users/${uuid}/cards`));
                const friendData = snap.exists() ? snap.val() : {};
                applyFriendData(friendData);
                viewOwner         = 'friend';
                currentFriendUUID = uuid;
                localStorage.setItem('lastFriendUUID', uuid);
                $('#view-toggle').textContent = '👤 내 카드보기';
              }
              function subscribeFriendData(uuid) {
                return onValue(ref(db, `users/${uuid}/cards`), snap => {
                  applyFriendData(snap.val()||{});
                });
              }


              // ── applyFriendData (친구 보유 체크만 렌더) ───────────
              function applyFriendData(data) {
                photoCards.forEach(img => {
                  img.classList.toggle('checked', !!data[img.dataset.unique]);
                  img.style.pointerEvents = 'none';
                });
              }

              // ── DOMContentLoaded 이후 초기화 ─────────────────────
              document.addEventListener('DOMContentLoaded', async () => {
                const LONG_PRESS    = 500;
                const TAP_THRESHOLD = 200;

                const $grid          = $('#photo-grid');
                const $searchInput   = $('#search-input');
                const $catToggleBtn  = $('#categoryToggleBtn');
                const $viewToggleBtn = $('#view-toggle');
                const $loadOtherBtn  = $('#load-other-data');
                
                function toggleCheck(img) {
                  img.classList.toggle('checked');
                  const data = JSON.parse(localStorage.getItem('userData')||'{}');
                  data[img.dataset.unique] = img.classList.contains('checked');
                  localStorage.setItem('userData', JSON.stringify(data));
                  syncLocalDataToServer();
                  updateCount();
                }

                  const $myUuidInput = document.getElementById('my-uuid');
                  $myUuidInput.value = ensureMyUUID();


                // ── 메인 렌더링/페이징 함수 정의 ─────────────────────
                async function fetchAndRenderImages() {
                  // (1) 전체 메타데이터 → allImages
                  const resp      = await fetch('https://pocali-backend.onrender.com/api/images');
                  allImages       = await resp.json();
                  totalCount      = allImages.length;
                  currentBatch    = 0;
                  $grid.innerHTML = '';
                  renderNextBatch();
                }
                  // ── ➊ 상세정보 모달 열기 함수 ─────────────────────────
                  function showModal(img) { … }
                
                function renderNextBatch() {
                  if (isRendering) return;
                  isRendering = true;
                  const start = currentBatch * BATCH_SIZE;
                  const slice = allImages.slice(start, start + BATCH_SIZE);
                  if (!slice.length) { isRendering=false; return; }
                  slice.forEach(image => {
                    const container = document.createElement('div');
                    container.className = 'photo-card-container';
                    const img = document.createElement('img');
                    img.className       = 'photo-card';
                    img.src             = image.url;
                    img.dataset.unique  = image.unique_id;
                    // 로컬 체크 복원
                    if (JSON.parse(localStorage.getItem('userData')||'{}')[image.unique_id]) {
                      img.classList.add('checked');
                    }
                    // 오버레이
                    const ov = document.createElement('div');
                    ov.className   = 'image-overlay';
                    ov.textContent = image.type||image.file_type||'';
                    container.append(ov, img);
                    // 이벤트 바인딩
                    img.addEventListener('dblclick', ()=> viewOwner==='self' && toggleCheck(img));
                    let startT, timer;
                    img.addEventListener('pointerdown', () => {
                      startT = performance.now();
                      timer  = setTimeout(()=>showModal(img), LONG_PRESS);
                    });
                    img.addEventListener('pointerup', e=>{
                      clearTimeout(timer);
                      if (performance.now()-startT < TAP_THRESHOLD) toggleCheck(img);
                    });
                    img.addEventListener('pointerleave', ()=>clearTimeout(timer));
                    container.appendChild(img);
                    $grid.appendChild(container);
                  });
                  originalCards = Array.from($grid.querySelectorAll('.photo-card-container'));
                  photoCards    = Array.from($grid.querySelectorAll('.photo-card'));
                  currentBatch++;
                  updateCount();
                  applyFilters();
                  isRendering = false;
                }



                window.addEventListener('scroll', ()=>{
                  if (window.scrollY+window.innerHeight >= document.documentElement.scrollHeight-50) {
                    renderNextBatch();
                  }
                });
          
            /* ─────────────────────────────────────────────
               2. 공통 유틸
               ───────────────────────────────────────────── */
            /** 현재 화면의 총 카드수 / 보유카드수 표시 */
            function updateCount () {
              // “보유됨”은 로컬 userData 에 true인 것의 개수
              const data = JSON.parse(localStorage.getItem('userData') || '{}');
              const have = Object.values(data).filter(v => v).length;
              // “전체”는 헤더에서 읽은 totalCount
              document.getElementById('count-display').textContent = `${have} / ${totalCount}`;
            }

               // ── (추가) 내 체크 데이터 Firebase에서 복원 ─────────────────
                async function loadUserData() {
                const uid = ensureMyUUID();                        // 기존 함수
                const snap = await get(ref(db, `users/${uid}/cards`));
                if (snap.exists()) {
                  const data = snap.val();
                  localStorage.setItem('userData', JSON.stringify(data));
                  // 화면 갱신
                  updateCount();
                  if (currentView === 'category') showByCategory();
                  else showById();
                  loadSelfDeck();
                }
              }

          
            /** 카드 리스트를 그리드에 그대로 렌더링 */
            function render(cards) {
              $grid.innerHTML = '';
              cards.forEach(c => $grid.appendChild(c));
              updateCount();
            }
          
            /* ─────────────────────────────────────────────
               3. 뷰 그리기(정렬) 함수
               ───────────────────────────────────────────── */
            /** 고유번호(ID) 내림차순 정렬 뷰 */
            function showById(list = null) {
              const cards = (list ?? originalCards).slice();   // 복사본
              cards.sort((a, b) => {
                // 각 div(photo-card-container) 안에서 .photo-card img를 찾습니다
                const imgA = a.querySelector('.photo-card');
                const imgB = b.querySelector('.photo-card');
                return Number(imgB.dataset.unique) - Number(imgA.dataset.unique);
              });
              render(cards);
            }

            /** 카테고리별 그룹 + 제목 + 버전 헤더 뷰 */
            function showByCategory() {
              const q = $searchInput.value.toLowerCase();

            // 1) 필터링
            const filtered = originalCards.filter(div => {
              const img = div.querySelector('.photo-card');
              if (!img) return false;
              const alt    = img.alt.toLowerCase();
              const grp    = img.dataset.group.toLowerCase();
              const mem    = img.dataset.member.toLowerCase();
              const textOK = !q || alt.includes(q);
              const grpOK  = !advancedFilters.groups.length ||
                            advancedFilters.groups.includes(grp.toUpperCase());
              const memOK  = !advancedFilters.members.length ||
                            advancedFilters.members.some(v => mem.includes(v.toLowerCase()));
              return textOK && grpOK && memOK;
            });

            // 2) 그룹핑
            const buckets = {};
            filtered.forEach(div => {
              const img = div.querySelector('.photo-card');
              const key = [ img.dataset.category||'미분류',
                            img.dataset.title, img.dataset.version ]
                          .filter(Boolean).join(' | ');
              (buckets[key] = buckets[key] || []).push(div);
            });

            $grid.innerHTML = '';
              Object.entries(buckets)
                .sort(([,cardsA],[,cardsB]) => {
                  const aImg = cardsA[0].querySelector('.photo-card');
                  const bImg = cardsB[0].querySelector('.photo-card');
                  return Number(bImg.dataset.unique) - Number(aImg.dataset.unique);
                })
                .forEach(([hdr,cards]) => {
                  const h2 = document.createElement('h2');
                  h2.textContent = hdr; $grid.appendChild(h2);
                  cards.sort((a,b) => {
                    const aImg = a.querySelector('.photo-card');
                    const bImg = b.querySelector('.photo-card');
                    return Number(bImg.dataset.unique) - Number(aImg.dataset.unique);
                  }).forEach(d => $grid.appendChild(d));
                });

              updateCount();
            }


          
            /** 현재 필터/뷰 상태로 다시 그리기 */
            function applyFilters () {
                /* ② 공통 필터(검색어 + 상세조건) 한 번만 계산 */
              const query = ($searchInput.value || '').toLowerCase();

               const filtered = originalCards.filter(div => {
                // div 내부에서 .photo-card 찾기
                const img    = div.querySelector('.photo-card');
                const alt    = img.alt.toLowerCase();
                const group  = img.dataset.group.toLowerCase();
                const member = img.dataset.member.toLowerCase();

                const textOK   = !query || alt.includes(query);
                const groupOK  = !advancedFilters.groups.length ||
                                advancedFilters.groups.includes(group.toUpperCase());
                const memberOK = !advancedFilters.members.length ||
                                advancedFilters.members.some(v => member.includes(v.toLowerCase()));

                return textOK && groupOK && memberOK;
              });
              function applyFilters() {
              // …필터 배열 계산…
              if (currentView === 'category') {
                showByCategory();
              } else {
                showById(filtered);
              }
            }

            
          
            /* ─────────────────────────────────────────────
               4. 덱 전환 (loadSelfDeck / loadFriendDeck)
               ───────────────────────────────────────────── */
            /** 내 보유 카드 표시 */
            function loadSelfDeck () {
              const myData = JSON.parse(localStorage.getItem('userData') || '{}');
              userData    = myData;                 // ← 전역 변수도 업데이트
              photoCards.forEach(img => {
                img.classList.toggle('checked', !!myData[img.dataset.unique]);
                img.style.pointerEvents = '';        // 더블클릭 허용
              });
          
              viewOwner   = 'self';
              $viewToggleBtn.textContent = '👥 친구보기';
              updateCount();
            }
          
            /** 친구 보유 카드 표시 */
            
          
            /* 전역(콘솔)에서도 호출할 수 있도록 */
            window.loadSelfDeck   = loadSelfDeck;
            window.loadFriendDeck = loadFriendDeck;
          
                       
          
            /* 5-2. “친구보기 ↔ 내카드보기” 토글 버튼 */
            $viewToggleBtn.addEventListener('click', () => {
              if (viewOwner === 'friend') loadSelfDeck();
              else if (currentFriendUUID) loadFriendDeck(currentFriendUUID);
              else alert('먼저 친구를 추가하세요!');
            });
          
            /* 5-3. 좌측 하단 카테고리/ID 전환 버튼 */
            $catToggleBtn.addEventListener('click', () => {
              currentView = currentView === 'id' ? 'category' : 'id';
              $catToggleBtn.textContent = currentView === 'id' ? '🏷️' : '🔢';
              $catToggleBtn.title       = currentView === 'id'
                                        ? '카테고리별 보기'
                                        : '고유번호 순 보기';
              applyFilters();
            });
          
            /* 5-4. 상단 검색 입력 */
            $searchInput.addEventListener('input', applyFilters);
          
            /* ─────────────────────────────────────────────
               6. 초기 랜더링
               ───────────────────────────────────────────── */
            showById();          // 기본 정렬
            loadSelfDeck();       // ✅ 보유표시도 함께!
            updateCount();       // 카운터 초기화
          
            /* ── 5-A. 우측 FAB & 모달 보조 기능 ─────────────────────────── */
            const $fab           = $('#fab');
            const $userModal     = $('#user-modal');
            const $userModalClose= $('#user-modal-close');
            
            const $addFriendBtn  = $('#add-friend');
            const $friendModal   = $('#friend-modal');
            const $friendClose   = $('#friend-modal-close');
            const $friendConfirm = $('#friend-add-confirm');

            const $resetBtn      = $('#reset-checks');
            const $exportBtn     = $('#export-sheet');     // (시트 모달 열기만)

            const $userDataModal      = $('#user-data-modal');
            const $userDataModalClose = $('#user-data-modal-close');

            $userDataModalClose.addEventListener('click', () => $userDataModal.style.display = 'none');
            $userDataModal.addEventListener('click',  e => {      // 바깥 영역 클릭 시에도 닫힘
              if (e.target === $userDataModal) $userDataModal.style.display = 'none';
            });


            
            // ── “다른 UUID 불러오기” 교체 핸들러 ─────────────────
            $loadOtherBtn.addEventListener('click', ()=> {
              const other = $('#other-uuid').value.trim();
              if (!other) return alert('UUID를 입력하세요!');
              // 친구 실시간 구독 + 그리기
              subscribeFriendData(other);
              loadFriendDeck(other);
            });

              /* ── 체크 상태 초기화 (Reset) ───────────────── */
              const $resetBtn = document.getElementById('reset-checks');
              $resetBtn.addEventListener('click', async () => {
                if (!confirm('모든 체크를 해제할까요?')) return;

                // 1) UI에서 체크 표시 모두 제거
                photoCards.forEach(img => img.classList.remove('checked'));

                // 2) 로컬 스토리지 비우기
                localStorage.removeItem('userData');

                // 3) Firebase에도 빈 객체로 덮어쓰기
                const uid = ensureMyUUID();
                await set(ref(db, `users/${uid}/cards`), {});

                // 4) 카운터 업데이트
                updateCount();
              });




             // ── “내 UUID 불러오기” 버튼 핸들러 복원
             document.getElementById('load-user-data')
               .addEventListener('click', () => {
                 const uid = ensureMyUUID();
                 document.getElementById('my-uuid').value = uid;
                 document.getElementById('user-data-modal').style.display = 'block';
                 document.getElementById('uuid-msg').textContent = '';
               });



            /* ① FAB 눌러 → ‘유저 설정’ 모달 */
            $fab.addEventListener('click', () => $userModal.style.display = 'block');
            $userModalClose.addEventListener('click', () => $userModal.style.display = 'none');
            $userModal.addEventListener('click', e => {
              if (e.target === $userModal) $userModal.style.display = 'none';
            });

            /* ② 친구 추가 – UUID 입력 모달 */
            $addFriendBtn.addEventListener('click', () => {
              $userModal.style.display = 'none';
              $friendModal.style.display = 'block';
            });
            $friendClose.addEventListener('click', () => $friendModal.style.display = 'none');
            $friendModal.addEventListener('click', e => { if (e.target === $friendModal) $friendModal.style.display = 'none'; });


            /* ④ 시트(프린트) 모달 열기 */
            $exportBtn.addEventListener('click', () => {
              $('#user-modal').style.display = 'none';
              $('#export-modal').style.display = 'block';
            });
            /* ── 5-B. “시트 생성” (export-modal) 기능 복구 ────────────────── */
            const $exportModal = $('#export-modal');
            const $exportClose = $('#export-modal-close');
            const $exportForm  = $('#export-form');

            /* ① ‘+’(폴더) 메뉴에서 “포토카드 시트 출력” 눌렀을 때 이미 열리도록
                → 이 부분은 5-A 스니펫에 넣은 $exportBtn 클릭에서 처리됨           */

            /* ② 모달 X 버튼 */
            $exportClose.addEventListener('click', () => $exportModal.style.display = 'none');

            /* ③ 라디오/체크박스 선택 후  “시트 생성” 제출 */
            $exportForm.addEventListener('submit', e => {
              e.preventDefault();
              const fd      = new FormData($exportForm);
              const group   = fd.get('group');           // 라디오 (반드시 1개)
              const members = fd.getAll('member');       // 체크박스 (0~여러 개)

              if (!members.length) { alert('멤버를 하나 이상 선택하세요!'); return; }

              const selCards = $$('.photo-card').filter(img =>
                  img.dataset.group === group &&
                  members.includes(img.dataset.member)
              );

              if (!selCards.length) { alert('해당 조건의 카드가 없습니다.'); return; }

              $exportModal.style.display = 'none';
              generateImageSheet(selCards);
            });

            // ➊ 상세 검색 모달 열기/닫기
              const searchDetailBtn         = document.getElementById('search-detail-btn');
              const detailSearchModal       = document.getElementById('detail-search-modal');
              const detailSearchModalClose  = document.getElementById('detail-search-modal-close');

              searchDetailBtn.addEventListener('click', () => {
                detailSearchModal.style.display = 'block';
              });
              detailSearchModalClose.addEventListener('click', () => {
                detailSearchModal.style.display = 'none';
              });
              detailSearchModal.addEventListener('click', e => {
                if (e.target === detailSearchModal) detailSearchModal.style.display = 'none';
              });
             
            /* ④ 시트 → 이미지 다운로드용 헬퍼  */
            function generateImageSheet(cards) {
              /* 4-1. 전체 오버레이 */
              const overlay = document.createElement('div');
              overlay.style.cssText = `
                position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:9999;
                display:flex; flex-direction:column; align-items:center; overflow:auto;
              `;

              /* 4-2. 그리드 */
              const grid = document.createElement('div');
              grid.style.cssText = `
                display:grid;
                grid-template-columns:repeat(16, 1fr);  /* ← 16칸 한 줄 */
                gap:8px; padding:24px; max-width:100%;
                overflow-x:auto;                        /* 넘치면 가로 스크롤 */
              `;
              overlay.appendChild(grid);

              /* 4-3. 카드 삽입 (불투명도 = 보유 여부) */
              cards.forEach(img => {
                const clone = img.cloneNode();
                clone.style.width  = '100%';
                clone.style.opacity= img.classList.contains('checked') ? '1' : '0.4';
                grid.appendChild(clone);
              });

              /* 4-4. 버튼들 */
              const btnBar = document.createElement('div');
              btnBar.style.cssText = `position:fixed; top:20px; right:20px; display:flex; gap:8px;`;
              overlay.appendChild(btnBar);

              const close = document.createElement('button');
              close.textContent = '닫기';
              close.style.cssText = `padding:8px 14px; background:#f44336; color:#fff; border:none;`;
              close.onclick = () => document.body.removeChild(overlay);

              const save  = document.createElement('button');
              save.textContent = '이미지 저장';
              save.style.cssText = `padding:8px 14px; background:#4CAF50; color:#fff; border:none;`;
              save.onclick  = () => downloadAsImage(grid);

              btnBar.append(close, save);

              document.body.appendChild(overlay);
            }

            /* ⑤ html2canvas 래퍼 */
            function downloadAsImage(target) {
              const loader = document.createElement('div');
              loader.textContent = '이미지 생성 중…';
              loader.style.cssText = `
                position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
                background:rgba(0,0,0,.6); color:#fff; font-size:1.2rem; z-index:10000;
              `;
              document.body.appendChild(loader);

              html2canvas(target, {scale:2}).then(canvas => {
                const link = document.createElement('a');
                link.download = `pocalist_sheet_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(loader);
              }).catch(err => {
                alert('저장 실패: ' + err.message);
                document.body.removeChild(loader);
              });
            }
            // ── ➊ 상세정보 모달 열기 함수 ─────────────────────────
            function showModal(img) {
              const modal     = document.getElementById('photo-modal');
              const modalImg  = document.getElementById('modal-image');
              const modalInfo = document.getElementById('modal-info');

              modalImg.src = img.src;
              modalInfo.innerHTML = `
                <p>${img.dataset.group   || ''}</p>
                <p>${img.dataset.member  || ''}</p>
                <p>${img.dataset.category || ''} ${img.dataset.title || ''}</p>
                <p>${img.dataset.version || ''}</p>
                <p>#${img.dataset.unique}</p>
              `;
              modal.style.display = 'block';
            }
            // 모달 닫기 핸들러(기존 X 버튼 / 바깥 클릭)
            document.getElementById('modal-close').addEventListener('click', () => {
              document.getElementById('photo-modal').style.display = 'none';
            });
            document.getElementById('photo-modal').addEventListener('click', e => {
              if (e.target === document.getElementById('photo-modal')) {
                document.getElementById('photo-modal').style.display = 'none';
              }
            });


            // ─── 페이징별 렌더링 함수 ─────────────────────────
             function renderNextBatch() {
            if (isRendering) return;
            isRendering = true;

            const start = currentBatch * BATCH_SIZE;
            const end   = start + BATCH_SIZE;
            const slice = allImages.slice(start, end);

            slice.forEach(image => {
              // 1) 카드 컨테이너 생성
              const container = document.createElement('div');
              container.className = 'photo-card-container';

              // 2) <img> 요소 생성
              const img = document.createElement('img');
              img.className       = 'photo-card';
              img.src             = image.url.startsWith('http')
                                    ? image.url
                                    : `https://pocali-backend.onrender.com${image.url}`;
              img.loading         = 'lazy';
              img.alt             = `${image.group} ${image.member} ${image.category} ${image.title} #${image.unique_id}`;
              img.dataset.group   = image.group;
              img.dataset.member  = image.member;
              img.dataset.category= image.category;
              img.dataset.title   = image.title;
              img.dataset.version = image.version;
              img.dataset.unique  = image.unique_id;

              // ── 로컬 저장소(userData)에 있던 체크 정보 재적용
              const saved = JSON.parse(localStorage.getItem('userData') || '{}');
              if (saved[image.unique_id]) {
                img.classList.add('checked');
              }


              // 3) 오버레이: image.type 또는 백엔드 file_type 활용
              const overlay = document.createElement('div');
              overlay.className   = 'image-overlay';
              overlay.textContent = image.type || image.file_type || '';
              container.appendChild(overlay);

              // 4) 터치·롱프레스 & 더블클릭 이벤트 바인딩
              let startTime, pressTimer;
              img.addEventListener('pointerdown', e => {
                if (viewOwner !== 'self') return;
                startTime = performance.now();
                pressTimer = setTimeout(() => showModal(img), LONG_PRESS);
              });
              img.addEventListener('pointerup', e => {
                clearTimeout(pressTimer);
                if (performance.now() - startTime < TAP_THRESHOLD) {
                  toggleCheck(img);
                }
              });
              img.addEventListener('pointerleave', () => clearTimeout(pressTimer));
              img.addEventListener('dblclick', () => {
                if (viewOwner !== 'self') return;
                toggleCheck(img);
              });
              img.addEventListener('contextmenu', e => {
                e.preventDefault();
                showModal(img);
              });

              // 5) 그리드에 추가
              container.appendChild(img);
              $grid.appendChild(container);
            });
              // — 캐시 갱신
            originalCards = Array.from($grid.querySelectorAll('.photo-card-container'));
            photoCards    = Array.from($grid.querySelectorAll('.photo-card'));

            // — 상태 갱신
            if (currentBatch === 0) {
              totalCount = allImages.length;
            }
            currentBatch++;
            updateCount();

            // — 현재 뷰(ID/카테고리)에 맞춰 재렌더
            applyFilters();

            isRendering = false; 
          }
          
            // ─── 무한 스크롤 트리거 ─────────────────────────
            window.addEventListener('scroll', () => {
              const nearBottom = window.innerHeight + window.scrollY
                               >= document.body.offsetHeight - 200;
              if (nearBottom && currentBatch * BATCH_SIZE < allImages.length) {
                renderNextBatch();
              }
            });
         
              
          
         // ── 초기화 흐름 ──────────────────────────────────────
            ensureMyUUID();
            await loadUserData();           // ← 콜백 내부에서만 호출
            fetchAndRenderImages();

        });
        
      </script>
               
      </body>
      </html>